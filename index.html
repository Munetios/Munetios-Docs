<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="image.png" type="image/x-icon">
    <title>97529 office (Early Preview)</title>
    <meta name="description" content="97529 office: All-in-one platform for Docs, Presentations, Worksheets, and Journal. Modern, fast, and easy to use.">
    <meta name="keywords" content="Munetios, Docs, Present, Worksheets, Journal, Productivity, Suite, Online Documents">
    <meta name="author" content="Munetios">
    <meta name="publisher" content="Munetios">
    <meta name="copyright" content="Munetios Technologies™️ © 2025">
    <meta name="location" content="Global">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Munetios Docs Suite">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#ffffff">
    <meta name="trademark" content="Munetios™️ is a unregistered trademark of Munetios. but I have some branding protected but didnt register so I have some protection.">
    <meta property="og:site_name" content="Munetios 97529 office">
    <meta property="og:title" content="Munetios 97529 office">
    <meta property="og:description" content="All-in-one platform for Docs, Presentations (coming soon), Worksheets, and Journal.">
    <meta property="og:image" content="image.png">
    <meta property="og:type" content="website">
    <meta name="robots" content="index, follow">
    <meta http-equiv="Content-Security-Policy"
content="
  default-src 'self' https:;
  img-src 'self' data:;
        frame-ancestors 'none';
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://api.munetios.com;
  font-src 'self' https://fonts.gstatic.com;
  script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://api.munetios.com;
  frame-src 'self' https://www.munetios.com;
  connect-src 'self' https://api.munetios.com;
">
 
    <link rel="stylesheet" href="https://api.munetios.com/beautiful-css/beautiful.css">
    <!-- Lexend font for modern, readable typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;700&display=swap" rel="stylesheet">
    <!-- Additional Google Fonts for more choices -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Open+Sans:wght@400;700&family=Montserrat:wght@400;700&family=Lato:wght@400;700&family=Nunito:wght@400;700&family=Oswald:wght@400;700&family=Raleway:wght@400;700&family=Source+Sans+Pro:wght@400;700&family=Work+Sans:wght@400;700&family=Playfair+Display:wght@400;700&family=Quicksand:wght@400;700&family=PT+Sans:wght@400;700&family=PT+Serif:wght@400;700&family=Fira+Sans:wght@400;700&family=Manrope:wght@400;700&family=Mulish:wght@400;700&family=Overpass:wght@400;700&family=Rubik:wght@400;700&family=Sarabun:wght@400;700&family=Space+Mono:wght@400;700&family=Syne:wght@400;700&family=Zilla+Slab:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
            window.addEventListener('beforeinstallprompt', function(e) {
                e.preventDefault();
                window.deferredPrompt = e;
                // Optionally show a custom install button under "Your Projects" title
                let installBtn = document.createElement('button');
                installBtn.textContent = 'Install 97529 office';
                installBtn.className = 'btn';
                installBtn.style.margin = '18px 0 0 0';
                installBtn.style.display = 'block';
                installBtn.style.fontSize = '18px';
                installBtn.style.width = 'fit-content';
                installBtn.style.alignSelf = 'flex-start';
                // Insert under "Your Projects" title
                let projectsTitle = document.querySelector('.content h2');
                if (projectsTitle && projectsTitle.parentNode) {
                    projectsTitle.parentNode.insertBefore(installBtn, projectsTitle.nextSibling);
                } else {
                    document.body.appendChild(installBtn);
                }
                installBtn.onclick = function() {
                    window.deferredPrompt.prompt();
                    window.deferredPrompt.userChoice.then(function(choiceResult) {
                        if (choiceResult.outcome === 'accepted') {
                            installBtn.remove();
                        }
                        window.deferredPrompt = null;
                    });
                };
            });
            // Listen for updates and prompt user to refresh
            navigator.serviceWorker.addEventListener('controllerchange', function() {
                if (confirm('A new version is available. Reload to update?')) {
                    window.location.reload();
                }
            });
        
    </script>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Lexend', sans-serif;
            margin: 0;
            padding: 0;
        }
        .top-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
     .menu-btn {
        padding: 10px 15px;
        cursor: pointer;

     }
     .menu-btn button {
       padding: 15px 20px;
       display: flex;
         align-items: center;
         cursor: pointer;
            justify-content: center;
     }
     .menu-btn button:hover {
        background-color: rgba(89, 6, 145, 0.26);
        border-radius: 83px;
     }
     .menu-bar {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: nowrap;
     }.editor-screen {
        display: none;
     }
     .search-bar {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 15px 20px;
        border-radius: 50px;
        border: 1px solid rgba( 255, 255, 255, 0.18 );
        background: rgba(255, 255, 255, 0.18);
        box-shadow: 0 8px 32px 0 rgba( 31, 38, 135, 0.37 );
        backdrop-filter: blur(6px);
        transition: background 0.2s, border 0.2s;
        width: 100%;
        max-width: 800px;
     }
     .search-bar input {
        border: none;
        outline: none;
        background: none;
        color: inherit;
        font-size: 16px;
        width: 100%;
     }
     select, input, textarea {
            font-family: 'Lexend', sans-serif;
     }
     .topbar {
        width: 100%;
        height: 90px;
        position: sticky;
        top: 0;
        gap: 10px;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: space-between;
     }
     [hidden] {
        display: none !important;
     }
  button,  .btn {
       background: rgba(255, 255, 255, 0.18);
       border: 1px solid rgba( 255, 255, 255, 0.18 );
       padding: 15px 20px;
       cursor: pointer;
       font-size: 16px;
       border-radius: 50px;
       color: white;
           font-family: 'Lexend', sans-serif;
       box-shadow: 0 8px 32px 0 rgba( 31, 38, 135, 0.37 );
       backdrop-filter: blur(6px);
       transition: background 0.2s, border 0.2s;
    }
    .btn:hover {
       background: rgba(89, 6, 145, 0.18);
       border-color: rgba(89, 6, 145, 0.5);
    }
    .top-right {
        margin-left: auto;
        padding-right: 15px;
        display: flex;
        padding: 15px 20px;
        align-items: center;
        justify-content: flex-end;
        /* Liquid Glass */
        gap: 20px;
            background: rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    backdrop-filter: blur(3px);
    -webkit-backdrop-filter: blur( 5px );
    border-radius: 50px;
    border: 1px solid rgba(255, 255, 255, 0.18);
     }
    .top-right button {
       margin: 0;
       padding: 0;
       border: none;
       background: none !important;
       cursor: pointer;
       display: flex;
       align-items: center;
       gap: 5px;
       justify-content: center;
       color: inherit;
       box-shadow: none;
       border-radius: 0;
       transition: none;
       backdrop-filter: none !important;
    }
    .top-right button:hover {
       background: none !important;
    }
    .mobile-search-icon {
        margin-left: auto;
        display: none;
     }
     .topbar-right {
        display: flex;
        align-items: center;
        gap: 10px;
     }
     .content {
        padding: 20px;
     }
     .context-wrapper {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 3000;
        pointer-events: auto;
        background: rgba(255, 255, 255, 0.18);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        display: none;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-radius: 32px;
     }
     .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        background: rgba(31, 38, 135, 0.18);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        transition: opacity 0.2s;
        pointer-events: none;
        opacity: 0;
        }

        .modal.active {
        opacity: 1;
        pointer-events: auto;
        }
        .editor-content {
            display: none;
        }
        .modal-content {
        background: rgba(255, 255, 255, 0.18);
        border-radius: 32px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        border: 1px solid rgba(255, 255, 255, 0.18);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        padding: 32px 24px;
        max-width: 420px;
        width: 100%;
        color: #12092b;
        position: relative;
        }
        .apps-wrapper {
            display: none;
            position: absolute;
            top: 80px;
            right: 24px;
            z-index: 3000;
            background: rgba(255,255,255,0.95);
            box-shadow: 0 8px 32px 0 rgba(31,38,135,0.18);
            border-radius: 24px;
            padding: 0;
            overflow: hidden;
            transition: opacity 0.2s;
            width: 500px;
            max-width: 90vw;
            height: 900px;
            max-height: 90vh;
        }
        .toolbar {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.18);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        backdrop-filter: blur(6px);
        -webkit-backdrop-filter: blur(6px);
        border-radius: 36px;
        margin: 10px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        }

        @media (prefers-color-scheme: dark) {
        .modal-content {
            background: rgba(18, 9, 43, 0.85);
            color: #e0e0e0;
        }
        }
     @media (max-width: 1044px) {
        .menu-bar button:nth-last-child(2){
            display: none;
        }
     }
     @Media (max-width: 894px) {
        .menu-bar button:nth-last-child(1),
        .menu-bar button:nth-last-child(5){
            display: none;
        }
     }
     @media (max-width: 900px) {
        .search-bar {
            display: none;
        }
        .mobile-search-icon {
            display: block;
        }
     }
     @media (max-width: 800px) {
        #appsBtn {
            display: none;
        }
        .create-label {
            display: none;
        }
        .topbar {
            gap: 5px;
        }
     }

     @media (max-width: 642px) {
        #editorUndoBtn,
        #editorRedoBtn {
            display: none;
        }
     }
     @media (max-width: 720px) {
        .menu-bar button:nth-last-child(4) {
            display: none;
        }
     }
     @media (max-width: 512px) {
       .top-left {
            gap: 1px;
        }
        .menu-btn button, .btn, button {
            padding: 10px 15px;
        }
        .top-right {
            padding: 10px 15px;
        }
        .topbar-right {
            position: absolute;
            right: 10px;
            gap: 5px;
        }
     }
     @media (max-width: 440px) {
        .menu-bar {
            display: none;
        }
     }
     @media (max-width: 454px) {
        #helpBtn {
            display: none;
        }
        .topbar {
            height: 60px;
            gap: 2px;
        }
        .topbar-right {
            gap: 3px;
        }
        .menu-btn button {
            padding: 5px 10px;
        }
     }
     @media (prefers-color-scheme: dark) {
        body {
            background-color: #12092b;
            color: #e0e0e0;
        }
        svg {
            color: white !important;
        }
        .menu-btn button {
            color: white;
        }
       
     }
    </style>
</head>
<body>
    <div class="home-screen">
    <div class="topbar" style="display: flex; align-items: center; justify-content: space-between;">
        <div class="top-left">
            <div class="menu-btn">
                <button aria-label="Sort by & filter" title="Sort by & filter" class="liquid-glass btn" id="menuBtn">
                    <svg width="28" height="28" viewBox="0 0 28 28" fill="none" aria-hidden="true">
                        <rect y="7" width="28" height="3" rx="1.5" fill="currentColor"/>
                        <rect y="14" width="28" height="3" rx="1.5" fill="currentColor"/>
                        <rect y="21" width="28" height="3" rx="1.5" fill="currentColor"/>
                    </svg>
                </button>
            </div>
        </div>
        <div class="search-bar">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" aria-hidden="true" style="vertical-align: middle; margin-right: 8px;">
                <circle cx="9" cy="9" r="7" stroke="currentColor" stroke-width="2"/>
                <line x1="13.6569" y1="13.6569" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <input type="text" placeholder="Search Anything" id="searchInput">
        </div>
        <div class="topbar-right">
        <div class="mobile-search-icon" id="mobileSearchIcon">
            <button title="Search" aria-label="Search" class="liquid-glass btn" id="searchBtn">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" aria-hidden="true">
                    <circle cx="9" cy="9" r="7" stroke="currentColor" stroke-width="2"/>
                    <line x1="13.6569" y1="13.6569" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
        </div>
        <div class="top-right"> 
              <button title="Add" aria-label="Add" class="liquid-glass btn" id="addBtn">
                    <svg width="28" height="28" viewBox="0 0 20 20" fill="none" aria-hidden="true">
                        <rect x="9" y="4" width="2" height="12" rx="1" fill="currentColor"/>
                        <rect x="4" y="9" width="12" height="2" rx="1" fill="currentColor"/>
                    </svg>
                    <span style="margin-left:6px;" class="create-label">Create</span>
                </button>
              
                <button title="Settings" aria-label="Settings" class="liquid-glass btn" id="settingsBtn">
                 <svg height="28" width="28" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.438.995s.145.755.438.995l1.003.827c.48.398.668 1.03.26 1.431l-1.296 2.247a1.125 1.125 0 01-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 01-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 01-1.37-.49l-1.296-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.437-.995s-.145-.755-.437-.995l-1.004-.827a1.125 1.125 0 01-.26-1.431l1.296-2.247a1.125 1.125 0 011.37-.49l1.217.456c.355.133.75.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" stroke="currentColor"/>
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke="currentColor"/>
                 </svg>
                </button>
                <button title="Help" aria-label="Help" class="liquid-glass btn" id="helpBtn">
                 <svg width="28" height="28" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" stroke="currentColor"/>
                 </svg>
                </button>
               <button title="Apps" aria-label="Apps" class="liquid-glass btn" id="appsBtn">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" aria-hidden="true">
                        <rect x="2" y="2" width="4" height="4" rx="1" fill="currentColor"/>
                        <rect x="8" y="2" width="4" height="4" rx="1" fill="currentColor"/>
                        <rect x="14" y="2" width="4" height="4" rx="1" fill="currentColor"/>
                        <rect x="2" y="8" width="4" height="4" rx="1" fill="currentColor"/>
                        <rect x="8" y="8" width="4" height="4" rx="1" fill="currentColor"/>
                        <rect x="14" y="8" width="4" height="4" rx="1" fill="currentColor"/>
                        <rect x="2" y="14" width="4" height="4" rx="1" fill="currentColor"/>
                        <rect x="8" y="14" width="4" height="4" rx="1" fill="currentColor"/>
                        <rect x="14" y="14" width="4" height="4" rx="1" fill="currentColor"/>
                    </svg>
                </button>
                <div class="apps-wrapper">
                    <iframe src="https://www.munetios.com/apps" height="900" width="500" frameborder="0"></iframe>
                </div>
            
   </div>
        </div>
        </div>
        <script>
            document.getElementById('settingsBtn').onclick = function () {
                const modal = document.getElementById('modalUIRender');
                // Simple i18n translations
                const lang = localStorage.getItem('munetios_lang') || navigator.language.slice(0,2) || 'en';
                const translations = {
                    en: {
                        settings: "Settings",
                        darkMode: "Dark Mode",
                        systemTheme: "System Theme",
                        lightMode: "Light Mode",
                        language: "Language",
                        defaultFont: "Default Font",
                        docs: "Docs",
                        spreadsheet: "Spreadsheet",
                        journal: "Journal",
                        save: "Save",
                        close: "Close",
                        help: "Help",
                        tools: "Tools",
                        file: "File",
                        edit: "Edit",
                        view: "View",
                        insert: "Insert",
                        undo: "Undo",
                        redo: "Redo",
                        history: "History",
                        share: "Share",
                        more: "More",
                        search: "Search",
                        create: "Create",
                        project: "Project",
                        projects: "Projects",
                        sort: "Sort",
                        filter: "Filter",
                        apply: "Apply",
                        cancel: "Cancel",
                        name: "Name",
                        type: "Type",
                        created: "Created",
                        modified: "Modified",
                        details: "Details",
                        delete: "Delete",
                        confirm: "Confirm",
                        permanentDelete: "Delete Permanently",
                        print: "Print",
                        download: "Download",
                        downloadTxt: "Download as TXT",
                        downloadMd: "Download as Markdown",
                        downloadCsv: "Download as CSV",
                        downloadXlsx: "Download as XLSX",
                        copy: "Copy",
                        paste: "Paste",
                        cut: "Cut",
                        selectAll: "Select All",
                        find: "Find",
                        replace: "Replace",
                        replaceAll: "Replace All",
                        wordCount: "Word Count",
                        characters: "Characters",
                        size: "Size",
                        fontFamily: "Font Family",
                        fontSize: "Font Size",
                        alignLeft: "Align Left",
                        alignCenter: "Align Center",
                        alignRight: "Align Right",
                        alignTop: "Align Top",
                        alignMiddle: "Align Middle",
                        alignBottom: "Align Bottom",
                        bold: "Bold",
                        italic: "Italic",
                        underline: "Underline",
                        strike: "Strikethrough",
                        checklist: "Checklist",
                        quote: "Quote",
                        hr: "Horizontal Line",
                        link: "Link",
                        image: "Image",
                        video: "Video",
                        table: "Table",
                        dropdown: "Dropdown",
                        toc: "Table of Contents",
                        code: "Code Block",
                        makeCopy: "Make a Copy",
                        rename: "Rename",
                        version: "Version History",
                        fullscreen: "Fullscreen",
                        zoomIn: "Zoom In",
                        zoomOut: "Zoom Out",
                        resetZoom: "Reset Zoom",
                        addPage: "Add Page",
                        removePage: "Remove Page",
                        info: "Info",
                        contact: "Contact",
                        requestFeature: "Request a Feature",
                        reportBug: "Report a Bug",
                        keyboardShortcuts: "Keyboard Shortcuts",
                        autocorrect: "AutoCorrecter",
                        directany: "Directany",
                        compareDocs: "Compare Documents",
                        autoSave: "Auto Save",
                        default: "Default",
                        options: "Options",
                        actions: "Actions",
                        open: "Open",
                        closeWindow: "Close Window",
                        error: "Error",
                        success: "Success",
                        warning: "Warning",
                        infoMsg: "Info",
                        noFiles: "No files found.",
                        welcome: "Welcome",
                        searchProjects: "Search projects...",
                        sortBy: "Sort by",
                        filterByType: "Filter by Type",
                        system: "System",
                        light: "Light",
                        dark: "Dark",
                        docsSuite: "Munetios Docs Suite",
                        spreadsheetSuite: "Munetios Spreadsheet Suite",
                        journalSuite: "Munetios Journal Suite"
                    },
                    es: {
                        settings: "Configuración",
                        darkMode: "Modo Oscuro",
                        systemTheme: "Tema del sistema",
                        lightMode: "Modo Claro",
                        language: "Idioma",
                        defaultFont: "Fuente predeterminada",
                        docs: "Documentos",
                        spreadsheet: "Hoja de cálculo",
                        journal: "Diario",
                        save: "Guardar",
                        close: "Cerrar",
                        help: "Ayuda",
                        tools: "Herramientas",
                        file: "Archivo",
                        edit: "Editar",
                        view: "Ver",
                        insert: "Insertar",
                        undo: "Deshacer",
                        redo: "Rehacer",
                        history: "Historial",
                        share: "Compartir",
                        more: "Más",
                        search: "Buscar",
                        create: "Crear",
                        project: "Proyecto",
                        projects: "Proyectos",
                        sort: "Ordenar",
                        filter: "Filtrar",
                        apply: "Aplicar",
                        cancel: "Cancelar",
                        name: "Nombre",
                        type: "Tipo",
                        created: "Creado",
                        modified: "Modificado",
                        details: "Detalles",
                        delete: "Eliminar",
                        confirm: "Confirmar",
                        permanentDelete: "Eliminar permanentemente",
                        print: "Imprimir",
                        download: "Descargar",
                        downloadTxt: "Descargar como TXT",
                        downloadMd: "Descargar como Markdown",
                        downloadCsv: "Descargar como CSV",
                        downloadXlsx: "Descargar como XLSX",
                        copy: "Copiar",
                        paste: "Pegar",
                        cut: "Cortar",
                        selectAll: "Seleccionar todo",
                        find: "Buscar",
                        replace: "Reemplazar",
                        replaceAll: "Reemplazar todo",
                        wordCount: "Contar palabras",
                        characters: "Caracteres",
                        size: "Tamaño",
                        fontFamily: "Fuente",
                        fontSize: "Tamaño de fuente",
                        alignLeft: "Alinear a la izquierda",
                        alignCenter: "Alinear al centro",
                        alignRight: "Alinear a la derecha",
                        alignTop: "Alinear arriba",
                        alignMiddle: "Alinear al medio",
                        alignBottom: "Alinear abajo",
                        bold: "Negrita",
                        italic: "Cursiva",
                        underline: "Subrayado",
                        strike: "Tachado",
                        checklist: "Lista de verificación",
                        quote: "Cita",
                        hr: "Línea horizontal",
                        link: "Enlace",
                        image: "Imagen",
                        video: "Vídeo",
                        table: "Tabla",
                        dropdown: "Desplegable",
                        toc: "Tabla de contenidos",
                        code: "Bloque de código",
                        makeCopy: "Hacer una copia",
                        rename: "Renombrar",
                        version: "Historial de versiones",
                        fullscreen: "Pantalla completa",
                        zoomIn: "Acercar",
                        zoomOut: "Alejar",
                        resetZoom: "Restablecer zoom",
                        addPage: "Agregar página",
                        removePage: "Eliminar página",
                        info: "Información",
                        contact: "Contacto",
                        requestFeature: "Solicitar una función",
                        reportBug: "Reportar un error",
                        keyboardShortcuts: "Atajos de teclado",
                        autocorrect: "Autocorrector",
                        directany: "Directany",
                        compareDocs: "Comparar documentos",
                        autoSave: "Auto guardar",
                        default: "Predeterminado",
                        options: "Opciones",
                        actions: "Acciones",
                        open: "Abrir",
                        closeWindow: "Cerrar ventana",
                        error: "Error",
                        success: "Éxito",
                        warning: "Advertencia",
                        infoMsg: "Información",
                        noFiles: "No se encontraron archivos.",
                        welcome: "Bienvenido",
                        searchProjects: "Buscar proyectos...",
                        sortBy: "Ordenar por",
                        filterByType: "Filtrar por tipo",
                        system: "Sistema",
                        light: "Claro",
                        dark: "Oscuro",
                        docsSuite: "Munetios Docs Suite",
                        spreadsheetSuite: "Munetios Spreadsheet Suite",
                        journalSuite: "Munetios Journal Suite"
                    },
                    fr: {
                        settings: "Paramètres",
                        darkMode: "Mode sombre",
                        systemTheme: "Thème du système",
                        lightMode: "Mode clair",
                        language: "Langue",
                        defaultFont: "Police par défaut",
                        docs: "Documents",
                        spreadsheet: "Tableur",
                        journal: "Journal",
                        save: "Enregistrer",
                        close: "Fermer",
                        help: "Aide",
                        tools: "Outils",
                        file: "Fichier",
                        edit: "Éditer",
                        view: "Vue",
                        insert: "Insérer",
                        undo: "Annuler",
                        redo: "Rétablir",
                        history: "Historique",
                        share: "Partager",
                        more: "Plus",
                        search: "Rechercher",
                        create: "Créer",
                        project: "Projet",
                        projects: "Projets",
                        sort: "Trier",
                        filter: "Filtrer",
                        apply: "Appliquer",
                        cancel: "Annuler",
                        name: "Nom",
                        type: "Type",
                        created: "Créé",
                        modified: "Modifié",
                        details: "Détails",
                        delete: "Supprimer",
                        confirm: "Confirmer",
                        permanentDelete: "Supprimer définitivement",
                        print: "Imprimer",
                        download: "Télécharger",
                        downloadTxt: "Télécharger en TXT",
                        downloadMd: "Télécharger en Markdown",
                        downloadCsv: "Télécharger en CSV",
                        downloadXlsx: "Télécharger en XLSX",
                        copy: "Copier",
                        paste: "Coller",
                        cut: "Couper",
                        selectAll: "Tout sélectionner",
                        find: "Trouver",
                        replace: "Remplacer",
                        replaceAll: "Tout remplacer",
                        wordCount: "Nombre de mots",
                        characters: "Caractères",
                        size: "Taille",
                        fontFamily: "Famille de police",
                        fontSize: "Taille de police",
                        alignLeft: "Aligner à gauche",
                        alignCenter: "Aligner au centre",
                        alignRight: "Aligner à droite",
                        alignTop: "Aligner en haut",
                        alignMiddle: "Aligner au milieu",
                        alignBottom: "Aligner en bas",
                        bold: "Gras",
                        italic: "Italique",
                        underline: "Souligner",
                        strike: "Barré",
                        checklist: "Liste de contrôle",
                        quote: "Citation",
                        hr: "Ligne horizontale",
                        link: "Lien",
                        image: "Image",
                        video: "Vidéo",
                        table: "Tableau",
                        dropdown: "Liste déroulante",
                        toc: "Table des matières",
                        code: "Bloc de code",
                        makeCopy: "Faire une copie",
                        rename: "Renommer",
                        version: "Historique des versions",
                        fullscreen: "Plein écran",
                        zoomIn: "Agrandir",
                        zoomOut: "Rétrécir",
                        resetZoom: "Réinitialiser le zoom",
                        addPage: "Ajouter une page",
                        removePage: "Supprimer la page",
                        info: "Info",
                        contact: "Contact",
                        requestFeature: "Demander une fonctionnalité",
                        reportBug: "Signaler un bug",
                        keyboardShortcuts: "Raccourcis clavier",
                        autocorrect: "Correcteur automatique",
                        directany: "Directany",
                        compareDocs: "Comparer les documents",
                        autoSave: "Sauvegarde automatique",
                        default: "Défaut",
                        options: "Options",
                        actions: "Actions",
                        open: "Ouvrir",
                        closeWindow: "Fermer la fenêtre",
                        error: "Erreur",
                        success: "Succès",
                        warning: "Avertissement",
                        infoMsg: "Info",
                        noFiles: "Aucun fichier trouvé.",
                        welcome: "Bienvenue",
                        searchProjects: "Rechercher des projets...",
                        sortBy: "Trier par",
                        filterByType: "Filtrer par type",
                        system: "Système",
                        light: "Clair",
                        dark: "Sombre",
                        docsSuite: "Munetios Docs Suite",
                        spreadsheetSuite: "Munetios Spreadsheet Suite",
                        journalSuite: "Munetios Journal Suite"
                    },
                    de: {
                        settings: "Einstellungen",
                        darkMode: "Dunkler Modus",
                        systemTheme: "Systemthema",
                        lightMode: "Heller Modus",
                        language: "Sprache",
                        defaultFont: "Standard-Schriftart",
                        docs: "Dokumente",
                        spreadsheet: "Tabellenkalkulation",
                        journal: "Journal",
                        save: "Speichern",
                        close: "Schließen",
                        help: "Hilfe",
                        tools: "Werkzeuge",
                        file: "Datei",
                        edit: "Bearbeiten",
                        view: "Ansicht",
                        insert: "Einfügen",
                        undo: "Rückgängig",
                        redo: "Wiederholen",
                        history: "Verlauf",
                        share: "Teilen",
                        more: "Mehr",
                        search: "Suchen",
                        create: "Erstellen",
                        project: "Projekt",
                        projects: "Projekte",
                        sort: "Sortieren",
                        filter: "Filtern",
                        apply: "Anwenden",
                        cancel: "Abbrechen",
                        name: "Name",
                        type: "Typ",
                        created: "Erstellt",
                        modified: "Geändert",
                        details: "Details",
                        delete: "Löschen",
                        confirm: "Bestätigen",
                        permanentDelete: "Endgültig löschen",
                        print: "Drucken",
                        download: "Herunterladen",
                        downloadTxt: "Als TXT herunterladen",
                        downloadMd: "Als Markdown herunterladen",
                        downloadCsv: "Als CSV herunterladen",
                        downloadXlsx: "Als XLSX herunterladen",
                        copy: "Kopieren",
                        paste: "Einfügen",
                        cut: "Ausschneiden",
                        selectAll: "Alles auswählen",
                        find: "Finden",
                        replace: "Ersetzen",
                        replaceAll: "Alle ersetzen",
                        wordCount: "Wörter zählen",
                        characters: "Zeichen",
                        size: "Größe",
                        fontFamily: "Schriftfamilie",
                        fontSize: "Schriftgröße",
                        alignLeft: "Links ausrichten",
                        alignCenter: "Zentrieren",
                        alignRight: "Rechts ausrichten",
                        alignTop: "Oben ausrichten",
                        alignMiddle: "Mittig ausrichten",
                        alignBottom: "Unten ausrichten",
                        bold: "Fett",
                        italic: "Kursiv",
                        underline: "Unterstreichen",
                        strike: "Durchgestrichen",
                        checklist: "Checkliste",
                        quote: "Zitat",
                        hr: "Horizontale Linie",
                        link: "Link",
                        image: "Bild",
                        video: "Video",
                        table: "Tabelle",
                        dropdown: "Dropdown",
                        toc: "Inhaltsverzeichnis",
                        code: "Codeblock",
                        makeCopy: "Kopie erstellen",
                        rename: "Umbenennen",
                        version: "Versionsverlauf",
                        fullscreen: "Vollbild",
                        zoomIn: "Vergrößern",
                        zoomOut: "Verkleinern",
                        resetZoom: "Zoom zurücksetzen",
                        addPage: "Seite hinzufügen",
                        removePage: "Seite entfernen",
                        info: "Info",
                        contact: "Kontakt",
                        requestFeature: "Funktion anfordern",
                        reportBug: "Fehler melden",
                        keyboardShortcuts: "Tastenkombinationen",
                        autocorrect: "Autokorrektur",
                        directany: "Directany",
                        compareDocs: "Dokumente vergleichen",
                        autoSave: "Automatisch speichern",
                        default: "Standard",
                        options: "Optionen",
                        actions: "Aktionen",
                        open: "Öffnen",
                        closeWindow: "Fenster schließen",
                        error: "Fehler",
                        success: "Erfolg",
                        warning: "Warnung",
                        infoMsg: "Info",
                        noFiles: "Keine Dateien gefunden.",
                        welcome: "Willkommen",
                        searchProjects: "Projekte suchen...",
                        sortBy: "Sortieren nach",
                        filterByType: "Nach Typ filtern",
                        system: "System",
                        light: "Hell",
                        dark: "Dunkel",
                        docsSuite: "Munetios Docs Suite",
                        spreadsheetSuite: "Munetios Spreadsheet Suite",
                        journalSuite: "Munetios Journal Suite"
                    },
                    it: {
                        settings: "Impostazioni",
                        darkMode: "Modalità scura",
                        systemTheme: "Tema di sistema",
                        lightMode: "Modalità chiara",
                        language: "Lingua",
                        defaultFont: "Font predefinito",
                        docs: "Documenti",
                        spreadsheet: "Foglio di calcolo",
                        journal: "Diario",
                        save: "Salva",
                        close: "Chiudi",
                        help: "Aiuto",
                        tools: "Strumenti",
                        file: "File",
                        edit: "Modifica",
                        view: "Visualizza",
                        insert: "Inserisci",
                        undo: "Annulla",
                        redo: "Ripristina",
                        history: "Cronologia",
                        share: "Condividi",
                        more: "Altro",
                        search: "Cerca",
                        create: "Crea",
                        project: "Progetto",
                        projects: "Progetti",
                        sort: "Ordina",
                        filter: "Filtra",
                        apply: "Applica",
                        cancel: "Annulla",
                        name: "Nome",
                        type: "Tipo",
                        created: "Creato",
                        modified: "Modificato",
                        details: "Dettagli",
                        delete: "Elimina",
                        confirm: "Conferma",
                        permanentDelete: "Elimina definitivamente",
                        print: "Stampa",
                        download: "Scarica",
                        downloadTxt: "Scarica come TXT",
                        downloadMd: "Scarica come Markdown",
                        downloadCsv: "Scarica come CSV",
                        downloadXlsx: "Scarica come XLSX",
                        copy: "Copia",
                        paste: "Incolla",
                        cut: "Taglia",
                        selectAll: "Seleziona tutto",
                        find: "Trova",
                        replace: "Sostituisci",
                        replaceAll: "Sostituisci tutto",
                        wordCount: "Conteggio parole",
                        characters: "Caratteri",
                        size: "Dimensione",
                        fontFamily: "Famiglia di font",
                        fontSize: "Dimensione font",
                        alignLeft: "Allinea a sinistra",
                        alignCenter: "Allinea al centro",
                        alignRight: "Allinea a destra",
                        alignTop: "Allinea in alto",
                        alignMiddle: "Allinea al centro",
                        alignBottom: "Allinea in basso",
                        bold: "Grassetto",
                        italic: "Corsivo",
                        underline: "Sottolineato",
                        strike: "Barrato",
                        checklist: "Lista di controllo",
                        quote: "Citazione",
                        hr: "Linea orizzontale",
                        link: "Collegamento",
                        image: "Immagine",
                        video: "Video",
                        table: "Tabella",
                        dropdown: "Menu a discesa",
                        toc: "Indice",
                        code: "Blocco di codice",
                        makeCopy: "Crea una copia",
                        rename: "Rinomina",
                        version: "Cronologia versioni",
                        fullscreen: "Schermo intero",
                        zoomIn: "Ingrandisci",
                        zoomOut: "Riduci",
                        resetZoom: "Reimposta zoom",
                        addPage: "Aggiungi pagina",
                        removePage: "Rimuovi pagina",
                        info: "Info",
                        contact: "Contatto",
                        requestFeature: "Richiedi una funzione",
                        reportBug: "Segnala un bug",
                        keyboardShortcuts: "Scorciatoie da tastiera",
                        autocorrect: "Correttore automatico",
                        directany: "Directany",
                        compareDocs: "Confronta documenti",
                        autoSave: "Salvataggio automatico",
                        default: "Predefinito",
                        options: "Opzioni",
                        actions: "Azioni",
                        open: "Apri",
                        closeWindow: "Chiudi finestra",
                        error: "Errore",
                        success: "Successo",
                        warning: "Avviso",
                        infoMsg: "Info",
                        noFiles: "Nessun file trovato.",
                        welcome: "Benvenuto",
                        searchProjects: "Cerca progetti...",
                        sortBy: "Ordina per",
                        filterByType: "Filtra per tipo",
                        system: "Sistema",
                        light: "Chiaro",
                        dark: "Scuro",
                        docsSuite: "Munetios Docs Suite",
                        spreadsheetSuite: "Munetios Spreadsheet Suite",
                        journalSuite: "Munetios Journal Suite"
                    },
                    pt: {
                        settings: "Configurações",
                        darkMode: "Modo escuro",
                        systemTheme: "Tema do sistema",
                        lightMode: "Modo claro",
                        language: "Idioma",
                        defaultFont: "Fonte padrão",
                        docs: "Documentos",
                        spreadsheet: "Planilha",
                        journal: "Diário",
                        save: "Salvar",
                        close: "Fechar",
                        help: "Ajuda",
                        tools: "Ferramentas",
                        file: "Arquivo",
                        edit: "Editar",
                        view: "Visualizar",
                        insert: "Inserir",
                        undo: "Desfazer",
                        redo: "Refazer",
                        history: "Histórico",
                        share: "Compartilhar",
                        more: "Mais",
                        search: "Pesquisar",
                        create: "Criar",
                        project: "Projeto",
                        projects: "Projetos",
                        sort: "Ordenar",
                        filter: "Filtrar",
                        apply: "Aplicar",
                        cancel: "Cancelar",
                        name: "Nome",
                        type: "Tipo",
                        created: "Criado",
                        modified: "Modificado",
                        details: "Detalhes",
                        delete: "Excluir",
                        confirm: "Confirmar",
                        permanentDelete: "Excluir permanentemente",
                        print: "Imprimir",
                        download: "Baixar",
                        downloadTxt: "Baixar como TXT",
                        downloadMd: "Baixar como Markdown",
                        downloadCsv: "Baixar como CSV",
                        downloadXlsx: "Baixar como XLSX",
                        copy: "Copiar",
                        paste: "Colar",
                        cut: "Cortar",
                        selectAll: "Selecionar tudo",
                        find: "Encontrar",
                        replace: "Substituir",
                        replaceAll: "Substituir tudo",
                        wordCount: "Contagem de palavras",
                        characters: "Caracteres",
                        size: "Tamanho",
                        fontFamily: "Família de fontes",
                        fontSize: "Tamanho da fonte",
                        alignLeft: "Alinhar à esquerda",
                        alignCenter: "Centralizar",
                        alignRight: "Alinhar à direita",
                        alignTop: "Alinhar acima",
                        alignMiddle: "Alinhar ao meio",
                        alignBottom: "Alinhar abaixo",
                        bold: "Negrito",
                        italic: "Itálico",
                        underline: "Sublinhado",
                        strike: "Riscado",
                        checklist: "Lista de verificação",
                        quote: "Citação",
                        hr: "Linha horizontal",
                        link: "Link",
                        image: "Imagem",
                        video: "Vídeo",
                        table: "Tabela",
                        dropdown: "Dropdown",
                        toc: "Índice",
                        code: "Bloco de código",
                        makeCopy: "Fazer uma cópia",
                        rename: "Renomear",
                        version: "Histórico de versões",
                        fullscreen: "Tela cheia",
                        zoomIn: "Aumentar zoom",
                        zoomOut: "Diminuir zoom",
                        resetZoom: "Redefinir zoom",
                        addPage: "Adicionar página",
                        removePage: "Remover página",
                        info: "Informação",
                        contact: "Contato",
                        requestFeature: "Solicitar recurso",
                        reportBug: "Reportar erro",
                        keyboardShortcuts: "Atalhos de teclado",
                        autocorrect: "Autocorretor",
                        directany: "Directany",
                        compareDocs: "Comparar documentos",
                        autoSave: "Salvar automaticamente",
                        default: "Padrão",
                        options: "Opções",
                        actions: "Ações",
                        open: "Abrir",
                        closeWindow: "Fechar janela",
                        error: "Erro",
                        success: "Sucesso",
                        warning: "Aviso",
                        infoMsg: "Informação",
                        noFiles: "Nenhum arquivo encontrado.",
                        welcome: "Bem-vindo",
                        searchProjects: "Pesquisar projetos...",
                        sortBy: "Ordenar por",
                        filterByType: "Filtrar por tipo",
                        system: "Sistema",
                        light: "Claro",
                        dark: "Escuro",
                        docsSuite: "Munetios Docs Suite",
                        spreadsheetSuite: "Munetios Spreadsheet Suite",
                        journalSuite: "Munetios Journal Suite"
                    },
                    ru: {
                        settings: "Настройки",
                        darkMode: "Темный режим",
                        systemTheme: "Системная тема",
                        lightMode: "Светлый режим",
                        language: "Язык",
                        defaultFont: "Шрифт по умолчанию",
                        docs: "Документы",
                        spreadsheet: "Таблица",
                        journal: "Журнал",
                        save: "Сохранить",
                        close: "Закрыть",
                        help: "Помощь",
                        tools: "Инструменты",
                        file: "Файл",
                        edit: "Редактировать",
                        view: "Вид",
                        insert: "Вставить",
                        undo: "Отменить",
                        redo: "Повторить",
                        history: "История",
                        share: "Поделиться",
                        more: "Еще",
                        search: "Поиск",
                        create: "Создать",
                        project: "Проект",
                        projects: "Проекты",
                        sort: "Сортировать",
                        filter: "Фильтр",
                        apply: "Применить",
                        cancel: "Отмена",
                        name: "Имя",
                        type: "Тип",
                        created: "Создано",
                        modified: "Изменено",
                        details: "Детали",
                        delete: "Удалить",
                        confirm: "Подтвердить",
                        permanentDelete: "Удалить навсегда",
                        print: "Печать",
                        download: "Скачать",
                        downloadTxt: "Скачать как TXT",
                        downloadMd: "Скачать как Markdown",
                        downloadCsv: "Скачать как CSV",
                        downloadXlsx: "Скачать как XLSX",
                        copy: "Копировать",
                        paste: "Вставить",
                        cut: "Вырезать",
                        selectAll: "Выделить все",
                        find: "Найти",
                        replace: "Заменить",
                        replaceAll: "Заменить все",
                        wordCount: "Количество слов",
                        characters: "Символы",
                        size: "Размер",
                        fontFamily: "Семейство шрифтов",
                        fontSize: "Размер шрифта",
                        alignLeft: "Выровнять по левому краю",
                        alignCenter: "Выровнять по центру",
                        alignRight: "Выровнять по правому краю",
                        alignTop: "Выровнять по верху",
                        alignMiddle: "Выровнять по середине",
                        alignBottom: "Выровнять по низу",
                        bold: "Жирный",
                        italic: "Курсив",
                        underline: "Подчеркнутый",
                        strike: "Зачеркнутый",
                        checklist: "Список задач",
                        quote: "Цитата",
                        hr: "Горизонтальная линия",
                        link: "Ссылка",
                        image: "Изображение",
                        video: "Видео",
                        table: "Таблица",
                        dropdown: "Выпадающий список",
                        toc: "Оглавление",
                        code: "Блок кода",
                        makeCopy: "Сделать копию",
                        rename: "Переименовать",
                        version: "История версий",
                        fullscreen: "На весь экран",
                        zoomIn: "Увеличить",
                        zoomOut: "Уменьшить",
                        resetZoom: "Сбросить масштаб",
                        addPage: "Добавить страницу",
                        removePage: "Удалить страницу",
                        info: "Информация",
                        contact: "Контакт",
                        requestFeature: "Запросить функцию",
                        reportBug: "Сообщить об ошибке",
                        keyboardShortcuts: "Горячие клавиши",
                        autocorrect: "Автокорректор",
                        directany: "Directany",
                        compareDocs: "Сравнить документы",
                        autoSave: "Автосохранение",
                        default: "По умолчанию",
                        options: "Опции",
                        actions: "Действия",
                        open: "Открыть",
                        closeWindow: "Закрыть окно",
                        error: "Ошибка",
                        success: "Успех",
                        warning: "Предупреждение",
                        infoMsg: "Информация",
                        noFiles: "Файлы не найдены.",
                        welcome: "Добро пожаловать",
                        searchProjects: "Поиск проектов...",
                        sortBy: "Сортировать по",
                        filterByType: "Фильтровать по типу",
                        system: "Система",
                        light: "Светлый",
                        dark: "Темный",
                        docsSuite: "Munetios Docs Suite",
                        spreadsheetSuite: "Munetios Spreadsheet Suite",
                        journalSuite: "Munetios Journal Suite"
                    },
                    zh: {
                        settings: "设置",
                        darkMode: "深色模式",
                        systemTheme: "系统主题",
                        lightMode: "浅色模式",
                        language: "语言",
                        defaultFont: "默认字体",
                        docs: "文档",
                        spreadsheet: "表格",
                        journal: "日志",
                        save: "保存",
                        close: "关闭",
                        help: "帮助",
                        tools: "工具",
                        file: "文件",
                        edit: "编辑",
                        view: "视图",
                        insert: "插入",
                        undo: "撤销",
                        redo: "重做",
                        history: "历史",
                        share: "分享",
                        more: "更多",
                        search: "搜索",
                        create: "创建",
                        project: "项目",
                        projects: "项目",
                        sort: "排序",
                        filter: "筛选",
                        apply: "应用",
                        cancel: "取消",
                        name: "名称",
                        type: "类型",
                        created: "创建时间",
                        modified: "修改时间",
                        details: "详情",
                        delete: "删除",
                        confirm: "确认",
                        permanentDelete: "永久删除",
                        print: "打印",
                        download: "下载",
                        downloadTxt: "下载为TXT",
                        downloadMd: "下载为Markdown",
                        downloadCsv: "下载为CSV",
                        downloadXlsx: "下载为XLSX",
                        copy: "复制",
                        paste: "粘贴",
                        cut: "剪切",
                        selectAll: "全选",
                        find: "查找",
                        replace: "替换",
                        replaceAll: "全部替换",
                        wordCount: "字数统计",
                        characters: "字符",
                        size: "大小",
                        fontFamily: "字体",
                        fontSize: "字体大小",
                        alignLeft: "左对齐",
                        alignCenter: "居中对齐",
                        alignRight: "右对齐",
                        alignTop: "顶部对齐",
                        alignMiddle: "中间对齐",
                        alignBottom: "底部对齐",
                        bold: "加粗",
                        italic: "斜体",
                        underline: "下划线",
                        strike: "删除线",
                        checklist: "清单",
                        quote: "引用",
                        hr: "水平线",
                        link: "链接",
                        image: "图片",
                        video: "视频",
                        table: "表格",
                        dropdown: "下拉菜单",
                        toc: "目录",
                        code: "代码块",
                        makeCopy: "复制",
                        rename: "重命名",
                        version: "版本历史",
                        fullscreen: "全屏",
                        zoomIn: "放大",
                        zoomOut: "缩小",
                        resetZoom: "重置缩放",
                        addPage: "添加页面",
                        removePage: "移除页面",
                        info: "信息",
                        contact: "联系",
                        requestFeature: "请求功能",
                        reportBug: "报告错误",
                        keyboardShortcuts: "快捷键",
                        autocorrect: "自动校正",
                        directany: "Directany",
                        compareDocs: "比较文档",
                        autoSave: "自动保存",
                        default: "默认",
                        options: "选项",
                        actions: "操作",
                        open: "打开",
                        closeWindow: "关闭窗口",
                        error: "错误",
                        success: "成功",
                        warning: "警告",
                        infoMsg: "信息",
                        noFiles: "未找到文件。",
                        welcome: "欢迎",
                        searchProjects: "搜索项目...",
                        sortBy: "排序方式",
                        filterByType: "按类型筛选",
                        system: "系统",
                        light: "浅色",
                        dark: "深色",
                        docsSuite: "Munetios文档套件",
                        spreadsheetSuite: "Munetios表格套件",
                        journalSuite: "Munetios日志套件"
                    },
                    ja: {
                        settings: "設定",
                        darkMode: "ダークモード",
                        systemTheme: "システムテーマ",
                        lightMode: "ライトモード",
                        language: "言語",
                        defaultFont: "デフォルトフォント",
                        docs: "ドキュメント",
                        spreadsheet: "スプレッドシート",
                        journal: "ジャーナル",
                        save: "保存",
                        close: "閉じる",
                        help: "ヘルプ",
                        tools: "ツール",
                        file: "ファイル",
                        edit: "編集",
                        view: "表示",
                        insert: "挿入",
                        undo: "元に戻す",
                        redo: "やり直し",
                        history: "履歴",
                        share: "共有",
                        more: "もっと",
                        search: "検索",
                        create: "作成",
                        project: "プロジェクト",
                        projects: "プロジェクト",
                        sort: "並べ替え",
                        filter: "フィルター",
                        apply: "適用",
                        cancel: "キャンセル",
                        name: "名前",
                        type: "タイプ",
                        created: "作成日",
                        modified: "変更日",
                        details: "詳細",
                        delete: "削除",
                        confirm: "確認",
                        permanentDelete: "完全に削除",
                        print: "印刷",
                        download: "ダウンロード",
                        downloadTxt: "TXTとしてダウンロード",
                        downloadMd: "Markdownとしてダウンロード",
                        downloadCsv: "CSVとしてダウンロード",
                        downloadXlsx: "XLSXとしてダウンロード",
                        copy: "コピー",
                        paste: "貼り付け",
                        cut: "切り取り",
                        selectAll: "すべて選択",
                        find: "検索",
                        replace: "置換",
                        replaceAll: "すべて置換",
                        wordCount: "単語数",
                        characters: "文字数",
                        size: "サイズ",
                        fontFamily: "フォントファミリー",
                        fontSize: "フォントサイズ",
                        alignLeft: "左揃え",
                        alignCenter: "中央揃え",
                        alignRight: "右揃え",
                        alignTop: "上揃え",
                        alignMiddle: "中央揃え",
                        alignBottom: "下揃え",
                        bold: "太字",
                        italic: "斜体",
                        underline: "下線",
                        strike: "取り消し線",
                        checklist: "チェックリスト",
                        quote: "引用",
                        hr: "水平線",
                        link: "リンク",
                        image: "画像",
                        video: "ビデオ",
                        table: "表",
                        dropdown: "ドロップダウン",
                        toc: "目次",
                        code: "コードブロック",
                        makeCopy: "コピーを作成",
                        rename: "名前変更",
                        version: "バージョン履歴",
                        fullscreen: "全画面",
                        zoomIn: "ズームイン",
                        zoomOut: "ズームアウト",
                        resetZoom: "ズームリセット",
                        addPage: "ページ追加",
                        removePage: "ページ削除",
                        info: "情報",
                        contact: "連絡",
                        requestFeature: "機能リクエスト",
                        reportBug: "バグ報告",
                        keyboardShortcuts: "キーボードショートカット",
                        autocorrect: "自動修正",
                        directany: "Directany",
                        compareDocs: "ドキュメント比較",
                        autoSave: "自動保存",
                        default: "デフォルト",
                        options: "オプション",
                        actions: "アクション",
                        open: "開く",
                        closeWindow: "ウィンドウを閉じる",
                        error: "エラー",
                        success: "成功",
                        warning: "警告",
                        infoMsg: "情報",
                        noFiles: "ファイルが見つかりません。",
                        welcome: "ようこそ",
                        searchProjects: "プロジェクト検索...",
                        sortBy: "並べ替え",
                        filterByType: "タイプでフィルター",
                        system: "システム",
                        light: "ライト",
                        dark: "ダーク",
                        docsSuite: "Munetios Docs Suite",
                        spreadsheetSuite: "Munetios Spreadsheet Suite",
                        journalSuite: "Munetios Journal Suite"
                    },
                    ko: {
                        settings: "설정",
                        darkMode: "다크 모드",
                        systemTheme: "시스템 테마",
                        lightMode: "라이트 모드",
                        language: "언어",
                        defaultFont: "기본 글꼴",
                        docs: "문서",
                        spreadsheet: "스프레드시트",
                        journal: "저널",
                        save: "저장",
                        close: "닫기",
                        help: "도움말",
                        tools: "도구",
                        file: "파일",
                        edit: "편집",
                        view: "보기",
                        insert: "삽입",
                        undo: "실행 취소",
                        redo: "다시 실행",
                        history: "기록",
                        share: "공유",
                        more: "더보기",
                        search: "검색",
                        create: "생성",
                        project: "프로젝트",
                        projects: "프로젝트",
                        sort: "정렬",
                        filter: "필터",
                        apply: "적용",
                        cancel: "취소",
                        name: "이름",
                        type: "유형",
                        created: "생성됨",
                        modified: "수정됨",
                        details: "세부정보",
                        delete: "삭제",
                        confirm: "확인",
                        permanentDelete: "영구 삭제",
                        print: "인쇄",
                        download: "다운로드",
                        downloadTxt: "TXT로 다운로드",
                        downloadMd: "Markdown으로 다운로드",
                        downloadCsv: "CSV로 다운로드",
                        downloadXlsx: "XLSX로 다운로드",
                        copy: "복사",
                        paste: "붙여넣기",
                        cut: "잘라내기",
                        selectAll: "전체 선택",
                        find: "찾기",
                        replace: "바꾸기",
                        replaceAll: "모두 바꾸기",
                        wordCount: "단어 수",
                        characters: "문자 수",
                        size: "크기",
                        fontFamily: "글꼴",
                        fontSize: "글꼴 크기",
                        alignLeft: "왼쪽 정렬",
                        alignCenter: "가운데 정렬",
                        alignRight: "오른쪽 정렬",
                        alignTop: "위쪽 정렬",
                        alignMiddle: "중앙 정렬",
                        alignBottom: "아래쪽 정렬",
                        bold: "굵게",
                        italic: "기울임꼴",
                        underline: "밑줄",
                        strike: "취소선",
                        checklist: "체크리스트",
                        quote: "인용",
                        hr: "수평선",
                        link: "링크",
                        image: "이미지",
                        video: "비디오",
                        table: "테이블",
                        dropdown: "드롭다운",
                        toc: "목차",
                        code: "코드 블록",
                        makeCopy: "복사본 만들기",
                        rename: "이름 변경",
                        version: "버전 기록",
                        fullscreen: "전체 화면",
                        zoomIn: "확대",
                        zoomOut: "축소",
                        resetZoom: "확대/축소 초기화",
                        addPage: "페이지 추가",
                        removePage: "페이지 제거",
                        info: "정보",
                        contact: "연락처",
                        requestFeature: "기능 요청",
                        reportBug: "버그 신고",
                        keyboardShortcuts: "키보드 단축키",
                        autocorrect: "자동 교정",
                        directany: "Directany",
                        compareDocs: "문서 비교",
                        autoSave: "자동 저장",
                        default: "기본값",
                        options: "옵션",
                        actions: "작업",
                        open: "열기",
                        closeWindow: "창 닫기",
                        error: "오류",
                        success: "성공",
                        warning: "경고",
                        infoMsg: "정보",
                        noFiles: "파일이 없습니다.",
                        welcome: "환영합니다",
                        searchProjects: "프로젝트 검색...",
                        sortBy: "정렬 기준",
                        filterByType: "유형별 필터",
                        system: "시스템",
                        light: "라이트",
                        dark: "다크",
                        docsSuite: "Munetios Docs Suite",
                        spreadsheetSuite: "Munetios Spreadsheet Suite",
                        journalSuite: "Munetios Journal Suite"
                    },
                    tr: {
                        settings: "Ayarlar",
                        darkMode: "Karanlık Mod",
                        systemTheme: "Sistem Teması",
                        lightMode: "Aydınlık Mod",
                        language: "Dil",
                        defaultFont: "Varsayılan Yazı Tipi",
                        docs: "Belgeler",
                        spreadsheet: "Hesap Tablosu",
                        journal: "Günlük",
                        save: "Kaydet",
                        close: "Kapat",
                        help: "Yardım",
                        tools: "Araçlar",
                        file: "Dosya",
                        edit: "Düzenle",
                        view: "Görünüm",
                        insert: "Ekle",
                        undo: "Geri Al",
                        redo: "Yinele",
                        history: "Geçmiş",
                        share: "Paylaş",
                        more: "Daha Fazla",
                        search: "Ara",
                        create: "Oluştur",
                        project: "Proje",
                        projects: "Projeler",
                        sort: "Sırala",
                        filter: "Filtrele",
                        apply: "Uygula",
                        cancel: "İptal",
                        name: "Ad",
                        type: "Tür",
                        created: "Oluşturuldu",
                        modified: "Değiştirildi",
                        details: "Detaylar",
                        delete: "Sil",
                        confirm: "Onayla",
                        permanentDelete: "Kalıcı olarak sil",
                        print: "Yazdır",
                        download: "İndir",
                        downloadTxt: "TXT olarak indir",
                        downloadMd: "Markdown olarak indir",
                        downloadCsv: "CSV olarak indir",
                        downloadXlsx: "XLSX olarak indir",
                        copy: "Kopyala",
                        paste: "Yapıştır",
                        cut: "Kes",
                        selectAll: "Tümünü seç",
                        find: "Bul",
                        replace: "Değiştir",
                        replaceAll: "Tümünü değiştir",
                        wordCount: "Kelime Sayısı",
                        characters: "Karakterler",
                        size: "Boyut",
                        fontFamily: "Yazı Tipi",
                        fontSize: "Yazı Tipi Boyutu",
                        alignLeft: "Sola hizala",
                        alignCenter: "Ortala",
                        alignRight: "Sağa hizala",
                        alignTop: "Yukarı hizala",
                        alignMiddle: "Ortaya hizala",
                        alignBottom: "Aşağıya hizala",
                        bold: "Kalın",
                        italic: "İtalik",
                        underline: "Altı çizili",
                        strike: "Üstü çizili",
                        checklist: "Kontrol listesi",
                        quote: "Alıntı",
                        hr: "Yatay çizgi",
                        link: "Bağlantı",
                        image: "Resim",
                        video: "Video",
                        table: "Tablo",
                        dropdown: "Açılır Menü",
                        toc: "İçindekiler",
                        code: "Kod Bloğu",
                        makeCopy: "Kopyasını oluştur",
                        rename: "Yeniden adlandır",
                        version: "Sürüm Geçmişi",
                        fullscreen: "Tam ekran",
                        zoomIn: "Yakınlaştır",
                        zoomOut: "Uzaklaştır",
                        resetZoom: "Yakınlaştırmayı sıfırla",
                        addPage: "Sayfa ekle",
                        removePage: "Sayfa kaldır",
                        info: "Bilgi",
                        contact: "İletişim",
                        requestFeature: "Özellik iste",
                        reportBug: "Hata bildir",
                        keyboardShortcuts: "Klavye Kısayolları",
                        autocorrect: "Otomatik Düzeltici",
                        directany: "Directany",
                        compareDocs: "Belgeleri karşılaştır",
                        autoSave: "Otomatik Kaydet",
                        default: "Varsayılan",
                        options: "Seçenekler",
                        actions: "Eylemler",
                        open: "Aç",
                        closeWindow: "Pencereyi kapat",
                        error: "Hata",
                        success: "Başarılı",
                        warning: "Uyarı",
                        infoMsg: "Bilgi",
                        noFiles: "Dosya bulunamadı.",
                        welcome: "Hoş geldiniz",
                        searchProjects: "Projeleri ara...",
                        sortBy: "Sırala",
                        filterByType: "Türe göre filtrele",
                        system: "Sistem",
                        light: "Aydınlık",
                        dark: "Karanlık",
                        docsSuite: "Munetios Docs Suite",
                        spreadsheetSuite: "Munetios Spreadsheet Suite",
                        journalSuite: "Munetios Journal Suite"
                    },
                    ar: {
                        settings: "الإعدادات",
                        darkMode: "الوضع الداكن",
                        systemTheme: "سمة النظام",
                        lightMode: "الوضع الفاتح",
                        language: "اللغة",
                        defaultFont: "الخط الافتراضي",
                        docs: "المستندات",
                        spreadsheet: "جدول البيانات",
                        journal: "اليومية",
                        save: "حفظ",
                        close: "إغلاق",
                        help: "مساعدة",
                        tools: "أدوات",
                        file: "ملف",
                        edit: "تحرير",
                        view: "عرض",
                        insert: "إدراج",
                        undo: "تراجع",
                        redo: "إعادة",
                        history: "السجل",
                        share: "مشاركة",
                        more: "المزيد",
                        search: "بحث",
                        create: "إنشاء",
                        project: "مشروع",
                        projects: "مشاريع",
                        sort: "ترتيب",
                        filter: "تصفية",
                        apply: "تطبيق",
                        cancel: "إلغاء",
                        name: "الاسم",
                        type: "النوع",
                        created: "تاريخ الإنشاء",
                        modified: "تاريخ التعديل",
                        details: "تفاصيل",
                        delete: "حذف",
                        confirm: "تأكيد",
                        permanentDelete: "حذف نهائي",
                        print: "طباعة",
                        download: "تنزيل",
                        downloadTxt: "تنزيل كـ TXT",
                        downloadMd: "تنزيل كـ Markdown",
                        downloadCsv: "تنزيل كـ CSV",
                        downloadXlsx: "تنزيل كـ XLSX",
                        copy: "نسخ",
                        paste: "لصق",
                        cut: "قص",
                        selectAll: "تحديد الكل",
                        find: "بحث",
                        replace: "استبدال",
                        replaceAll: "استبدال الكل",
                        wordCount: "عدد الكلمات",
                        characters: "الأحرف",
                        size: "الحجم",
                        fontFamily: "نوع الخط",
                        fontSize: "حجم الخط",
                        alignLeft: "محاذاة لليسار",
                        alignCenter: "محاذاة للوسط",
                        alignRight: "محاذاة لليمين",
                        alignTop: "محاذاة للأعلى",
                        alignMiddle: "محاذاة للوسط",
                        alignBottom: "محاذاة للأسفل",
                        bold: "عريض",
                        italic: "مائل",
                        underline: "تحته خط",
                        strike: "يتوسطه خط",
                        checklist: "قائمة التحقق",
                        quote: "اقتباس",
                        hr: "خط أفقي",
                        link: "رابط",
                        image: "صورة",
                        video: "فيديو",
                        table: "جدول",
                        dropdown: "قائمة منسدلة",
                        toc: "جدول المحتويات",
                        code: "كتلة كود",
                        makeCopy: "إنشاء نسخة",
                        rename: "إعادة تسمية",
                        version: "سجل الإصدارات",
                        fullscreen: "ملء الشاشة",
                        zoomIn: "تكبير",
                        zoomOut: "تصغير",
                        resetZoom: "إعادة ضبط التكبير",
                        addPage: "إضافة صفحة",
                        removePage: "إزالة صفحة",
                        info: "معلومات",
                        contact: "اتصال",
                        requestFeature: "طلب ميزة",
                        reportBug: "الإبلاغ عن خطأ",
                        keyboardShortcuts: "اختصارات لوحة المفاتيح",
                        autocorrect: "تصحيح تلقائي",
                        directany: "Directany",
                        compareDocs: "مقارنة المستندات",
                        autoSave: "حفظ تلقائي",
                        default: "افتراضي",
                        options: "خيارات",
                        actions: "إجراءات",
                        open: "فتح",
                        closeWindow: "إغلاق النافذة",
                        error: "خطأ",
                        success: "نجاح",
                        warning: "تحذير",
                        infoMsg: "معلومات",
                        noFiles: "لم يتم العثور على ملفات.",
                        welcome: "مرحبًا",
                        searchProjects: "بحث عن مشاريع...",
                        sortBy: "ترتيب حسب",
                        filterByType: "تصفية حسب النوع",
                        system: "النظام",
                        light: "فاتح",
                        dark: "داكن",
                        docsSuite: "Munetios Docs Suite",
                        spreadsheetSuite: "Munetios Spreadsheet Suite",
                        journalSuite: "Munetios Journal Suite"
                    }
                };
                function t(key) {
                    const currentLang = window._munetios_lang || lang;
                    return (translations[currentLang] && translations[currentLang][key]) || translations['en'][key] || key;
                }
                // Get current settings
                const theme = localStorage.getItem('munetios_theme') || 'system';
                const defaultFontDocs = localStorage.getItem('munetios_font_docs') || 'Lexend,sans-serif';
                const defaultFontSheet = localStorage.getItem('munetios_font_sheet') || 'Lexend,sans-serif';
                const defaultFontJournal = localStorage.getItem('munetios_font_journal') || 'Lexend,sans-serif';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width:480px;">
                        <h3>${t('settings')}</h3>
                        <div style="margin-bottom:18px;">
                            <label style="display:block;margin-bottom:8px;">${t('darkMode')}:</label>
                            <select id="themeSelect" style="width:100%;padding:8px;border-radius:8px;">
                                <option value="system" ${theme==='system'?'selected':''}>${t('systemTheme')}</option>
                                <option value="light" ${theme==='light'?'selected':''}>${t('lightMode')}</option>
                                <option value="dark" ${theme==='dark'?'selected':''}>${t('darkMode')}</option>
                            </select>
                        </div>
                        <div style="margin-bottom:18px;">
                            <label style="display:block;margin-bottom:8px;">${t('language')}:</label>
                            <select id="langSelect" style="width:100%;padding:8px;border-radius:8px;">
                                <option value="en" ${lang==='en'?'selected':''}>English</option>
                                <option value="es" ${lang==='es'?'selected':''}>Español</option>
                                <option value="fr" ${lang==='fr'?'selected':''}>Français</option>
                                <option value="de" ${lang==='de'?'selected':''}>Deutsch</option>
                                <option value="it" ${lang==='it'?'selected':''}>Italiano</option>
                                <option value="pt" ${lang==='pt'?'selected':''}>Português</option>
                                <option value="ru" ${lang==='ru'?'selected':''}>Русский</option>
                                <option value="zh" ${lang==='zh'?'selected':''}>中文</option>
                                <option value="ja" ${lang==='ja'?'selected':''}>日本語</option>
                                <option value="ko" ${lang==='ko'?'selected':''}>한국어</option>
                                <option value="tr" ${lang==='tr'?'selected':''}>Türkçe</option>
                                <option value="ar" ${lang==='ar'?'selected':''}>العربية</option>
                            </select>
                        </div>
                        <div style="margin-bottom:18px;">
                            <label style="display:block;margin-bottom:8px;">${t('defaultFont')} (${t('docs')}):</label>
                            <input type="text" id="fontDocs" value="${defaultFontDocs}" style="width:100%;padding:8px;border-radius:8px;">
                        </div>
                        <div style="margin-bottom:18px;">
                            <label style="display:block;margin-bottom:8px;">${t('defaultFont')} (${t('spreadsheet')}):</label>
                            <input type="text" id="fontSheet" value="${defaultFontSheet}" style="width:100%;padding:8px;border-radius:8px;">
                        </div>
                        <div style="margin-bottom:18px;">
                            <label style="display:block;margin-bottom:8px;">${t('defaultFont')} (${t('journal')}):</label>
                            <input type="text" id="fontJournal" value="${defaultFontJournal}" style="width:100%;padding:8px;border-radius:8px;">
                        </div>
                        <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                            <button class="btn" id="closeSettings">${t('close')}</button>
                            <button class="btn" id="saveSettings">${t('save')}</button>
                        </div>
                    </div>
                `;
                modal.classList.add('active');
                // Defensive: check if elements exist before adding event listeners
                const closeSettingsBtn = document.getElementById('closeSettings');
                if (closeSettingsBtn) closeSettingsBtn.onclick = () => modal.classList.remove('active');
                const saveSettingsBtn = document.getElementById('saveSettings');
                if (saveSettingsBtn) saveSettingsBtn.onclick = function () {
                    localStorage.setItem('munetios_theme', document.getElementById('themeSelect').value);
                    localStorage.setItem('munetios_lang', document.getElementById('langSelect').value);
                    localStorage.setItem('munetios_font_docs', document.getElementById('fontDocs').value);
                    localStorage.setItem('munetios_font_sheet', document.getElementById('fontSheet').value);
                    localStorage.setItem('munetios_font_journal', document.getElementById('fontJournal').value);
                    window._munetios_lang = document.getElementById('langSelect').value;
                    applyTheme();
                    modal.classList.remove('active');
                    showToast(t('success'), 'success');
                    updateAllUIText();
                };
                // Apply theme immediately
                function applyTheme() {
                    const theme = localStorage.getItem('munetios_theme') || 'system';
                    if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                        document.body.classList.add('dark-mode');
                        document.body.classList.remove('light-mode');
                    } else {
                        document.body.classList.remove('dark-mode');
                        document.body.classList.add('light-mode');
                    }
                    if (document.body.classList.contains('light-mode')) {
                        document.body.style.background = '#f6f6fa';
                        document.body.style.color = '#222';
                    } else {
                        document.body.style.background = '#18122B';
                        document.body.style.color = '#fff';
                    }
                }
                applyTheme();
                // Listen for system theme changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyTheme);
                // Apply default fonts globally (for new docs, sheets, journals)
                window._munetios_default_fonts = {
                    docs: document.getElementById('fontDocs') ? document.getElementById('fontDocs').value : defaultFontDocs,
                    sheet: document.getElementById('fontSheet') ? document.getElementById('fontSheet').value : defaultFontSheet,
                    journal: document.getElementById('fontJournal') ? document.getElementById('fontJournal').value : defaultFontJournal
                };

                // Update all UI text to selected language
                function updateAllUIText() {
                    window._munetios_lang = localStorage.getItem('munetios_lang') || navigator.language.slice(0,2) || 'en';
                    // Update static labels/buttons
                    document.querySelectorAll('[data-i18n]').forEach(el => {
                        const key = el.getAttribute('data-i18n');
                        if (key && t(key)) el.textContent = t(key);
                    });
                    // Update modal if open
                    if (modal.classList.contains('active')) {
                        // Optionally re-render modal content if needed
                    }
                    // Update placeholders
                    const placeholders = [
                        ['searchInput', 'searchProjects'],
                        ['mobileSearchInput', 'searchProjects'],
                        ['editorSearchInput', 'find'],
                        ['journalSearchInput', 'find'],
                        ['sheetSearchInput', 'find']
                    ];
                    placeholders.forEach(([id, key]) => {
                        const input = document.getElementById(id);
                        if (input) input.placeholder = t(key);
                    });
                }
                updateAllUIText();

                // On language change, update UI immediately
                const langSelect = document.getElementById('langSelect');
                if (langSelect) langSelect.onchange = updateAllUIText;

            // On page load, apply theme and language
            (function(){
                const theme = localStorage.getItem('munetios_theme') || 'system';
                if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.body.classList.add('dark-mode');
                    document.body.classList.remove('light-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                    document.body.classList.add('light-mode');
                }
                if (document.body.classList.contains('light-mode')) {
                    document.body.style.background = '#f6f6fa';
                    document.body.style.color = '#222';
                } else {
                    document.body.style.background = '#18122B';
                    document.body.style.color = '#fff';
                }
                window._munetios_lang = localStorage.getItem('munetios_lang') || navigator.language.slice(0,2) || 'en';
                updateAllUIText && updateAllUIText();
            })();
        };
            // Add this before using showToast
            function showToast(msg, duration = 2200) {
                let toast = document.createElement('div');
                toast.textContent = msg;
                toast.style.position = 'fixed';
                toast.style.bottom = '32px';
                toast.style.left = '50%';
                toast.style.transform = 'translateX(-50%)';
                toast.style.padding = '12px 24px';
                toast.style.borderRadius = '24px';
                toast.style.fontSize = '16px';
                toast.style.zIndex = '9999';
                toast.style.color = '#fff';
                toast.style.background = '#590691';
                toast.style.boxShadow = '0 8px 32px 0 rgba(31,38,135,0.18)';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), duration);
            }
            
                        document.getElementById('helpBtn').onclick = function() {
                            showToast('Welcome to 97529 office! To use the app, click "Create" to start a new project. Use the search bar to find your projects quickly. Access additional features through the top-right buttons. Enjoy your productivity experience!', 10000);
                        }
            
            document.getElementById('appsBtn').onclick = function () {
                let wrapper = document.querySelector('.apps-wrapper');
                if (wrapper) {
                    if (wrapper.style.display === 'block') {
                        wrapper.style.display = 'none';
                    } else {
                        wrapper.style.display = 'block';
                        // Close when clicking outside
                        function closeApps(ev) {
                            if (!wrapper.contains(ev.target) && ev.target !== document.getElementById('appsBtn')) {
                                wrapper.style.display = 'none';
                                document.removeEventListener('mousedown', closeApps);
                            }
                        }
                        document.addEventListener('mousedown', closeApps);
                    }
                }
            };
               
            document.getElementById('mobileSearchIcon').onclick = function () {
                let existingBar = document.getElementById('mobileFloatingSearchBar');
                if (existingBar) {
                    existingBar.style.display = 'flex';
                    document.getElementById('mobileSearchInput').focus();
                    return;
                }
                let searchBar = document.createElement('div');
                searchBar.id = 'mobileFloatingSearchBar';
                searchBar.style.position = 'fixed';
                searchBar.style.top = '0';
                searchBar.style.left = '0';
                searchBar.style.width = '100vw';
                searchBar.style.height = '64px';
                searchBar.style.background = '#18122B';
                searchBar.style.zIndex = '9999';
                searchBar.style.boxShadow = '0 2px 12px rgba(31,38,135,0.10)';
                searchBar.style.display = 'flex';
                searchBar.style.alignItems = 'center';
                searchBar.style.justifyContent = 'space-between';
                searchBar.style.padding = '0 18px';
                searchBar.innerHTML = `
                    <input type="text" id="mobileSearchInput" placeholder="Search projects..." style="flex:1;padding:12px 18px;border-radius:18px;border:1px solid #590691;font-size:16px;margin-right:12px;background:#12092b;color:#fff;">
                    <button class="btn" id="closeMobileSearchBar" style="padding:8px 18px;font-size:18px;background:#12092b;color:#fff;border:none;">&#10005;</button>
                `;
                document.body.appendChild(searchBar);
                document.getElementById('mobileSearchInput').focus();
                document.getElementById('closeMobileSearchBar').onclick = function () {
                    searchBar.style.display = 'none';
                    renderProjects();
                };
                document.getElementById('mobileSearchInput').oninput = function () {
                    const query = this.value.trim().toLowerCase();
                    openDB().then(db => {
                        const tx = db.transaction(STORE_NAME, 'readonly');
                        const store = tx.objectStore(STORE_NAME);
                        const req = store.getAll();
                        req.onsuccess = function (ev) {
                            const items = ev.target.result || [];
                            let filtered = items;
                            if (query) {
                                filtered = items.filter(item =>
                                    decrypt(item.name).toLowerCase().includes(query) ||
                                    decrypt(item.type).toLowerCase().includes(query)
                                );
                            }
                            filesList.innerHTML = filtered.length
                                ? filtered.map(item => `
                                    <div class="liquid-glass" style="padding:16px;margin-bottom:12px;border-radius:24px;">
                                        <strong>${decrypt(item.name)}</strong>
                                        <span style="margin-left:8px;">(${decrypt(item.type)})</span>
                                        <span style="float:right;color:#888;font-size:12px;">${new Date(decrypt(item.created)).toLocaleString()}</span>
                                    </div>
                                `).join('')
                                : `<p>No files found.</p>`;
                        };
                    });
                };
            };
            
        </script>
        <div class="content">
             <h2>Your Projects</h2>
             <div id="filesList">
                <p>Welcome to Munetios Docs Suite so you can manage your projects and files. to create one, click the "Create" button.</p>
             </div>
        </div>
    </div>
        <div class="editor-screen">
            <div class="topbar">
                <div class="top-left">
                    <div class="menu-btn">
                        <button aria-label="Go Back menu" title="Menu" class="liquid-glass btn" id="GoBackMenuBtn">
                            <svg width="28" height="28" viewBox="0 0 28 28" fill="none" aria-hidden="true">
                                <rect y="7" width="28" height="3" rx="1.5" fill="currentColor"/>
                                <rect y="14" width="28" height="3" rx="1.5" fill="currentColor"/>
                                <rect y="21" width="28" height="3" rx="1.5" fill="currentColor"/>
                            </svg>
                        </button>
                    </div>
                    <div class="menu-bar">
                        <button class="btn" id="editorFile">File</button>
                        <button class="btn" id="editorEdit">Edit</button>
                        <button class="btn" id="editorView">View</button>
                        <button class="btn" id="editorInsert">Insert</button>
                        <!-- format and tools-->
    
                        <button class="btn" id="editorTools">Tools</button>
                        <button class="btn" id="editorHelp">Help</button>
                    </div>
                </div>

                <div class="topbar-right">
                    <button title="Search" aria-label="Search" class="liquid-glass btn" id="editorSearchBtn">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" aria-hidden="true">
                            <circle cx="9" cy="9" r="7" stroke="currentColor" stroke-width="2"/>
                            <line x1="13.6569" y1="13.6569" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                    <div class="top-right">
                    <button title="Undo" aria-label="Undo" class="liquid-glass btn" id="editorUndoBtn">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" aria-hidden="true">
                            <path d="M7 7L3 10L7 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M3 10H12C14.2091 10 16 11.7909 16 14C16 16.2091 14.2091 18 12 18H8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                    <button title="Redo" aria-label="Redo" class="liquid-glass btn" id="editorRedoBtn">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" aria-hidden="true">
                            <path d="M13 13L17 10L13 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M17 10H8C5.79086 10 4 11.7909 4 14C4 16.2091 5.79086 18 8 18H12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                    <button title="History" aria-label="History" class="liquid-glass btn" id="editorHistoryBtn">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" aria-hidden="true">
                            <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2"/>
                            <path d="M10 6V10L13 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                    <button title="Share" aria-label="Share" class="liquid-glass btn" id="editorShareBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="margin-right:6px;">
                            <circle cx="18" cy="5" r="3" stroke="currentColor" stroke-width="2" fill="none"/>
                            <circle cx="6" cy="12" r="3" stroke="currentColor" stroke-width="2" fill="none"/>
                            <circle cx="18" cy="19" r="3" stroke="currentColor" stroke-width="2" fill="none"/>
                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <span class="create-label">Share</span>
                    </button>
               
                    <button title="More Options" aria-label="More options" class="liquid-glass btn" id="editorMoreBtn">
                        <svg width="20" height="20" viewBox="0 0 28 28" fill="none" aria-hidden="true">
                            <circle cx="14" cy="5" r="3" fill="currentColor"/>
                            <circle cx="14" cy="14" r="3" fill="currentColor"/>
                            <circle cx="14" cy="23" r="3" fill="currentColor"/>
                        </svg>
                    </button>
                    </div> 
                </div>
            </div>
            <div class="editor-content" id="editorContent"></div>
        </div>

        <div class="modal" id="modalUIRender"></div>
        <div class="context-wrapper" id="contextwrapperRender"></div>
        <script>
            function renderDocumentEditor(project) {
                // Toolbar HTML
                const toolbarHTML = `
                    <div class="toolbar" id="docToolbar" style=" overflow-x:auto; gap:8px; white-space:nowrap; scrollbar-width:thin;">
                        <div class="toolbar-group" style="display:inline-flex;">
                            <button title="Resize Page" id="resizeBtn">
                                <svg width="22" height="22" viewBox="0 0 22 22"><rect x="3" y="3" width="16" height="16" rx="2" stroke="currentColor" stroke-width="2"/><path d="M3 3L19 19" stroke="currentColor" stroke-width="2"/></svg>
                            </button>
                            <input type="color" id="bgColorPicker" title="Document Background Color" style="width:32px;height:32px;border:none;background:none;">
                        </div>
                        <div class="toolbar-group" style="display:inline-flex;">
                            <button title="Bold" id="boldBtn"><svg width="22" height="22" viewBox="0 0 22 22"><text x="4" y="17" font-family="Arial" font-size="16" font-weight="bold" fill="currentColor">B</text></svg></button>
                            <button title="Italic" id="italicBtn"><svg width="22" height="22" viewBox="0 0 22 22"><text x="4" y="17" font-family="Arial" font-size="16" font-style="italic" fill="currentColor">I</text></svg></button>
                            <button title="Underline" id="underlineBtn"><svg width="22" height="22" viewBox="0 0 22 22"><text x="4" y="17" font-family="Arial" font-size="16" fill="currentColor">U</text><line x1="4" y1="19" x2="18" y2="19" stroke="currentColor" stroke-width="2"/></svg></button>
                            <button title="Strikethrough" id="strikeBtn"><svg width="22" height="22" viewBox="0 0 22 22"><text x="4" y="17" font-family="Arial" font-size="16" fill="currentColor">S</text><line x1="4" y1="12" x2="18" y2="12" stroke="currentColor" stroke-width="2"/></svg></button>
                            <input type="color" id="textColorPicker" title="Text Color" style="width:32px;height:32px;border:none;background:none;">
                            <select id="fontFamilyPicker" title="Font Family" style="margin-left:8px;padding:6px 12px;border-radius:12px;border:1px solid #ccc;background:#fff;">
                                <option value="Lexend" style="font-family:Lexend,sans-serif;">Lexend</option>
                                <option value="Arial" style="font-family:Arial,sans-serif;">Arial</option>
                                <option value="Calibri" style="font-family:Calibri,sans-serif;">Calibri</option>
                                <option value="Comic Sans MS" style="font-family:'Comic Sans MS',cursive;">Comic Sans</option>
                                <option value="Consolas" style="font-family:Consolas,monospace;">Consolas</option>
                                <option value="Courier New" style="font-family:'Courier New',monospace;">Courier New</option>
                                <option value="Georgia" style="font-family:Georgia,serif;">Georgia</option>
                                <option value="Georgia Pro" style="font-family:'Georgia Pro',serif;">Georgia Pro</option>
                                <option value="Impact" style="font-family:Impact,sans-serif;">Impact</option>
                                <option value="Microsoft Sans Serif" style="font-family:'Microsoft Sans Serif',sans-serif;">Microsoft Sans</option>
                                <option value="Noto Sans" style="font-family:'Noto Sans',sans-serif;">Noto Sans</option>
                                <option value="Noto Serif" style="font-family:'Noto Serif',serif;">Noto Serif</option>
                                <option value="Open Sans" style="font-family:'Open Sans',sans-serif;">Open Sans</option>
                                <option value="Poppins" style="font-family:Poppins,sans-serif;">Poppins</option>
                                <option value="Roboto" style="font-family:Roboto,sans-serif;">Roboto</option>
                                <option value="Segoe UI" style="font-family:'Segoe UI',sans-serif;">Segoe UI</option>
                                <option value="Times New Roman" style="font-family:'Times New Roman',serif;">Times New Roman</option>
                            </select>
                            <input id="fontSizeInput" type="number" min="8" max="72" value="16" title="Font Size" style="margin-left:8px;width:56px;padding:6px 12px;border-radius:12px;border:1px solid #ccc;background:#fff;">
                        </div>
                        <div class="toolbar-group" style="display:inline-flex;">
                            <button title="Align Left" id="alignLeftBtn"><svg width="22" height="22" viewBox="0 0 22 22"><rect x="4" y="6" width="14" height="2" fill="currentColor"/><rect x="4" y="10" width="10" height="2" fill="currentColor"/><rect x="4" y="14" width="14" height="2" fill="currentColor"/></svg></button>
                            <button title="Align Center" id="alignCenterBtn"><svg width="22" height="22" viewBox="0 0 22 22"><rect x="4" y="6" width="14" height="2" fill="currentColor"/><rect x="7" y="10" width="8" height="2" fill="currentColor"/><rect x="4" y="14" width="14" height="2" fill="currentColor"/></svg></button>
                            <button title="Align Right" id="alignRightBtn"><svg width="22" height="22" viewBox="0 0 22 22"><rect x="4" y="6" width="14" height="2" fill="currentColor"/><rect x="8" y="10" width="10" height="2" fill="currentColor"/><rect x="4" y="14" width="14" height="2" fill="currentColor"/></svg></button>
                        </div>
                        <div class="toolbar-group" style="display:inline-flex;">
                            <button title="Bulleted List" id="bulletedBtn"><svg width="22" height="22" viewBox="0 0 22 22"><circle cx="6" cy="7" r="2" fill="currentColor"/><rect x="10" y="6" width="8" height="2" fill="currentColor"/><circle cx="6" cy="15" r="2" fill="currentColor"/><rect x="10" y="14" width="8" height="2" fill="currentColor"/></svg></button>
                            <button title="Numbered List" id="numberedBtn"><svg width="22" height="22" viewBox="0 0 22 22"><text x="4" y="9" font-size="8" fill="currentColor">1.</text><rect x="10" y="6" width="8" height="2" fill="currentColor"/><text x="4" y="17" font-size="8" fill="currentColor">2.</text><rect x="10" y="14" width="8" height="2" fill="currentColor"/></svg></button>
                            <button title="Checklist" id="checklistBtn">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <polyline points="9 11 12 14 22 4"></polyline>
                                </svg>
                            </button>
                            <button title="Quote" id="quoteBtn">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <path d="M17 8h2a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2h-2v2"></path>
                                    <path d="M7 8h2a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2H7v2"></path>
                                </svg>
                            </button>
                            <button title="Horizontal Line" id="hrBtn"><svg width="22" height="22" viewBox="0 0 22 22"><rect x="4" y="11" width="14" height="2" fill="currentColor"/></svg></button>
                            <button title="Link" id="linkBtn">
                                <svg width="22" height="22" viewBox="0 0 22 22" fill="none">
                                    <path d="M8 14a4 4 0 0 1 0-8h3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    <path d="M14 8a4 4 0 0 1 0 8h-3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    <line x1="9" y1="11" x2="13" y2="11" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </button>
                            <button title="Image" id="imageBtn"><svg width="22" height="22" viewBox="0 0 22 22"><rect x="3" y="5" width="16" height="12" rx="2" stroke="currentColor" stroke-width="2"/><circle cx="8" cy="10" r="2" fill="currentColor"/><path d="M19 17l-5-6-4 5-3-4-4 5" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
                       
                            </div>
                        <div class="toolbar-group" style="display:inline-flex;">
                            <button title="Save" id="docSaveBtn"><svg width="22" height="22" viewBox="0 0 22 22"><rect x="3" y="3" width="16" height="16" rx="2" stroke="currentColor" stroke-width="2"/><path d="M7 3V8H15V3" stroke="currentColor" stroke-width="2"/><rect x="7" y="14" width="8" height="3" rx="1" fill="currentColor"/></svg></button>
                        </div>
                    </div>
                `;
                // Canvas HTML with pages wrapper and Add Page button
                const canvasHTML = `
                    <div id="docCanvasWrapper" style="display:flex;flex-direction:row;align-items:flex-start;min-height:calc(100vh - 160px);overflow-x:auto;overflow-y:hidden;padding:24px;scroll-behavior:smooth;gap:32px;">
                        <div id="docPages" style="display:flex;flex-direction:row;gap:32px;"></div>
                        <button id="addPageBtn" class="btn" style="margin-left:32px;align-self:flex-start;display:flex;align-items:center;gap:8px;position:sticky;left:0;top:24px;">
                            <svg width="22" height="22" viewBox="0 0 22 22"><rect x="9" y="4" width="4" height="14" rx="1" fill="currentColor"/><rect x="4" y="9" width="14" height="4" rx="1" fill="currentColor"/></svg>
                            Add Page
                        </button>
                    </div>
                `;
                document.querySelector('.editor-content').innerHTML = toolbarHTML + canvasHTML;
                document.querySelector('.editor-content').style.display = 'block';

                // Load document content if exists
                let docId = project.id;
                let docData = [];
                openDB().then(db => {
                    const tx = db.transaction(STORE_NAME, 'readonly');
                    const store = tx.objectStore(STORE_NAME);
                    store.get(docId).onsuccess = function(ev) {
                        const item = ev.target.result;
                        // Multi-page support: content is array or fallback to single string
                        if (item && item.content) {
                            try {
                                docData = JSON.parse(decrypt(item.content));
                                if (!Array.isArray(docData)) docData = [docData];
                            } catch {
                                docData = [decrypt(item.content)];
                            }
                        } else {
                            docData = [""];
                        }
                        renderPages();
                        if (item && item.bgColor) setAllPagesStyle('background', decrypt(item.bgColor));
                        if (item && item.width) setAllPagesStyle('width', decrypt(item.width));
                        if (item && item.height) setAllPagesStyle('height', decrypt(item.height));
                        if (item && item.fontFamily) setAllPagesStyle('fontFamily', decrypt(item.fontFamily));
                        if (item && item.fontSize) setAllPagesStyle('fontSize', decrypt(item.fontSize));
                        makeImagesResponsive();
                    };
                });
                document.getElementById('editorSearchBtn').onclick = function () {
                    // Create floating search bar (not modal)
                    let existingBar = document.getElementById('floatingEditorSearchBar');
                    if (existingBar) {
                        existingBar.style.display = 'block';
                        document.getElementById('editorSearchInput').focus();
                        return;
                    }
                    let searchBar = document.createElement('div');
                    searchBar.id = 'floatingEditorSearchBar';
                    searchBar.style.position = 'fixed';
                    searchBar.style.top = '100px';
                    searchBar.style.left = '50%';
                    searchBar.style.transform = 'translateX(-50%)';
                    searchBar.style.zIndex = '5000';
                    searchBar.style.background = 'rgba(255,255,255,0.95)';
                    searchBar.style.boxShadow = '0 8px 32px 0 rgba(31,38,135,0.18)';
                    searchBar.style.borderRadius = '24px';
                    searchBar.style.padding = '24px 24px 18px 24px';
                    searchBar.style.maxWidth = '400px';
                    searchBar.style.width = '100%';
                    searchBar.innerHTML = `
                        <div style="display:flex;align-items:center;justify-content:space-between;">
                            <h3 style="margin:0;">Search Document</h3>
                            <button class="btn" id="closeSearchBar" style="padding:4px 12px;font-size:18px;">&#10005;</button>
                        </div>
                        <input type="text" id="editorSearchInput" placeholder="Find text..." style="width:100%;padding:12px;border-radius:12px;margin:18px 0 0 0;">
                        <div id="editorSearchResult" style="margin-top:12px;color:#590691;"></div>
                    `;
                    document.body.appendChild(searchBar);
                    document.getElementById('editorSearchInput').focus();
                    document.getElementById('closeSearchBar').onclick = function () {
                        searchBar.style.display = 'none';
                        renderPages();
                    };
                    document.getElementById('editorSearchInput').oninput = function () {
                        const val = this.value;
                        let found = false;
                        let result = '';
                        if (!val) {
                            document.getElementById('editorSearchResult').textContent = '';
                            renderPages();
                            return;
                        }
                        docData.forEach((pageContent, idx) => {
                            if (pageContent.includes(val)) {
                                found = true;
                                let pageDiv = document.querySelectorAll('.docCanvasPage')[idx];
                                let html = pageContent.replace(new RegExp(val, 'gi'), match =>
                                    `<span style="background:#ffe066;color:#590691;">${match}</span>`
                                );
                                pageDiv.innerHTML = html;
                                result += `Found in page ${idx + 1}. `;
                            }
                        });
                        document.getElementById('editorSearchResult').textContent = found ? result : 'Not found';
                        if (!found) renderPages();
                    };
                };
                document.getElementById('editorUndoBtn').onclick = () => document.execCommand('undo');
                document.getElementById('editorRedoBtn').onclick = () => document.execCommand('redo');
                document.getElementById('editorView').onclick = function(e) {
                    e.stopPropagation();
                    const context = document.getElementById('contextwrapperRender');
                    context.innerHTML = `
                        <div style="position:absolute;top:${e.target.getBoundingClientRect().bottom+8}px;left:${e.target.getBoundingClientRect().left}px;z-index:4000;min-width:220px;">
                            <div style="padding:8px 0;">
                                <button style="width:100%;text-align:left;padding:10px 24px;background:none;border:none;font-size:16px;cursor:pointer;" id="ctxZoomIn">Zoom In</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;background:none;border:none;font-size:16px;cursor:pointer;" id="ctxZoomOut">Zoom Out</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;background:none;border:none;font-size:16px;cursor:pointer;" id="ctxResetZoom">Reset Zoom</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;background:none;border:none;font-size:16px;cursor:pointer;" id="ctxFullscreen">Fullscreen</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;background:none;border:none;font-size:16px;cursor:pointer;" id="ctxFind">Find</button>
                                <button style="padding:8px 24px;border-radius:18px;background:none;border:1px solid #590691;color:#590691;font-size:15px;cursor:pointer;" id="ctxCloseView">Close</button>
                            </div>
                        </div>
                    `;
                    context.style.display = 'block';
                    context.onclick = ev => ev.stopPropagation();

                    // Only show these options for Document type
                    if (project && decrypt(project.type) !== 'Document') {
                        context.innerHTML = `
                            <div style="position:absolute;top:${e.target.getBoundingClientRect().bottom+8}px;left:${e.target.getBoundingClientRect().left}px;z-index:4000;min-width:220px;">
                                <div style="padding:8px 0;">
                                    <button style="width:100%;text-align:left;padding:10px 24px;background:none;border:none;font-size:16px;cursor:pointer;" id="ctxFullscreen">Fullscreen</button>
                                    <button style="padding:8px 24px;border-radius:18px;background:none;border:1px solid #590691;color:#590691;font-size:15px;cursor:pointer;" id="ctxCloseView">Close</button>
                                </div>
                            </div>
                        `;
                    }

                    function closeContext(ev) {
                        if (!context.contains(ev.target)) {
                            context.style.display = 'none';
                            document.removeEventListener('mousedown', closeContext);
                        }
                    }
                    document.addEventListener('mousedown', closeContext);

                    document.getElementById('ctxCloseView').onclick = function() {
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                    };

                    // Zoom logic (Document only)
                    let zoomLevel = 1;
                    if (project && decrypt(project.type) === 'Document') {
                        function setZoom(level) {
                            zoomLevel = level;
                            document.getElementById('docPages').style.transform = `scale(${zoomLevel})`;
                            document.getElementById('docPages').style.transformOrigin = 'top center';
                        }
                        document.getElementById('ctxZoomIn').onclick = function() {
                            setZoom(Math.min(zoomLevel + 0.1, 2));
                            context.style.display = 'none';
                            document.removeEventListener('mousedown', closeContext);
                        };
                        document.getElementById('ctxZoomOut').onclick = function() {
                            setZoom(Math.max(zoomLevel - 0.1, 0.5));
                            context.style.display = 'none';
                            document.removeEventListener('mousedown', closeContext);
                        };
                        document.getElementById('ctxResetZoom').onclick = function() {
                            setZoom(1);
                            context.style.display = 'none';
                            document.removeEventListener('mousedown', closeContext);
                        };
                        // Find
                        document.getElementById('ctxFind').onclick = function() {
                            context.style.display = 'none';
                            document.removeEventListener('mousedown', closeContext);
                            document.getElementById('editorSearchBtn').click();
                        };
                    }

                    // Fullscreen (all types)
                    document.getElementById('ctxFullscreen').onclick = function() {
                        let wrapper = document.getElementById('docCanvasWrapper');
                        if (wrapper && wrapper.requestFullscreen) {
                            wrapper.requestFullscreen();
                        } else if (wrapper && wrapper.webkitRequestFullscreen) {
                            wrapper.webkitRequestFullscreen();
                        }
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                    };
                };
                document.getElementById('editorHelp').onclick = function(e) {
                    e.stopPropagation();
                    const context = document.getElementById('contextwrapperRender');
                    context.innerHTML = `
                        <div style="position:absolute;top:${e.target.getBoundingClientRect().bottom+8}px;left:${e.target.getBoundingClientRect().left}px;z-index:4000;min-width:260px;">
                            <div style="padding:8px 0;">
                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxContact">Contact</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxShortcuts">Keyboard Shortcuts</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxFeature">Request a Feature</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxBug">Report a Bug</button>
                                <button style="padding:8px 24px;border-radius:18px;background:none;border:1px solid #590691;color:#590691;font-size:15px;cursor:pointer;" id="ctxCloseHelp">Close</button>
                            </div>
                        </div>
                    `;
                    context.style.display = 'block';
                    context.onclick = ev => ev.stopPropagation();

                    function closeContext(ev) {
                        if (!context.contains(ev.target)) {
                            context.style.display = 'none';
                            document.removeEventListener('mousedown', closeContext);
                        }
                    }
                    document.addEventListener('mousedown', closeContext);

                    document.getElementById('ctxCloseHelp').onclick = function() {
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                    };

                    function openGmail(subject) {
                        window.open(`https://mail.google.com/mail/?view=cm&fs=1&to=minecraftgamer97529@gmail.com&su=${encodeURIComponent(subject)}`, '_blank');
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                    }

                    document.getElementById('ctxContact').onclick = function() {
                        openGmail('Contact Munetios Docs Suite');
                    };
                    document.getElementById('ctxFeature').onclick = function() {
                        openGmail('Request a Feature - Munetios Docs Suite');
                    };
                    document.getElementById('ctxBug').onclick = function() {
                        openGmail('Report a Bug - Munetios Docs Suite');
                    };
                    document.getElementById('ctxShortcuts').onclick = function() {
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                        modal.innerHTML = `
                            <div class="modal-content" style="max-width:600px;">
                                <h3>Keyboard Shortcuts</h3>
                                <div style="max-height:400px;overflow:auto;">
                                    <table style="width:100%;border-collapse:collapse;">
                                        <thead>
                                            <tr>
                                                <th style="text-align:left;padding:8px;">Shortcut</th>
                                                <th style="text-align:left;padding:8px;">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${[
                                                ['Ctrl + S', 'Save document'],
                                                ['Ctrl + Z', 'Undo'],
                                                ['Ctrl + Y', 'Redo'],
                                                ['Ctrl + B', 'Bold'],
                                                ['Ctrl + I', 'Italic'],
                                                ['Ctrl + U', 'Underline'],
                                                ['Ctrl + Shift + S', 'Strikethrough'],
                                                ['Ctrl + Shift + C', 'Copy'],
                                                ['Ctrl + Shift + V', 'Paste'],
                                                ['Ctrl + Shift + X', 'Cut'],
                                                ['Ctrl + Shift + F', 'Find'],
                                                ['Ctrl + Shift + H', 'Replace'],
                                                ['Ctrl + Shift + L', 'Insert Link'],
                                                ['Ctrl + Shift + Q', 'Insert Quote'],
                                                ['Ctrl + Shift + T', 'Insert Table'],
                                                ['Ctrl + Shift + D', 'Insert Dropdown'],
                                                ['Ctrl + Shift + O', 'Insert Ordered List'],
                                                ['Ctrl + Shift + U', 'Insert Unordered List'],
                                                ['Ctrl + Shift + M', 'Insert Image'],
                                                ['Ctrl + Shift + R', 'Insert Horizontal Line'],
                                                ['Ctrl + Shift + E', 'Align Center'],
                                                ['Ctrl + Shift + L', 'Align Left'],
                                                ['Ctrl + Shift + G', 'Align Right'],
                                                ['Ctrl + Shift + P', 'Print'],
                                                ['Ctrl + Shift + N', 'New Document'],
                                                ['Ctrl + Shift + A', 'Select All'],
                                                ['Ctrl + Shift + W', 'Word Count'],
                                                ['Ctrl + Shift + V', 'Version History'],
                                                ['Ctrl + Shift + S', 'Share'],
                                                ['Ctrl + Shift + B', 'Report Bug'],
                                                ['Ctrl + Shift + F', 'Request Feature'],
                                                ['Ctrl + Shift + K', 'Keyboard Shortcuts'],
                                                ['Ctrl + Shift + C', 'Contact'],
                                                ['Ctrl + Shift + Z', 'Zoom In'],
                                                ['Ctrl + Shift + X', 'Zoom Out'],
                                                ['Ctrl + Shift + 0', 'Reset Zoom'],
                                                ['Ctrl + Shift + F11', 'Fullscreen'],
                                                ['Ctrl + Shift + H', 'Help'],
                                                ['Ctrl + Shift + D', 'Document Details'],
                                                ['Ctrl + Shift + R', 'Rename Document'],
                                                ['Ctrl + Shift + Del', 'Delete Document'],
                                                ['Ctrl + Shift + Plus', 'Add Page'],
                                                ['Ctrl + Shift + Minus', 'Remove Page'],
                                                ['Ctrl + Shift + S', 'Save'],
                                                ['Ctrl + Shift + Q', 'Quick Actions'],
                                                ['Ctrl + Shift + T', 'Tools'],
                                                ['Ctrl + Shift + V', 'View'],
                                                ['Ctrl + Shift + E', 'Edit'],
                                                ['Ctrl + Shift + F', 'File'],
                                                ['Ctrl + Shift + H', 'Home'],
                                                ['Ctrl + Shift + J', 'Journal'],
                                                ['Ctrl + Shift + P', 'Presentation'],
                                                ['Ctrl + Shift + S', 'Spreadsheet']
                                            ].map(([k, v]) => `<tr><td style="padding:6px 8px;">${k}</td><td style="padding:6px 8px;">${v}</td></tr>`).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                <button class="btn" style="margin-top:18px;" id="closeShortcuts">Close</button>
                            </div>
                        `;
                        modal.classList.add('active');
                        document.getElementById('closeShortcuts').onclick = () => modal.classList.remove('active');
                    };

                    // Keyboard shortcuts handler
                    if (!window._munetiosShortcutsAdded) {
                        window._munetiosShortcutsAdded = true;
                        document.addEventListener('keydown', function(ev) {
                            // Only trigger in editor screen
                            if (!document.querySelector('.editor-screen').style.display || document.querySelector('.editor-screen').style.display === 'none') return;
                            if (ev.ctrlKey) {
                                // Helper
                                function prevent() { ev.preventDefault(); }
                                // Ctrl + S
                                if (ev.key.toLowerCase() === 's') { prevent(); document.getElementById('docSaveBtn')?.click(); }
                                // Ctrl + Z
                                if (ev.key.toLowerCase() === 'z') { prevent(); document.execCommand('undo'); }
                                // Ctrl + Y
                                if (ev.key.toLowerCase() === 'y') { prevent(); document.execCommand('redo'); }
                                // Ctrl + B
                                if (ev.key.toLowerCase() === 'b') { prevent(); document.execCommand('bold'); }
                                // Ctrl + I
                                if (ev.key.toLowerCase() === 'i') { prevent(); document.execCommand('italic'); }
                                // Ctrl + U
                                if (ev.key.toLowerCase() === 'u') { prevent(); document.execCommand('underline'); }
                                // Ctrl + Shift + S
                                if (ev.shiftKey && ev.key.toLowerCase() === 's') { prevent(); document.execCommand('strikeThrough'); }
                                // Ctrl + Shift + C
                                if (ev.shiftKey && ev.key.toLowerCase() === 'c') { prevent(); document.execCommand('copy'); }
                                // Ctrl + Shift + V
                                if (ev.shiftKey && ev.key.toLowerCase() === 'v') { prevent(); document.execCommand('paste'); }
                                // Ctrl + Shift + X
                                if (ev.shiftKey && ev.key.toLowerCase() === 'x') { prevent(); document.execCommand('cut'); }
                                // Ctrl + Shift + F
                                if (ev.shiftKey && ev.key.toLowerCase() === 'f') { prevent(); document.getElementById('editorSearchBtn')?.click(); }
                                // Ctrl + Shift + H
                                if (ev.shiftKey && ev.key.toLowerCase() === 'h') { prevent(); document.getElementById('editorEdit')?.click(); }
                                // Ctrl + Shift + L
                                if (ev.shiftKey && ev.key.toLowerCase() === 'l') { prevent(); document.getElementById('linkBtn')?.click(); }
                                // Ctrl + Shift + Q
                                if (ev.shiftKey && ev.key.toLowerCase() === 'q') { prevent(); document.getElementById('quoteBtn')?.click(); }
                                // Ctrl + Shift + T
                                if (ev.shiftKey && ev.key.toLowerCase() === 't') { prevent(); document.getElementById('ctxInsertTable')?.click(); }
                                // Ctrl + Shift + D
                                if (ev.shiftKey && ev.key.toLowerCase() === 'd') { prevent(); document.getElementById('ctxInsertDropdown')?.click(); }
                                // Ctrl + Shift + O
                                if (ev.shiftKey && ev.key.toLowerCase() === 'o') { prevent(); document.getElementById('numberedBtn')?.click(); }
                                // Ctrl + Shift + U
                                if (ev.shiftKey && ev.key.toLowerCase() === 'u') { prevent(); document.getElementById('bulletedBtn')?.click(); }
                                // Ctrl + Shift + M
                                if (ev.shiftKey && ev.key.toLowerCase() === 'm') { prevent(); document.getElementById('imageBtn')?.click(); }
                                // Ctrl + Shift + R
                                if (ev.shiftKey && ev.key.toLowerCase() === 'r') { prevent(); document.getElementById('hrBtn')?.click(); }
                                // Ctrl + Shift + E
                                if (ev.shiftKey && ev.key.toLowerCase() === 'e') { prevent(); document.getElementById('alignCenterBtn')?.click(); }
                                // Ctrl + Shift + L
                                if (ev.shiftKey && ev.key.toLowerCase() === 'l') { prevent(); document.getElementById('alignLeftBtn')?.click(); }
                                // Ctrl + Shift + G
                                if (ev.shiftKey && ev.key.toLowerCase() === 'g') { prevent(); document.getElementById('alignRightBtn')?.click(); }
                                // Ctrl + Shift + P
                                if (ev.shiftKey && ev.key.toLowerCase() === 'p') { prevent(); document.getElementById('ctxPrint')?.click(); }
                                // Ctrl + Shift + N
                                if (ev.shiftKey && ev.key.toLowerCase() === 'n') { prevent(); location.hash = '#/create?=type=Document'; }
                                // Ctrl + Shift + A
                                if (ev.shiftKey && ev.key.toLowerCase() === 'a') { prevent(); document.execCommand('selectAll'); }
                                // Ctrl + Shift + W
                                if (ev.shiftKey && ev.key.toLowerCase() === 'w') { prevent(); document.getElementById('ctxWordCount')?.click(); }
                                // Ctrl + Shift + V
                                if (ev.shiftKey && ev.key.toLowerCase() === 'v') { prevent(); document.getElementById('ctxVersion')?.click(); }
                                // Ctrl + Shift + S
                                if (ev.shiftKey && ev.key.toLowerCase() === 's') { prevent(); document.getElementById('ctxShare')?.click(); }
                                // Ctrl + Shift + B
                                if (ev.shiftKey && ev.key.toLowerCase() === 'b') { prevent(); openGmail('Report a Bug - Munetios Docs Suite'); }
                                // Ctrl + Shift + F
                                if (ev.shiftKey && ev.key.toLowerCase() === 'f') { prevent(); openGmail('Request a Feature - Munetios Docs Suite'); }
                                // Ctrl + Shift + K
                                if (ev.shiftKey && ev.key.toLowerCase() === 'k') { prevent(); document.getElementById('editorHelp')?.click(); }
                                // Ctrl + Shift + C
                                if (ev.shiftKey && ev.key.toLowerCase() === 'c') { prevent(); openGmail('Contact Munetios Docs Suite'); }
                                // Ctrl + Shift + Z
                                if (ev.shiftKey && ev.key.toLowerCase() === 'z') { prevent(); document.getElementById('ctxZoomIn')?.click(); }
                                // Ctrl + Shift + X
                                if (ev.shiftKey && ev.key.toLowerCase() === 'x') { prevent(); document.getElementById('ctxZoomOut')?.click(); }
                                // Ctrl + Shift + 0
                                if (ev.shiftKey && ev.key === '0') { prevent(); document.getElementById('ctxResetZoom')?.click(); }
                                // Ctrl + Shift + F11
                                if (ev.shiftKey && ev.key.toLowerCase() === 'f11') { prevent(); document.getElementById('ctxFullscreen')?.click(); }
                                // Ctrl + Shift + H
                                if (ev.shiftKey && ev.key.toLowerCase() === 'h') { prevent(); document.getElementById('editorHelp')?.click(); }
                                // Ctrl + Shift + D
                                if (ev.shiftKey && ev.key.toLowerCase() === 'd') { prevent(); document.getElementById('ctxDetails')?.click(); }
                                // Ctrl + Shift + R
                                if (ev.shiftKey && ev.key.toLowerCase() === 'r') { prevent(); document.getElementById('ctxRename')?.click(); }
                                // Ctrl + Shift + Delete
                                if (ev.shiftKey && (ev.key === 'Delete' || ev.key === 'Del')) { prevent(); document.getElementById('ctxDelete')?.click(); }
                                // Ctrl + Shift + Plus
                                if (ev.shiftKey && (ev.key === '+' || ev.key === '=')) { prevent(); document.getElementById('addPageBtn')?.click(); }
                                // Ctrl + Shift + Minus
                                if (ev.shiftKey && ev.key === '-') {
                                    prevent();
                                    // Remove last page if more than one
                                    let docPages = document.getElementById('docPages');
                                    if (docPages && docPages.children.length > 1) {
                                        docPages.removeChild(docPages.lastChild);
                                    }
                                }
                                // Ctrl + Shift + Q
                                if (ev.shiftKey && ev.key.toLowerCase() === 'q') { prevent(); document.getElementById('editorInsert')?.click(); }
                                // Ctrl + Shift + T
                                if (ev.shiftKey && ev.key.toLowerCase() === 't') { prevent(); document.getElementById('editorTools')?.click(); }
                                // Ctrl + Shift + V
                                if (ev.shiftKey && ev.key.toLowerCase() === 'v') { prevent(); document.getElementById('editorView')?.click(); }
                                // Ctrl + Shift + E
                                if (ev.shiftKey && ev.key.toLowerCase() === 'e') { prevent(); document.getElementById('editorEdit')?.click(); }
                                // Ctrl + Shift + F
                                if (ev.shiftKey && ev.key.toLowerCase() === 'f') { prevent(); document.getElementById('editorFile')?.click(); }
                                // Ctrl + Shift + H
                                if (ev.shiftKey && ev.key.toLowerCase() === 'h') { prevent(); location.hash = ''; }
                                // Ctrl + Shift + J
                                if (ev.shiftKey && ev.key.toLowerCase() === 'j') { prevent(); location.hash = '#/create?=type=Journal'; }
                                // Ctrl + Shift + P
                                if (ev.shiftKey && ev.key.toLowerCase() === 'p') { prevent(); location.hash = '#/create?=type=Presentation'; }
                                // Ctrl + Shift + S
                                if (ev.shiftKey && ev.key.toLowerCase() === 's') { prevent(); location.hash = '#/create?=type=Spreadsheet'; }
                            }
                        }, true);
                    }
                };
                // Edit button context menu
                document.getElementById('editorEdit').onclick = function(e) {
                    e.stopPropagation();
                    const context = document.getElementById('contextwrapperRender');
                    context.innerHTML = `
                        <div style="position:absolute;top:${e.target.getBoundingClientRect().bottom+8}px;left:${e.target.getBoundingClientRect().left}px;z-index:4000;min-width:220px;">
                            <div style="padding:8px 0;">
                                <button style="width:100%;text-align:left;padding:10px 24px;background:none;border:none;font-size:16px;cursor:pointer;" id="ctxCut">Cut</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;background:none;border:none;font-size:16px;cursor:pointer;" id="ctxCopy">Copy</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;background:none;border:none;font-size:16px;cursor:pointer;" id="ctxPaste">Paste</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;background:none;border:none;font-size:16px;cursor:pointer;" id="ctxPastePlain">Paste without Formatting</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;background:none;border:none;font-size:16px;cursor:pointer;" id="ctxSelectAll">Select All</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;background:none;border:none;font-size:16px;cursor:pointer;" id="ctxDelete">Delete</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;background:none;border:none;font-size:16px;cursor:pointer;" id="ctxFindReplace">Find and Replace</button>
                                <button style="padding:8px 24px;border-radius:18px;background:none;border:1px solid #590691;color:#590691;font-size:15px;cursor:pointer;" id="ctxCloseEdit">Close</button>
                            </div>
                        </div>
                    `;
                    context.style.display = 'block';
                    context.onclick = ev => ev.stopPropagation();

                    function closeContext(ev) {
                        if (!context.contains(ev.target)) {
                            context.style.display = 'none';
                            document.removeEventListener('mousedown', closeContext);
                        }
                    }
                    document.addEventListener('mousedown', closeContext);

                    document.getElementById('ctxCloseEdit').onclick = function() {
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                    };

                    // Cut
                    document.getElementById('ctxCut').onclick = function() {
                        document.execCommand('cut');
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                    };
                    // Copy
                    document.getElementById('ctxCopy').onclick = function() {
                        document.execCommand('copy');
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                    };
                    // Paste
                    document.getElementById('ctxPaste').onclick = function() {
                        document.execCommand('paste');
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                    };
                    // Paste without formatting
                    document.getElementById('ctxPastePlain').onclick = function() {
                        navigator.clipboard.readText().then(text => {
                            document.execCommand('insertText', false, text);
                        });
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                    };
                    // Select All
                    document.getElementById('ctxSelectAll').onclick = function() {
                        document.execCommand('selectAll');
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                    };
                    // Delete
                    document.getElementById('ctxDelete').onclick = function() {
                        document.execCommand('delete');
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                    };
                    // Find and Replace
                    document.getElementById('ctxFindReplace').onclick = function() {
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                        modal.innerHTML = `
                            <div class="modal-content">
                                <h3>Find and Replace</h3>
                                <input type="text" id="findText" placeholder="Find..." style="width:100%;padding:12px;border-radius:12px;margin-bottom:12px;">
                                <input type="text" id="replaceText" placeholder="Replace with..." style="width:100%;padding:12px;border-radius:12px;margin-bottom:12px;">
                                <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                                    <button class="btn" id="cancelFindReplace">Cancel</button>
                                    <button class="btn" id="findBtn">Find</button>
                                    <button class="btn" id="replaceBtn">Replace</button>
                                    <button class="btn" id="replaceAllBtn">Replace All</button>
                                </div>
                                <div id="findResult" style="margin-top:12px;color:#590691;"></div>
                            </div>
                        `;
                        modal.classList.add('active');
                        let lastFound = null;
                        let lastPageIdx = 0;
                        document.getElementById('cancelFindReplace').onclick = () => modal.classList.remove('active');
                        document.getElementById('findBtn').onclick = () => {
                            const findVal = document.getElementById('findText').value;
                            if (!findVal) return;
                            let found = false;
                            let pageIdx = lastPageIdx;
                            let startIdx = 0;
                            if (lastFound && lastFound.page === pageIdx) {
                                startIdx = lastFound.index + 1;
                            }
                            for (; pageIdx < docData.length; pageIdx++) {
                                let pageContent = docData[pageIdx];
                                let idx = pageContent.indexOf(findVal, startIdx);
                                if (idx !== -1) {
                                    found = true;
                                    lastFound = { page: pageIdx, index: idx };
                                    lastPageIdx = pageIdx;
                                    // Highlight found text
                                    let pageDiv = document.querySelectorAll('.docCanvasPage')[pageIdx];
                                    let html = pageContent.replace(new RegExp(findVal, 'g'), match =>
                                        `<span style="background:#ffe066;color:#590691;">${match}</span>`
                                    );
                                    pageDiv.innerHTML = html;
                                    document.getElementById('findResult').textContent = `Found in page ${pageIdx + 1}`;
                                    break;
                                }
                                startIdx = 0;
                            }
                            if (!found) {
                                document.getElementById('findResult').textContent = 'Not found';
                                lastFound = null;
                                lastPageIdx = 0;
                            }
                        };
                        document.getElementById('replaceBtn').onclick = () => {
                            const findVal = document.getElementById('findText').value;
                            const replaceVal = document.getElementById('replaceText').value;
                            if (!findVal || lastFound === null) return;
                            let pageIdx = lastFound.page;
                            let pageContent = docData[pageIdx];
                            let idx = pageContent.indexOf(findVal, lastFound.index);
                            if (idx !== -1) {
                                docData[pageIdx] = pageContent.substring(0, idx) + replaceVal + pageContent.substring(idx + findVal.length);
                                renderPages();
                                saveDoc(true);
                                document.getElementById('findResult').textContent = `Replaced in page ${pageIdx + 1}`;
                                lastFound = null;
                            }
                        };
                        document.getElementById('replaceAllBtn').onclick = () => {
                            const findVal = document.getElementById('findText').value;
                            const replaceVal = document.getElementById('replaceText').value;
                            if (!findVal) return;
                            let replaced = 0;
                            docData = docData.map(page => {
                                let count = (page.match(new RegExp(findVal, 'g')) || []).length;
                                replaced += count;
                                return page.replace(new RegExp(findVal, 'g'), replaceVal);
                            });
                            renderPages();
                            saveDoc(true);
                            document.getElementById('findResult').textContent = `Replaced ${replaced} occurrence(s)`;
                        };
                    };
                };
                document.getElementById('editorTools').onclick = function(e) {
                    e.stopPropagation();
                    const context = document.getElementById('contextwrapperRender');
                    context.innerHTML = `
                        <div style="position:absolute;top:${e.target.getBoundingClientRect().bottom+8}px;left:${e.target.getBoundingClientRect().left}px;z-index:4000;min-width:260px;">
                            <div style="padding:8px 0;">
                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxCompareDocs">Compare Documents</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxWordCount">Word Count</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxAutoCorrect">AutoCorrecter</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxDirectany">Directany</button>
                                <button style="padding:8px 24px;border-radius:18px;background:none;border:1px solid #590691;color:#590691;font-size:15px;cursor:pointer;" id="ctxCloseTools">Close</button>
                            </div>
                        </div>
                    `;
                    context.style.display = 'block';
                    context.onclick = ev => ev.stopPropagation();

                    function closeContext(ev) {
                        if (!context.contains(ev.target)) {
                            context.style.display = 'none';
                            document.removeEventListener('mousedown', closeContext);
                        }
                    }
                    document.addEventListener('mousedown', closeContext);

                    document.getElementById('ctxCloseTools').onclick = function() {
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                    };

                    // Compare Documents
                    document.getElementById('ctxCompareDocs').onclick = function() {
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                        openDB().then(db => {
                            const tx = db.transaction(STORE_NAME, 'readonly');
                            const store = tx.objectStore(STORE_NAME);
                            store.getAll().onsuccess = function(ev) {
                                const items = ev.target.result.filter(item => item.id !== docId && decrypt(item.type) === 'Document');
                                let options = items.map(item => `<option value="${item.id}">${decrypt(item.name)}</option>`).join('');
                                modal.innerHTML = `
                                    <div class="modal-content">
                                        <h3>Compare Documents</h3>
                                        <div style="margin-bottom:12px;">Select another document to compare side by side.</div>
                                        <select id="compareDocSelect" style="width:100%;padding:12px;border-radius:12px;margin-bottom:12px;">
                                            <option value="">-- Select Document --</option>
                                            ${options}
                                        </select>
                                        <div style="margin-bottom:12px;">Or paste document text:</div>
                                        <textarea id="compareDocText" rows="6" style="width:100%;padding:12px;border-radius:12px;margin-bottom:12px;"></textarea>
                                        <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                                            <button class="btn" id="cancelCompare">Cancel</button>
                                            <button class="btn" id="applyCompare">Compare</button>
                                        </div>
                                        <div id="compareResult" style="margin-top:12px;"></div>
                                    </div>
                                `;
                                modal.classList.add('active');
                                document.getElementById('cancelCompare').onclick = () => modal.classList.remove('active');
                                document.getElementById('applyCompare').onclick = () => {
                                    let otherDocId = document.getElementById('compareDocSelect').value;
                                    let otherDocText = document.getElementById('compareDocText').value;
                                    function compareDocs(thisDoc, otherDoc) {
                                        let thisWords = thisDoc.replace(/<[^>]+>/g, '').split(/\s+/).filter(Boolean);
                                        let otherWords = otherDoc.replace(/<[^>]+>/g, '').split(/\s+/).filter(Boolean);
                                        let missing = otherWords.filter(w => !thisWords.includes(w));
                                        let newWords = thisWords.filter(w => !otherWords.includes(w));
                                        let common = thisWords.filter(w => otherWords.includes(w));
                                        let html = `
                                            <div style="display:flex;gap:24px;">
                                                <div style="flex:1;">
                                                    <h4>This Document</h4>
                                                    <div style="background:#f6f6f6;padding:12px;border-radius:8px;min-height:80px;">${thisWords.join(' ')}</div>
                                                </div>
                                                <div style="flex:1;">
                                                    <h4>Other Document</h4>
                                                    <div style="background:#f6f6f6;padding:12px;border-radius:8px;min-height:80px;">${otherWords.join(' ')}</div>
                                                </div>
                                            </div>
                                            <div style="margin-top:18px;">
                                                <strong>Missing in This:</strong> <span style="color:#d32f2f">${missing.join(', ') || 'None'}</span><br>
                                                <strong>New in This:</strong> <span style="color:#388e3c">${newWords.join(', ') || 'None'}</span><br>
                                                <strong>Common:</strong> <span style="color:#590691">${common.join(', ') || 'None'}</span>
                                            </div>
                                        `;
                                        document.getElementById('compareResult').innerHTML = html;
                                    }
                                    if (otherDocId) {
                                        openDB().then(db2 => {
                                            const tx2 = db2.transaction(STORE_NAME, 'readonly');
                                            const store2 = tx2.objectStore(STORE_NAME);
                                            store2.get(Number(otherDocId)).onsuccess = function(ev2) {
                                                const item2 = ev2.target.result;
                                                let otherDoc = '';
                                                if (item2 && item2.content) {
                                                    try {
                                                        let arr = JSON.parse(decrypt(item2.content));
                                                        otherDoc = Array.isArray(arr) ? arr.join(' ') : arr;
                                                    } catch {
                                                        otherDoc = decrypt(item2.content);
                                                    }
                                                }
                                                let thisDoc = docData.join(' ');
                                                compareDocs(thisDoc, otherDoc);
                                            };
                                        });
                                    } else if (otherDocText.trim()) {
                                        let thisDoc = docData.join(' ');
                                        compareDocs(thisDoc, otherDocText.trim());
                                    } else {
                                        document.getElementById('compareResult').innerHTML = '<span style="color:#d32f2f;">Please select or paste a document.</span>';
                                    }
                                };
                            };
                        });
                    };

                    // Word Count
                    document.getElementById('ctxWordCount').onclick = function() {
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                        let text = docData.map(page => page.replace(/<[^>]+>/g, '')).join(' ');
                        let words = text.trim().split(/\s+/).filter(Boolean);
                        let chars = text.replace(/\s/g, '').length;
                        modal.innerHTML = `
                            <div class="modal-content">
                                <h3>Word Count</h3>
                                <div><strong>Words:</strong> ${words.length}</div>
                                <div><strong>Characters (no spaces):</strong> ${chars}</div>
                                <button class="btn" style="margin-top:18px;" id="closeWordCount">Close</button>
                            </div>
                        `;
                        modal.classList.add('active');
                        document.getElementById('closeWordCount').onclick = () => modal.classList.remove('active');
                    };

                    // AutoCorrecter
                    let autocorrectEnabled = window._autocorrectEnabled || false;
                    document.getElementById('ctxAutoCorrect').onclick = function() {
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                        modal.innerHTML = `
                            <div class="modal-content">
                                <h3>AutoCorrecter</h3>
                                <div style="margin-bottom:12px;">
                                    <label>
                                        <input type="checkbox" id="toggleAutocorrect" ${autocorrectEnabled ? 'checked' : ''} />
                                        Enable AutoCorrecter
                                    </label>
                                </div>
                                <div id="autocorrectStatus" style="margin-bottom:12px;color:#590691;">
                                    ${autocorrectEnabled ? 'AutoCorrecter is ON.' : 'AutoCorrecter is OFF.'}
                                </div>
                                <div style="font-size:13px;color:#888;">If enabled, misspelled words will be autocorrected and suggestions will appear.</div>
                                <button class="btn" style="margin-top:18px;" id="closeAutocorrect">Close</button>
                            </div>
                        `;
                        modal.classList.add('active');
                        document.getElementById('closeAutocorrect').onclick = () => modal.classList.remove('active');
                        document.getElementById('toggleAutocorrect').onchange = function() {
                            autocorrectEnabled = this.checked;
                            window._autocorrectEnabled = autocorrectEnabled;
                            document.getElementById('autocorrectStatus').textContent = autocorrectEnabled ? 'AutoCorrecter is ON.' : 'AutoCorrecter is OFF.';
                        };
                    };

                    // Directany
                    let directany = window._directany || { 'munetios': 'Munetios' };
                    document.getElementById('ctxDirectany').onclick = function() {
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                        let directanyList = Object.entries(directany).map(([k,v]) => `<li><strong>${k}</strong> → ${v}</li>`).join('');
                        modal.innerHTML = `
                            <div class="modal-content">
                                <h3>Directany</h3>
                                <div style="margin-bottom:12px;">Add a word to Directany (auto-correct dictionary):</div>
                                <input type="text" id="directanyKey" placeholder="Misspelled word" style="width:48%;padding:8px;border-radius:8px;">
                                <input type="text" id="directanyVal" placeholder="Correct word" style="width:48%;padding:8px;border-radius:8px;margin-left:2%;">
                                <button class="btn" id="addDirectany" style="margin-top:12px;">Add</button>
                                <div style="margin-top:18px;"><strong>Current Directany:</strong></div>
                                <ul id="directanyList" style="margin-top:8px;">${directanyList}</ul>
                                <button class="btn" style="margin-top:18px;" id="closeDirectany">Close</button>
                            </div>
                        `;
                        modal.classList.add('active');
                        document.getElementById('closeDirectany').onclick = () => modal.classList.remove('active');
                        document.getElementById('addDirectany').onclick = function() {
                            let key = document.getElementById('directanyKey').value.trim().toLowerCase();
                            let val = document.getElementById('directanyVal').value.trim();
                            if (key && val) {
                                directany[key] = val;
                                window._directany = directany;
                                let directanyList = Object.entries(directany).map(([k,v]) => `<li><strong>${k}</strong> → ${v}</li>`).join('');
                                document.getElementById('directanyList').innerHTML = directanyList;
                                document.getElementById('directanyKey').value = '';
                                document.getElementById('directanyVal').value = '';
                            }
                        };
                    };
                };

                // AutoCorrecter logic for all editable pages
                function autocorrectHandler(e) {
                    if (!window._autocorrectEnabled) return;
                    let directany = window._directany || { 'munetios': 'Munetios' };
                    let page = e.target;
                    if (!page.classList.contains('docCanvasPage')) return;
                    let sel = window.getSelection();
                    let range = sel && sel.rangeCount ? sel.getRangeAt(0) : null;
                    let html = page.innerHTML;
                    let words = html.split(/\b/);
                    let changed = false;
                    for (let i = 0; i < words.length; i++) {
                        let w = words[i];
                        let lw = w.toLowerCase();
                        if (directany[lw] && w !== directany[lw]) {
                            words[i] = `<span style="background:#ffe066;color:#590691;" title="AutoCorrected">${directany[lw]}</span>`;
                            changed = true;
                        }
                    }
                    if (changed) {
                        page.innerHTML = words.join('');
                        // Restore selection if possible
                        if (range) {
                            sel.removeAllRanges();
                            sel.addRange(range);
                        }
                    }
                }
                // Make Share button in topbar functional
                document.getElementById('editorShareBtn').onclick = function() {
                    const shareUrl = location.origin + location.pathname + '#/editor/' + docId;
                    const shareTitle = project.name ? decrypt(project.name) : 'Document';
                    if (navigator.share) {
                        navigator.share({
                            title: shareTitle,
                            text: 'Munetios Docs Suite Document',
                            url: shareUrl
                        }).then(() => {
                            showToast('Shared!', 'success');
                        }).catch(() => {
                            showToast('Share canceled', 'info');
                        });
                    } else {
                        modal.innerHTML = `
                            <div class="modal-content">
                                <h3>Share Document</h3>
                                <div style="margin-bottom:12px;">Share this document with others by sending this link:</div>
                                <input type="text" value="${shareUrl}" readonly style="width:100%;padding:12px;border-radius:12px;margin-bottom:12px;">
                                <button class="btn" id="copyShareLink">Copy Link</button>
                            </div>
                        `;
                        modal.classList.add('active');
                        document.getElementById('copyShareLink').onclick = function() {
                            navigator.clipboard.writeText(shareUrl);
                            showToast('Link copied!', 'success');
                        };
                    }
                };

                // Allow document creation via URL hash: #/create?createdocument=title=(title),content=()
                function handleCreateDocumentUrl() {
                    const hash = window.location.hash;
                    if (hash.startsWith('#/create?createdocument=')) {
                        const raw = hash.replace('#/create?createdocument=', '');
                        let title = '', content = '';
                        raw.split(',').forEach(pair => {
                            const [key, val] = pair.split('=');
                            if (key === 'title') title = decodeURIComponent(val || '');
                            if (key === 'content') content = decodeURIComponent(val || '');
                        });
                        if (title) {
                            openDB().then(db => {
                                const tx = db.transaction(STORE_NAME, 'readwrite');
                                const store = tx.objectStore(STORE_NAME);
                                const now = new Date();
                                const req = store.add({
                                    type: encrypt('Document'),
                                    name: encrypt(title),
                                    created: encrypt(now.toISOString()),
                                    content: encrypt(JSON.stringify([content]))
                                });
                                req.onsuccess = function(ev) {
                                    // Go to editor for new document
                                    const id = ev.target.result;
                                    location.hash = '#/editor/' + id;
                                    // Remove hash from URL
                                    window.history.replaceState({}, document.title, location.pathname);
                                };
                            });
                        }
                    }
                }
                handleCreateDocumentUrl();
                document.getElementById('editorHistoryBtn').onclick = function() {
                    // Simulate click on File > Version History
                    document.getElementById('editorFile').click();
                    setTimeout(() => {
                        const btn = document.getElementById('ctxVersion');
                        if (btn) btn.click();
                    }, 100);
                };
                document.addEventListener('input', autocorrectHandler, true);
                // Remove lock feature (deleted Lock option and related logic)

                // Show toast utility
                document.getElementById('editorInsert').onclick = function(e) {
                    e.stopPropagation();
                    const context = document.getElementById('contextwrapperRender');
                    context.innerHTML = `
                        <div style="position:absolute;top:${e.target.getBoundingClientRect().bottom+8}px;left:${e.target.getBoundingClientRect().left}px;z-index:4000;min-width:220px;">
                            <div style="padding:8px 0;">
                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxInsertImage">Image</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxInsertQuote">Quote</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxInsertHr">Horizontal Line</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxInsertLink">Link</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxInsertTable">Table</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxInsertDropdown">Dropdown</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxInsertToc">Table of Contents</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxInsertCode">Code Block</button>
                                <button style="padding:8px 24px;border-radius:18px;background:none;border:1px solid #590691;color:#590691;font-size:15px;cursor:pointer;" id="ctxCloseInsert">Close</button>
                            </div>
                        </div>
                    `;
                    context.style.display = 'block';
                    context.onclick = ev => ev.stopPropagation();

                    function closeContext(ev) {
                        if (!context.contains(ev.target)) {
                            context.style.display = 'none';
                            document.removeEventListener('mousedown', closeContext);
                        }
                    }
                    document.addEventListener('mousedown', closeContext);

                    document.getElementById('ctxCloseInsert').onclick = function() {
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                    };

                    // Image
                    document.getElementById('ctxInsertImage').onclick = function() {
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                        document.getElementById('imageBtn').click();
                    };
                    // Quote
                    document.getElementById('ctxInsertQuote').onclick = function() {
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                        document.getElementById('quoteBtn').click();
                    };
                    // Horizontal Line
                    document.getElementById('ctxInsertHr').onclick = function() {
                        document.execCommand('insertHorizontalRule');
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                        saveDoc(true);
                    };
                    // Link
                    document.getElementById('ctxInsertLink').onclick = function() {
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                        document.getElementById('linkBtn').click();
                    };
                    // Table
                    document.getElementById('ctxInsertTable').onclick = function() {
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                        const modal = document.getElementById('modalUIRender');
                        modal.innerHTML = `
                            <div class="modal-content">
                                <h3>Insert Table</h3>
                                <label>Rows: <input type="number" id="tableRows" min="1" max="20" value="3" style="width:60px;margin-right:12px;"></label>
                                <label>Columns: <input type="number" id="tableCols" min="1" max="10" value="3" style="width:60px;"></label>
                                <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                                    <button class="btn" id="cancelTable">Cancel</button>
                                    <button class="btn" id="applyTable">Insert</button>
                                </div>
                            </div>
                        `;
                        modal.classList.add('active');
                        document.getElementById('cancelTable').onclick = () => modal.classList.remove('active');
                        document.getElementById('applyTable').onclick = () => {
                            let rows = parseInt(document.getElementById('tableRows').value, 10);
                            let cols = parseInt(document.getElementById('tableCols').value, 10);
                            if (rows > 0 && cols > 0) {
                                let table = document.createElement('table');
                                table.style.width = '100%';
                                table.style.borderCollapse = 'collapse';
                                table.style.margin = '16px 0';
                                for (let r = 0; r < rows; r++) {
                                    let tr = document.createElement('tr');
                                    for (let c = 0; c < cols; c++) {
                                        let td = document.createElement('td');
                                        td.style.border = '1px solid #590691';
                                        td.style.padding = '8px';
                                        td.innerHTML = r === 0 ? `Header ${c+1}` : '';
                                        tr.appendChild(td);
                                    }
                                    table.appendChild(tr);
                                }
                                let sel = window.getSelection();
                                let page = document.activeElement.classList.contains('docCanvasPage') ? document.activeElement : document.querySelector('.docCanvasPage');
                                if (sel && sel.rangeCount > 0 && page.contains(sel.anchorNode)) {
                                    let range = sel.getRangeAt(0);
                                    range.insertNode(table);
                                } else {
                                    page.appendChild(table);
                                }
                                modal.classList.remove('active');
                                saveDoc(true);
                            }
                        };
                    };
                    // Dropdown
                    document.getElementById('ctxInsertDropdown').onclick = function() {
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                        const modal = document.getElementById('modalUIRender');
                        modal.innerHTML = `
                            <div class="modal-content">
                                <h3>Insert Dropdown</h3>
                                <input type="text" id="dropdownOptions" placeholder="Comma separated options" style="width:100%;padding:12px;border-radius:12px;margin-bottom:12px;">
                                <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                                    <button class="btn" id="cancelDropdown">Cancel</button>
                                    <button class="btn" id="applyDropdown">Insert</button>
                                </div>
                            </div>
                        `;
                        modal.classList.add('active');
                        document.getElementById('cancelDropdown').onclick = () => modal.classList.remove('active');
                        document.getElementById('applyDropdown').onclick = () => {
                            let options = document.getElementById('dropdownOptions').value.split(',').map(o => o.trim()).filter(o => o);
                            if (options.length) {
                                let select = document.createElement('select');
                                select.style.padding = '8px 16px';
                                select.style.borderRadius = '8px';
                                select.style.border = '1px solid #590691';
                                options.forEach(opt => {
                                    let option = document.createElement('option');
                                    option.value = opt;
                                    option.textContent = opt;
                                    select.appendChild(option);
                                });
                                let sel = window.getSelection();
                                let page = document.activeElement.classList.contains('docCanvasPage') ? document.activeElement : document.querySelector('.docCanvasPage');
                                if (sel && sel.rangeCount > 0 && page.contains(sel.anchorNode)) {
                                    let range = sel.getRangeAt(0);
                                    range.insertNode(select);
                                } else {
                                    page.appendChild(select);
                                }
                                modal.classList.remove('active');
                                saveDoc(true);
                            }
                        };
                    };
                    // Table of Contents
                    document.getElementById('ctxInsertToc').onclick = function() {
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);

                        // Build TOC with anchor links and heading levels
                        let tocHtml = '<div style="margin:16px 0;"><strong>Table of Contents</strong><ul style="margin:12px 0;">';
                        let headingCount = 0;
                        Array.from(document.querySelectorAll('.docCanvasPage')).forEach((page, idx) => {
                            let div = document.createElement('div');
                            div.innerHTML = page.innerHTML;
                            Array.from(div.querySelectorAll('h1,h2,h3,h4,h5,h6')).forEach(h => {
                                headingCount++;
                                // Add anchor to heading in page
                                let anchorId = `toc-heading-${idx}-${headingCount}`;
                                h.id = anchorId;
                                // Indent based on heading level
                                let indent = (parseInt(h.tagName.substring(1)) - 1) * 16;
                                tocHtml += `<li style="margin-bottom:6px;margin-left:${indent}px;"><a href="#${anchorId}" style="color:#590691;text-decoration:underline;">${h.textContent}</a></li>`;
                            });
                        });
                        tocHtml += '</ul></div>';

                        // Insert TOC at cursor or end of page
                        let sel = window.getSelection();
                        let page = document.activeElement.classList.contains('docCanvasPage') ? document.activeElement : document.querySelector('.docCanvasPage');
                        if (sel && sel.rangeCount > 0 && page.contains(sel.anchorNode)) {
                            let range = sel.getRangeAt(0);
                            range.insertNode(document.createRange().createContextualFragment(tocHtml));
                        } else {
                            page.insertAdjacentHTML('beforeend', tocHtml);
                        }
                        saveDoc(true);
                    };
                    // Code Block
                    document.getElementById('ctxInsertCode').onclick = function() {
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                        const modal = document.getElementById('modalUIRender');
                        modal.innerHTML = `
                            <div class="modal-content">
                                <h3>Insert Code Block</h3>
                                <textarea id="codeBlockText" rows="6" style="width:100%;padding:12px;border-radius:12px;margin-bottom:12px;font-family:Consolas,monospace;"></textarea>
                                <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                                    <button class="btn" id="cancelCode">Cancel</button>
                                    <button class="btn" id="applyCode">Insert</button>
                                </div>
                            </div>
                        `;
                        modal.classList.add('active');
                        document.getElementById('cancelCode').onclick = () => modal.classList.remove('active');
                        document.getElementById('applyCode').onclick = () => {
                            let code = document.getElementById('codeBlockText').value;
                            if (code) {
                                let pre = document.createElement('pre');
                                pre.style.background = '#12092b';
                                pre.style.color = '#fff';
                                pre.style.padding = '16px';
                                pre.style.borderRadius = '12px';
                                pre.style.fontFamily = 'Consolas, monospace';
                                pre.style.overflowX = 'auto';
                                pre.textContent = code;
                                let sel = window.getSelection();
                                let page = document.activeElement.classList.contains('docCanvasPage') ? document.activeElement : document.querySelector('.docCanvasPage');
                                if (sel && sel.rangeCount > 0 && page.contains(sel.anchorNode)) {
                                    let range = sel.getRangeAt(0);
                                    range.insertNode(pre);
                                } else {
                                    page.appendChild(pre);
                                }
                                modal.classList.remove('active');
                                saveDoc(true);
                            }
                        };
                    };
                };
                document.getElementById('editorMoreBtn').onclick = function(e) {    
                    e.stopPropagation();
                    const context = document.getElementById('contextwrapperRender');
                    context.innerHTML = `
                        <div style="position:absolute;top:${e.target.getBoundingClientRect().bottom+8}px;left:${e.target.getBoundingClientRect().left}px;z-index:4000;min-width:220px;">
                            <div style="padding:8px 0;">
                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxMakeCopy">Make a Copy</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxPrint">Print</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxInsertTable">Insert Table</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxInsertDropdown">Insert Dropdown</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxInsertToc">Insert Table of Contents</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxInsertCode">Insert Code Block</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxDetails">Document Info</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxResize">Resize Page</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxDelete">Delete</button>
                                <button style="padding:8px 24px;border-radius:18px;background:none;border:1px solid #590691;color:#590691;font-size:15px;cursor:pointer;" id="ctxCloseMore">Close</button>
                            </div>
                        </div>
                    `;
                    context.style.display = 'block';
                    context.onclick = ev => ev.stopPropagation();

                    function closeContext(ev) {
                        if (!context.contains(ev.target)) {
                            context.style.display = 'none';
                            document.removeEventListener('mousedown', closeContext);
                        }
                    }
                    document.addEventListener('mousedown', closeContext);

                    document.getElementById('ctxCloseMore').onclick = function() {
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                    };

                    document.getElementById('ctxMakeCopy').onclick = function() {
                        document.getElementById('editorFile').click();
                        setTimeout(() => document.getElementById('ctxMakeCopy')?.click(), 100);
                    };
                    document.getElementById('ctxPrint').onclick = function() {
                        document.getElementById('editorFile').click();
                        setTimeout(() => document.getElementById('ctxPrint')?.click(), 100);
                    };
                    document.getElementById('ctxInsertTable').onclick = function() {
                        document.getElementById('editorInsert').click();
                        setTimeout(() => document.getElementById('ctxInsertTable')?.click(), 100);
                    };
                    document.getElementById('ctxInsertDropdown').onclick = function() {
                        document.getElementById('editorInsert').click();
                        setTimeout(() => document.getElementById('ctxInsertDropdown')?.click(), 100);
                    };
                    document.getElementById('ctxInsertToc').onclick = function() {
                        document.getElementById('editorInsert').click();
                        setTimeout(() => document.getElementById('ctxInsertToc')?.click(), 100);
                    };
                    document.getElementById('ctxInsertCode').onclick = function() {
                        document.getElementById('editorInsert').click();
                        setTimeout(() => document.getElementById('ctxInsertCode')?.click(), 100);
                    };
                    document.getElementById('ctxDetails').onclick = function() {
                        document.getElementById('editorFile').click();
                        setTimeout(() => document.getElementById('ctxDetails')?.click(), 100);
                    };
                    document.getElementById('ctxResize').onclick = function() {
                        document.getElementById('editorFile').click();
                        setTimeout(() => document.getElementById('ctxResize')?.click(), 100);
                    };
                    document.getElementById('ctxDelete').onclick = function() {
                        document.getElementById('editorFile').click();
                        setTimeout(() => document.getElementById('ctxDelete')?.click(), 100);
                    };
                };
                // File button context menu
                document.getElementById('editorFile').onclick = function(e) {
                    e.stopPropagation();
                    const context = document.getElementById('contextwrapperRender');
                    context.innerHTML = `
                        <div style="position:absolute;top:${e.target.getBoundingClientRect().bottom+8}px;left:${e.target.getBoundingClientRect().left}px;z-index:4000;min-width:220px;">
                            <div style="padding:8px 0;">
                                <button style="width:100%;text-align:left;padding:10px 24px;background:none;border:none;font-size:16px;cursor:pointer;" id="ctxMakeCopy">Make a Copy</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;background:none;border:none;font-size:16px;cursor:pointer;" id="ctxShare">Share</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;background:none;border:none;font-size:16px;cursor:pointer;" id="ctxDownload">Download (.docx)</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;background:none;border:none;font-size:16px;cursor:pointer;" id="ctxDownloadTxt">Download as TXT</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;background:none;border:none;font-size:16px;cursor:pointer;" id="ctxPrint">Print</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;background:none;border:none;font-size:16px;cursor:pointer;" id="ctxRename">Rename</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;background:none;border:none;font-size:16px;cursor:pointer;" id="ctxVersion">Version History</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;background:none;border:none;font-size:16px;cursor:pointer;" id="ctxDetails">Details</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;background:none;border:none;font-size:16px;cursor:pointer;" id="ctxDelete">Delete</button>
                                <button style="width:100%;text-align:left;padding:10px 24px;background:none;border:none;font-size:16px;cursor:pointer;" id="ctxResize">Resize Page</button>        
                                  <button style="padding:8px 24px;border-radius:18px;background:none;border:1px solid #590691;color:#590691;font-size:15px;cursor:pointer;" id="ctxCloseBtn">Close</button>
                            </div>
                        </div>
                    `;
                    context.style.display = 'block';
                    context.onclick = ev => ev.stopPropagation();

                    // Close context when clicking outside
                    function closeContext(ev) {
                        if (!context.contains(ev.target)) {
                            context.style.display = 'none';
                            document.removeEventListener('mousedown', closeContext);
                        }
                    }
                    document.addEventListener('mousedown', closeContext);

                    // Close button handler
                    document.getElementById('ctxCloseBtn').onclick = function() {
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                    };

                    // Make a Copy
                    document.getElementById('ctxMakeCopy').onclick = function() {
                        openDB().then(db => {
                            const tx = db.transaction(STORE_NAME, 'readwrite');
                            const store = tx.objectStore(STORE_NAME);
                            store.get(docId).onsuccess = function(ev) {
                                const item = ev.target.result;
                                let copy = Object.assign({}, item);
                                delete copy.id;
                                copy.name = encrypt(decrypt(item.name) + ' (Copy)');
                                copy.created = encrypt(new Date().toISOString());
                                store.add(copy).onsuccess = function() {
                                    showToast('Document copied!', 'success');
                                    renderProjects();
                                };
                            };
                        });
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                    };

                    // Share
                    document.getElementById('ctxShare').onclick = function() {
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                        const shareUrl = location.origin + location.pathname + '#/editor/' + docId;
                        const shareTitle = project.name ? decrypt(project.name) : 'Document';
                        if (navigator.share) {
                            navigator.share({
                                title: shareTitle,
                                text: 'Munetios Docs Suite Document',
                                url: shareUrl
                            }).then(() => {
                                showToast('Shared!', 'success');
                            }).catch(() => {
                                showToast('Share canceled', 'info');
                            });
                        } else {
                            modal.innerHTML = `
                                <div class="modal-content">
                                    <h3>Share Document</h3>
                                    <div style="margin-bottom:12px;">Share this document with others by sending this link:</div>
                                    <input type="text" value="${shareUrl}" readonly style="width:100%;padding:12px;border-radius:12px;margin-bottom:12px;">
                                    <button class="btn" id="copyShareLink">Copy Link</button>
                                </div>
                            `;
                            modal.classList.add('active');
                            document.getElementById('copyShareLink').onclick = function() {
                                navigator.clipboard.writeText(shareUrl);
                                showToast('Link copied!', 'success');
                            };
                        }
                    };

                    // Download (.docx)
                    document.getElementById('ctxDownload').onclick = function() {
                        let html = docData.map(page => page).join('<hr style="border:none;border-top:2px solid #590691;margin:32px 0;">');
                        let blob = new Blob([`
                            <html><head><meta charset="utf-8"><title>${project.name ? decrypt(project.name) : 'Document'}</title></head>
                            <body style="font-family:${currentPageStyles.fontFamily};font-size:${currentPageStyles.fontSize};background:${currentPageStyles.background};">${html}</body></html>
                        `], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
                        let a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        a.download = (project.name ? decrypt(project.name) : 'Document') + '.docx';
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        showToast('Downloaded as .docx', 'success');
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                    };

                    // Download as TXT
                    document.getElementById('ctxDownloadTxt').onclick = function() {
                        let txt = docData.map(page => page.replace(/<[^>]+>/g, '')).join('\n---\n');
                        let blob = new Blob([txt], { type: 'text/plain' });
                        let a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        a.download = (project.name ? decrypt(project.name) : 'Document') + '.txt';
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        showToast('Downloaded as TXT', 'success');
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                    };

                    // Print
                    document.getElementById('ctxPrint').onclick = function() {
                        let printWindow = window.open('', '', 'width=900,height=1200');
                        let html = docData.map(page => `<div style="page-break-after:always;padding:48px;background:${currentPageStyles.background};font-family:${currentPageStyles.fontFamily};font-size:${currentPageStyles.fontSize};">${page}</div>`).join('');
                        printWindow.document.write(`
                            <html><head><title>Print Document</title></head>
                            <body>${html}</body></html>
                        `);
                        printWindow.document.close();
                        printWindow.focus();
                        setTimeout(() => printWindow.print(), 400);
                        showToast('Print dialog opened', 'info');
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                    };

                    // Rename
                    document.getElementById('ctxRename').onclick = function() {
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                        modal.innerHTML = `
                            <div class="modal-content">
                                <h3>Rename Document</h3>
                                <input type="text" id="renameInput" value="${project.name ? decrypt(project.name) : ''}" style="width:100%;padding:12px;border-radius:12px;margin-bottom:12px;">
                                <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                                    <button class="btn" id="cancelRename">Cancel</button>
                                    <button class="btn" id="applyRename">Rename</button>
                                </div>
                            </div>
                        `;
                        modal.classList.add('active');
                        document.getElementById('cancelRename').onclick = () => modal.classList.remove('active');
                        document.getElementById('applyRename').onclick = function() {
                            let newName = document.getElementById('renameInput').value.trim();
                            if (newName) {
                                openDB().then(db => {
                                    const tx = db.transaction(STORE_NAME, 'readwrite');
                                    const store = tx.objectStore(STORE_NAME);
                                    store.get(docId).onsuccess = function(ev) {
                                        const item = ev.target.result;
                                        item.name = encrypt(newName);
                                        store.put(item).onsuccess = function() {
                                            showToast('Renamed!', 'success');
                                            modal.classList.remove('active');
                                            renderProjects();
                                        };
                                    };
                                });
                            }
                        };
                    };
                    // Version History
                    document.getElementById('ctxVersion').onclick = function() {
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                        openDB().then(db => {
                            const tx = db.transaction(STORE_NAME, 'readonly');
                            const store = tx.objectStore(STORE_NAME);
                            store.get(docId).onsuccess = function(ev) {
                                const item = ev.target.result;
                                let history = [];
                                try {
                                    history = item.history ? JSON.parse(decrypt(item.history)) : [];
                                } catch { history = []; }
                                modal.innerHTML = `
                                    <div class="modal-content" style="max-width:900px;">
                                        <h3>Version History</h3>
                                        <div style="max-height:480px;overflow:auto;">
                                            ${history.length ? history.map((h, i) => `
                                                <div style="padding:12px;border-bottom:1px solid #eee;">
                                                    <div><strong>${new Date(h.time).toLocaleString()}</strong></div>
                                                    <button class="btn" style="margin-top:8px;" data-preview="${i}">Preview</button>
                                                    <div class="version-preview" id="versionPreview${i}" style="display:none;background:#fff;padding:24px;border-radius:12px;max-height:320px;overflow:auto;">
                                                        ${h.data.map(page => `<div style="margin-bottom:24px;border-radius:16px;box-shadow:0 2px 12px rgba(31,38,135,0.10);padding:24px;background:#fafafa;">${page}</div>`).join('')}
                                                    </div>
                                                    <button class="btn" style="margin-top:12px;" data-restore="${i}">Restore</button>
                                                </div>
                                            `).join('') : '<div>No history yet.</div>'}
                                        </div>
                                        <button class="btn" style="margin-top:18px;" id="closeHistory">Close</button>
                                    </div>
                                `;
                                modal.classList.add('active');
                                document.getElementById('closeHistory').onclick = () => modal.classList.remove('active');
                                Array.from(modal.querySelectorAll('[data-restore]')).forEach(btn => {
                                    btn.onclick = function() {
                                        let idx = btn.getAttribute('data-restore');
                                        let h = history[idx];
                                        docData = h.data;
                                        renderPages();
                                        saveDoc(true);
                                        showToast('Version restored!', 'success');
                                        modal.classList.remove('active');
                                    };
                                });
                                Array.from(modal.querySelectorAll('[data-preview]')).forEach(btn => {
                                    btn.onclick = function() {
                                        let idx = btn.getAttribute('data-preview');
                                        let previewDiv = document.getElementById('versionPreview' + idx);
                                        if (previewDiv.style.display === 'none') {
                                            previewDiv.style.display = 'block';
                                            btn.textContent = 'Hide Preview';
                                        } else {
                                            previewDiv.style.display = 'none';
                                            btn.textContent = 'Preview';
                                        }
                                    };
                                });
                            };
                        });
                    };

                    // Details
                    document.getElementById('ctxDetails').onclick = function() {
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                        openDB().then(db => {
                            const tx = db.transaction(STORE_NAME, 'readonly');
                            const store = tx.objectStore(STORE_NAME);
                            store.get(docId).onsuccess = function(ev) {
                                const item = ev.target.result;
                                let chars = docData.reduce((a, b) => a + b.replace(/<[^>]+>/g, '').length, 0);
                                let size = new Blob([JSON.stringify(docData)]).size;
                                modal.innerHTML = `
                                    <div class="modal-content">
                                        <h3>Document Details</h3>
                                        <div><strong>Name:</strong> ${item.name ? decrypt(item.name) : ''}</div>
                                        <div><strong>Type:</strong> ${item.type ? decrypt(item.type) : ''}</div>
                                        <div><strong>Created:</strong> ${item.created ? new Date(decrypt(item.created)).toLocaleString() : ''}</div>
                                        <div><strong>Last Modified:</strong> ${new Date().toLocaleString()}</div>
                                        <div><strong>Size:</strong> ${size} bytes</div>
                                        <div><strong>Characters:</strong> ${chars}</div>
                                        <button class="btn" style="margin-top:18px;" id="closeDetails">Close</button>
                                    </div>
                                `;
                                modal.classList.add('active');
                                document.getElementById('closeDetails').onclick = () => modal.classList.remove('active');
                            };
                        });
                    };

                    // Delete
                    document.getElementById('ctxDelete').onclick = function() {
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                        modal.innerHTML = `
                            <div class="modal-content">
                                <h3>Delete Document</h3>
                                <div>Are you sure you want to delete this document?</div>
                                <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                                    <button class="btn" id="cancelDelete">Cancel</button>
                                    <button class="btn" id="confirmDelete">Delete</button>
                                </div>
                            </div>
                        `;
                        modal.classList.add('active');
                        document.getElementById('cancelDelete').onclick = () => modal.classList.remove('active');
                        document.getElementById('confirmDelete').onclick = function() {
                            modal.innerHTML = `
                                <div class="modal-content">
                                    <h3>Confirm Permanent Delete</h3>
                                    <div>This action cannot be undone. Delete permanently?</div>
                                    <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                                        <button class="btn" id="cancelPermDelete">Cancel</button>
                                        <button class="btn" id="confirmPermDelete">Delete Permanently</button>
                                    </div>
                                </div>
                            `;
                            document.getElementById('cancelPermDelete').onclick = () => modal.classList.remove('active');
                            document.getElementById('confirmPermDelete').onclick = function() {
                                openDB().then(db => {
                                    const tx = db.transaction(STORE_NAME, 'readwrite');
                                    const store = tx.objectStore(STORE_NAME);
                                    store.delete(docId).onsuccess = function() {
                                        showToast('Deleted!', 'success');
                                        modal.classList.remove('active');
                                        location.hash = '';
                                        renderProjects();
                                    };
                                });
                            };
                        };
                    };

                    // Resize Page
                    document.getElementById('ctxResize').onclick = function() {
                        context.style.display = 'none';
                        document.removeEventListener('mousedown', closeContext);
                        document.getElementById('resizeBtn').click();
                    };
                };
                function showToast(msg, type = 'info') {
                    let toast = document.createElement('div');
                    toast.textContent = msg;
                    toast.style.position = 'fixed';
                    toast.style.bottom = '32px';
                    toast.style.left = '50%';
                    toast.style.transform = 'translateX(-50%)';
                    toast.style.padding = '12px 24px';
                    toast.style.borderRadius = '24px';
                    toast.style.fontSize = '16px';
                    toast.style.zIndex = '9999';
                    toast.style.color = '#fff';
                    toast.style.background = type === 'success' ? '#590691' : (type === 'error' ? '#d32f2f' : '#333');
                    toast.style.boxShadow = '0 8px 32px 0 rgba(31,38,135,0.18)';
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 2200);
                }

              

                // Store current page styles globally
                let currentPageStyles = {
                    background: '#fff',
                    width: '800px',
                    height: '1024px',
                    fontFamily: 'Lexend,sans-serif',
                    fontSize: '16px'
                };

                function renderPages() {
                    const docPages = document.getElementById('docPages');
                    docPages.innerHTML = '';
                    docData.forEach((content, idx) => {
                        const page = document.createElement('div');
                        page.className = 'docCanvasPage';
                        page.contentEditable = true;
                        page.spellcheck = true;
                        // Apply current styles
                        page.style.background = currentPageStyles.background;
                        page.style.width = currentPageStyles.width;
                        page.style.height = currentPageStyles.height;
                        page.style.boxShadow = '0 8px 32px 0 rgba(31,38,135,0.18)';
                        page.style.borderRadius = '24px';
                        page.style.padding = '48px';
                        page.style.overflow = 'auto';
                        page.style.outline = 'none';
                        page.style.fontFamily = currentPageStyles.fontFamily;
                        page.style.fontSize = currentPageStyles.fontSize;
                        page.style.marginBottom = '32px';
                        page.setAttribute('data-page', idx);
                        page.innerHTML = content;
                        // Save on input
                        page.addEventListener('input', () => {
                            docData[idx] = page.innerHTML;
                            makeImagesResponsive();
                            saveDoc(true);
                        });
                        docPages.appendChild(page);
                    });
                    makeImagesResponsive();
                }

                function setAllPagesStyle(prop, value) {
                    currentPageStyles[prop] = value;
                    const pages = document.querySelectorAll('.docCanvasPage');
                    pages.forEach(page => {
                        page.style[prop] = value;
                    });
                }

                // Save function
                function saveDoc(auto = false) {
                    makeImagesResponsive();
                    const bgColor = document.querySelector('.docCanvasPage')?.style.background || '#fff';
                    const width = document.querySelector('.docCanvasPage')?.style.width || '800px';
                    const height = document.querySelector('.docCanvasPage')?.style.height || '1024px';
                    const fontFamily = document.querySelector('.docCanvasPage')?.style.fontFamily || 'Lexend,sans-serif';
                    const fontSize = document.querySelector('.docCanvasPage')?.style.fontSize || '16px';
                    openDB().then(db => {
                        const tx = db.transaction(STORE_NAME, 'readwrite');
                        const store = tx.objectStore(STORE_NAME);
                        store.get(docId).onsuccess = function(ev) {
                            const item = ev.target.result;
                            item.content = encrypt(JSON.stringify(docData));
                            item.bgColor = encrypt(bgColor);
                            item.width = encrypt(width);
                            item.height = encrypt(height);
                            item.fontFamily = encrypt(fontFamily);
                            item.fontSize = encrypt(fontSize);
                            store.put(item);
                        };
                    });
                    if (!auto) {
                        document.getElementById('docSaveBtn').style.background = '#b6f7c1';
                        setTimeout(() => document.getElementById('docSaveBtn').style.background = '', 600);
                    }
                }

                // Make all images in all pages responsive
                function makeImagesResponsive() {
                    const imgs = document.getElementById('docPages').querySelectorAll('img');
                    imgs.forEach(img => {
                        img.style.maxWidth = '100%';
                        img.style.height = 'auto';
                        img.style.display = 'block';
                        img.style.margin = '12px auto';
                    });
                }

                // Auto save every 5 seconds
                setInterval(() => saveDoc(true), 5000);

                // Toolbar actions
                document.getElementById('docSaveBtn').onclick = () => saveDoc();

                // Resize modal
                document.getElementById('resizeBtn').onclick = () => {
                    const modal = document.getElementById('modalUIRender');
                    modal.innerHTML = `
                        <div class="modal-content">
                            <h3>Resize Page</h3>
                            <div style="margin-top:18px;">
                                <label>Width (px): <input type="number" id="resizeWidth" min="100" max="2000" value="${document.querySelector('.docCanvasPage')?.style.width.replace('px','') || '800'}" style="width:80px;padding:6px 12px;border-radius:12px;border:1px solid #ccc;background:#fff;"></label>
                                <label style="margin-left:16px;">Height (px): <input type="number" id="resizeHeight" min="100" max="3000" value="${document.querySelector('.docCanvasPage')?.style.height.replace('px','') || '1024'}" style="width:80px;padding:6px 12px;border-radius:12px;border:1px solid #ccc;background:#fff;"></label>
                            </div>
                            <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                                <button class="btn" id="cancelResize">Cancel</button>
                                <button class="btn" id="applyResize">Apply</button>
                            </div>
                        </div>
                    `;
                    modal.classList.add('active');
                    document.getElementById('cancelResize').onclick = () => modal.classList.remove('active');
                    document.getElementById('applyResize').onclick = () => {
                        let w = document.getElementById('resizeWidth').value;
                        let h = document.getElementById('resizeHeight').value;
                        if (w && h) {
                            setAllPagesStyle('width', w + 'px');
                            setAllPagesStyle('height', h + 'px');
                            saveDoc(true);
                        }
                        modal.classList.remove('active');
                    };
                };

                document.getElementById('bgColorPicker').oninput = e => {
                    setAllPagesStyle('background', e.target.value);
                    saveDoc(true);
                };
                document.getElementById('boldBtn').onclick = () => document.execCommand('bold');
                document.getElementById('italicBtn').onclick = () => document.execCommand('italic');
                document.getElementById('underlineBtn').onclick = () => document.execCommand('underline');
                document.getElementById('strikeBtn').onclick = () => document.execCommand('strikeThrough');
                document.getElementById('textColorPicker').oninput = e => document.execCommand('foreColor', false, e.target.value);

                // Font family fix
                document.getElementById('fontFamilyPicker').onchange = e => {
                    const fontMap = {
                        "Lexend": "Lexend, Arial, sans-serif",
                        "Arial": "Arial, sans-serif",
                        "Calibri": "Calibri, Arial, sans-serif",
                        "Comic Sans MS": "'Comic Sans MS', cursive",
                        "Consolas": "Consolas, monospace",
                        "Courier New": "'Courier New', monospace",
                        "Georgia": "Georgia, serif",
                        "Georgia Pro": "'Georgia Pro', serif",
                        "Impact": "Impact, sans-serif",
                        "Microsoft Sans Serif": "'Microsoft Sans Serif', sans-serif",
                        "Noto Sans": "'Noto Sans', sans-serif",
                        "Noto Serif": "'Noto Serif', serif",
                        "Open Sans": "'Open Sans', sans-serif",
                        "Poppins": "Poppins, sans-serif",
                        "Roboto": "Roboto, sans-serif",
                        "Segoe UI": "'Segoe UI', sans-serif",
                        "Times New Roman": "'Times New Roman', serif",
                        "Trebuchet MS": "'Trebuchet MS', sans-serif",
                        "Verdana": "Verdana, sans-serif",
                        "Tahoma": "Tahoma, sans-serif",
                        "Palatino": "Palatino, serif",
                        "Garamond": "Garamond, serif",
                        "Bookman": "Bookman, serif",
                        "Arial Black": "'Arial Black', sans-serif",
                        "Century Gothic": "'Century Gothic', sans-serif",
                        "Franklin Gothic Medium": "'Franklin Gothic Medium', sans-serif",
                        "Lucida Sans": "'Lucida Sans', sans-serif",
                        "Lucida Console": "'Lucida Console', monospace",
                        "Monaco": "Monaco, monospace",
                        "Optima": "Optima, sans-serif",
                        "Candara": "Candara, sans-serif",
                        "Geneva": "Geneva, sans-serif",
                        "Futura": "Futura, sans-serif",
                        "Baskerville": "Baskerville, serif",
                        "Didot": "Didot, serif",
                        "Rockwell": "Rockwell, serif",
                        "Perpetua": "Perpetua, serif",
                        "Gill Sans": "'Gill Sans', sans-serif",
                        "Century Schoolbook": "'Century Schoolbook', serif",
                        "Copperplate": "Copperplate, serif",
                        "Brush Script MT": "'Brush Script MT', cursive",
                        "Lato": "Lato, sans-serif",
                        "Montserrat": "Montserrat, sans-serif",
                        "Oswald": "Oswald, sans-serif",
                        "Raleway": "Raleway, sans-serif",
                        "Merriweather": "Merriweather, serif",
                        "PT Sans": "'PT Sans', sans-serif",
                        "PT Serif": "'PT Serif', serif",
                        "Quicksand": "Quicksand, sans-serif",
                        "Nunito": "Nunito, sans-serif",
                        "Playfair Display": "'Playfair Display', serif",
                        "Source Sans Pro": "'Source Sans Pro', sans-serif",
                        "Ubuntu": "Ubuntu, sans-serif",
                        "Droid Sans": "'Droid Sans', sans-serif",
                        "Droid Serif": "'Droid Serif', serif",
                        "Exo": "Exo, sans-serif",
                        "Josefin Sans": "'Josefin Sans', sans-serif",
                        "Muli": "Muli, sans-serif",
                        "Titillium Web": "'Titillium Web', sans-serif",
                        "Cabin": "Cabin, sans-serif",
                        "Bitter": "Bitter, serif",
                        "Arvo": "Arvo, serif",
                        "Anton": "Anton, sans-serif",
                        "Pacifico": "Pacifico, cursive",
                        "Indie Flower": "'Indie Flower', cursive",
                        "Bangers": "Bangers, cursive",
                        "Fredoka One": "'Fredoka One', cursive",
                        "Caveat": "Caveat, cursive",
                        "Satisfy": "Satisfy, cursive",
                        "Dancing Script": "'Dancing Script', cursive",
                        "Great Vibes": "'Great Vibes', cursive",
                        "Lobster": "Lobster, cursive",
                        "Permanent Marker": "'Permanent Marker', cursive",
                        "Shadows Into Light": "'Shadows Into Light', cursive",
                        "Architects Daughter": "'Architects Daughter', cursive",
                        "Amatic SC": "'Amatic SC', cursive",
                        "Baloo": "Baloo, cursive",
                        "Chewy": "Chewy, cursive",
                        "Gloria Hallelujah": "'Gloria Hallelujah', cursive",
                        "Handlee": "Handlee, cursive",
                        "Kalam": "Kalam, cursive",
                        "Patrick Hand": "'Patrick Hand', cursive",
                        "Reenie Beanie": "'Reenie Beanie', cursive",
                        "Sigmar One": "'Sigmar One', cursive",
                        "Spicy Rice": "'Spicy Rice', cursive",
                        "Tangerine": "Tangerine, cursive",
                        "Varela Round": "'Varela Round', sans-serif",
                        "Zilla Slab": "'Zilla Slab', serif",
                        "Crimson Text": "'Crimson Text', serif",
                        "Cormorant Garamond": "'Cormorant Garamond', serif",
                        "Fira Sans": "'Fira Sans', sans-serif",
                        "Hind": "Hind, sans-serif",
                        "Karla": "Karla, sans-serif",
                        "Manrope": "Manrope, sans-serif",
                        "Mulish": "Mulish, sans-serif",
                        "Overpass": "Overpass, sans-serif",
                        "Rubik": "Rubik, sans-serif",
                        "Sarabun": "Sarabun, sans-serif",
                        "Space Mono": "'Space Mono', monospace",
                        "Syne": "Syne, sans-serif",
                        "Work Sans": "'Work Sans', sans-serif",
                        "ZCOOL KuaiLe": "'ZCOOL KuaiLe', cursive",
                        "Alfa Slab One": "'Alfa Slab One', cursive",
                        "Bebas Neue": "'Bebas Neue', cursive",
                        "Black Ops One": "'Black Ops One', cursive",
                        "Coda": "Coda, cursive",
                        "Fjalla One": "'Fjalla One', sans-serif",
                        "Julius Sans One": "'Julius Sans One', sans-serif",
                        "Orbitron": "Orbitron, sans-serif",
                        "Press Start 2P": "'Press Start 2P', cursive",
                        "Russo One": "'Russo One', sans-serif",
                        "Staatliches": "Staatliches, sans-serif",
                        "Syncopate": "Syncopate, sans-serif",
                        "Unica One": "'Unica One', cursive"
                    };
                    let val = e.target.value;
                    let execVal = fontMap[val] || val;
                    document.execCommand('fontName', false, execVal);
                    setAllPagesStyle('fontFamily', execVal);
                    saveDoc(true);
                };

                // Font size input - applies only to selected text
                document.getElementById('fontSizeInput').onchange = e => {
                    let size = e.target.value;
                    if (size < 8) size = 8;
                    if (size > 72) size = 72;
                    let sel = window.getSelection();
                    if (sel && sel.rangeCount > 0 && !sel.isCollapsed) {
                        let range = sel.getRangeAt(0);
                        let span = document.createElement("span");
                        span.style.fontSize = size + "px";
                        range.surroundContents(span);
                    } else {
                        setAllPagesStyle('fontSize', size + 'px');
                    }
                    saveDoc(true);
                };

                document.getElementById('alignLeftBtn').onclick = () => document.execCommand('justifyLeft');
                document.getElementById('alignCenterBtn').onclick = () => document.execCommand('justifyCenter');
                document.getElementById('alignRightBtn').onclick = () => document.execCommand('justifyRight');
                document.getElementById('bulletedBtn').onclick = () => document.execCommand('insertUnorderedList');
                document.getElementById('numberedBtn').onclick = () => document.execCommand('insertOrderedList');
                document.getElementById('checklistBtn').onclick = () => {
                    let sel = window.getSelection();
                    if (sel && sel.rangeCount > 0) {
                        let range = sel.getRangeAt(0);
                        let checklist = document.createElement('ul');
                        checklist.style.listStyle = 'none';
                        checklist.style.paddingLeft = '0';
                        for (let i = 0; i < 3; i++) {
                            let li = document.createElement('li');
                            li.style.display = 'flex';
                            li.style.alignItems = 'center';
                            let checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.style.marginRight = '8px';
                            li.appendChild(checkbox);
                            let span = document.createElement('span');
                            span.textContent = 'Checklist item';
                            li.appendChild(span);
                            checklist.appendChild(li);
                        }
                        range.insertNode(checklist);
                    }
                    saveDoc(true);
                };
                document.getElementById('quoteBtn').onclick = () => {
                    let sel = window.getSelection();
                    if (sel && sel.rangeCount > 0) {
                        let range = sel.getRangeAt(0);
                        let blockquote = document.createElement('blockquote');
                        blockquote.style.borderLeft = '4px solid #590691';
                        blockquote.style.margin = '16px 0';
                        blockquote.style.padding = '12px 24px';
                        blockquote.style.background = 'rgba(89,6,145,0.06)';
                        blockquote.style.fontStyle = 'italic';
                        blockquote.style.borderRadius = '8px';
                        blockquote.innerHTML = sel.toString() || 'Quote';
                        range.deleteContents();
                        range.insertNode(blockquote);
                        sel.removeAllRanges();
                        let newRange = document.createRange();
                        newRange.setStartAfter(blockquote);
                        newRange.collapse(true);
                        sel.addRange(newRange);
                    }
                    saveDoc(true);
                };
                document.getElementById('hrBtn').onclick = () => document.execCommand('insertHorizontalRule');
                document.getElementById('linkBtn').onclick = () => {
                    const modal = document.getElementById('modalUIRender');
                    let sel = window.getSelection();
                    let selectedText = '';
                    if (sel && sel.rangeCount > 0 && !sel.isCollapsed) {
                        selectedText = sel.toString();
                    }
                    modal.innerHTML = `
                        <div class="modal-content">
                            <h3>Insert Link</h3>
                            <input type="url" id="linkUrl" placeholder="Enter URL" style="width:100%;padding:12px;border-radius:12px;margin-bottom:12px;">
                            <input type="text" id="linkText" placeholder="Text to display" style="width:100%;padding:12px;border-radius:12px;margin-bottom:12px;" value="${selectedText}">
                            <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                                <button class="btn" id="cancelLink">Cancel</button>
                                <button class="btn" id="applyLink">Insert</button>
                            </div>
                        </div>
                    `;
                    modal.classList.add('active');
                    document.getElementById('cancelLink').onclick = () => modal.classList.remove('active');
                    document.getElementById('applyLink').onclick = () => {
                        let url = document.getElementById('linkUrl').value;
                        let text = document.getElementById('linkText').value;
                        if (url && text) {
                            let sel = window.getSelection();
                            if (sel && sel.rangeCount > 0 && !sel.isCollapsed) {
                                let range = sel.getRangeAt(0);
                                range.deleteContents();
                                let a = document.createElement('a');
                                a.href = url;
                                a.textContent = text;
                                a.target = '_blank';
                                range.insertNode(a);
                                sel.removeAllRanges();
                                let newRange = document.createRange();
                                newRange.setStartAfter(a);
                                newRange.collapse(true);
                                sel.addRange(newRange);
                            } else {
                                let a = document.createElement('a');
                                a.href = url;
                                a.textContent = text;
                                a.target = '_blank';
                                document.querySelector('.docCanvasPage').appendChild(a);
                            }
                            modal.classList.remove('active');
                            saveDoc(true);
                        } else if (url) {
                            document.execCommand('createLink', false, url);
                            modal.classList.remove('active');
                            saveDoc(true);
                        }
                    };
                };
                document.getElementById('imageBtn').onclick = () => {
                    const modal = document.getElementById('modalUIRender');
                    modal.innerHTML = `
                        <div class="modal-content">
                            <h3>Insert Image</h3>
                            <input type="url" id="imgUrl" placeholder="Image URL" style="width:100%;padding:12px;border-radius:12px;margin-bottom:12px;">
                            <div style="margin-bottom:12px;text-align:center;">or</div>
                            <input type="file" id="imgFile" accept="image/*" style="width:100%;padding:12px;border-radius:12px;">
                            <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                                <button class="btn" id="cancelImg">Cancel</button>
                                <button class="btn" id="applyImg">Insert</button>
                            </div>
                        </div>
                    `;
                    modal.classList.add('active');
                    document.getElementById('cancelImg').onclick = () => modal.classList.remove('active');
                    document.getElementById('applyImg').onclick = () => {
                        let url = document.getElementById('imgUrl').value;
                        let fileInput = document.getElementById('imgFile');
                        if (url) {
                            document.execCommand('insertImage', false, url);
                            makeImagesResponsive();
                            modal.classList.remove('active');
                        } else if (fileInput.files.length) {
                            const file = fileInput.files[0];
                            const reader = new FileReader();
                            reader.onload = function(ev) {
                                document.execCommand('insertImage', false, ev.target.result);
                                makeImagesResponsive();
                                modal.classList.remove('active');
                            };
                            reader.readAsDataURL(file);
                        }
                    };
                };

                // Undo/Redo
                const undoBtn = document.getElementById('editorUndoBtn');
                const redoBtn = document.getElementById('editorRedoBtn');
                if (undoBtn) undoBtn.onclick = () => document.execCommand('undo');
                if (redoBtn) redoBtn.onclick = () => document.execCommand('redo');

                // Add Page button
                document.getElementById('addPageBtn').onclick = () => {
                    docData.push("");
                    renderPages();
                    saveDoc(true);
                };
            }

            // Patch goToEditor to render document editor for Document type
            function goToEditor(id) {
                location.hash = `#/editor/${id}`;
                document.querySelector('.home-screen').style.display = 'none';
                editorScreen.style.display = 'block';
                editorContent.style.display = 'block';
                openDB().then(db => {
                    const tx = db.transaction(STORE_NAME, 'readonly');
                    const store = tx.objectStore(STORE_NAME);
                    const numericId = isNaN(id) ? id : Number(id);
                    store.get(numericId).onsuccess = function(ev) {
                        const item = ev.target.result;
                        if (item && decrypt(item.type) === 'Document') {
                            renderDocumentEditor(item);
                        } else if (item && decrypt(item.type) === 'Journal') {
                            // Journal editor UI
                            const journalToolbarHTML = `
                                <div class="toolbar" id="journalToolbar" style="overflow-x:auto; gap:8px; white-space:nowrap; scrollbar-width:thin;">
                                    <div class="toolbar-group" style="display:inline-flex;">
                                        <button title="Bold" id="journalBoldBtn"><svg width="22" height="22" viewBox="0 0 22 22"><text x="4" y="17" font-family="Arial" font-size="16" font-weight="bold" fill="currentColor">B</text></svg></button>
                                        <button title="Italic" id="journalItalicBtn"><svg width="22" height="22" viewBox="0 0 22 22"><text x="4" y="17" font-family="Arial" font-size="16" font-style="italic" fill="currentColor">I</text></svg></button>
                                        <button title="Underline" id="journalUnderlineBtn"><svg width="22" height="22" viewBox="0 0 22 22"><text x="4" y="17" font-family="Arial" font-size="16" fill="currentColor">U</text><line x1="4" y1="19" x2="18" y2="19" stroke="currentColor" stroke-width="2"/></svg></button>
                                        <button title="Strikethrough" id="journalStrikeBtn"><svg width="22" height="22" viewBox="0 0 22 22"><text x="4" y="17" font-family="Arial" font-size="16" fill="currentColor">S</text><line x1="4" y1="12" x2="18" y2="12" stroke="currentColor" stroke-width="2"/></svg></button>
                                        <input type="color" id="journalTextColorPicker" title="Text Color" style="width:32px;height:32px;border:none;background:none;">
                                        <select id="journalFontFamilyPicker" title="Font Family" style="margin-left:8px;padding:6px 12px;border-radius:12px;border:1px solid #ccc;background:#fff;">
                                            <option value="Lexend" style="font-family:Lexend,sans-serif;">Lexend</option>
                                            <option value="Arial" style="font-family:Arial,sans-serif;">Arial</option>
                                            <option value="Calibri" style="font-family:Calibri,sans-serif;">Calibri</option>
                                            <option value="Comic Sans MS" style="font-family:'Comic Sans MS',cursive;">Comic Sans</option>
                                            <option value="Consolas" style="font-family:Consolas,monospace;">Consolas</option>
                                            <option value="Courier New" style="font-family:'Courier New',monospace;">Courier New</option>
                                            <option value="Georgia" style="font-family:Georgia,serif;">Georgia</option>
                                            <option value="Impact" style="font-family:Impact,sans-serif;">Impact</option>
                                            <option value="Microsoft Sans Serif" style="font-family:'Microsoft Sans Serif',sans-serif;">Microsoft Sans</option>
                                            <option value="Noto Sans" style="font-family:'Noto Sans',sans-serif;">Noto Sans</option>
                                            <option value="Noto Serif" style="font-family:'Noto Serif',serif;">Noto Serif</option>
                                            <option value="Open Sans" style="font-family:'Open Sans',sans-serif;">Open Sans</option>
                                            <option value="Poppins" style="font-family:Poppins,sans-serif;">Poppins</option>
                                            <option value="Roboto" style="font-family:Roboto,sans-serif;">Roboto</option>
                                            <option value="Segoe UI" style="font-family:'Segoe UI',sans-serif;">Segoe UI</option>
                                            <option value="Times New Roman" style="font-family:'Times New Roman',serif;">Times New Roman</option>
                                        </select>
                                    </div>
                                    <div class="toolbar-group" style="display:inline-flex;">
                                        <button title="Image" id="journalImageBtn"><svg width="22" height="22" viewBox="0 0 22 22"><rect x="3" y="5" width="16" height="12" rx="2" stroke="currentColor" stroke-width="2"/><circle cx="8" cy="10" r="2" fill="currentColor"/><path d="M19 17l-5-6-4 5-3-4-4 5" stroke="currentColor" stroke-width="2" fill="none"/></svg></button>
                                        <button title="Video" id="journalVideoBtn"><svg width="22" height="22" viewBox="0 0 22 22"><rect x="3" y="5" width="16" height="12" rx="2" stroke="currentColor" stroke-width="2"/><polygon points="9,8 15,11 9,14" fill="currentColor"/></svg></button>
                                    </div>
                                    <div class="toolbar-group" style="display:inline-flex;">
                                        <button title="Save" id="journalSaveBtn"><svg width="22" height="22" viewBox="0 0 22 22"><rect x="3" y="3" width="16" height="16" rx="2" stroke="currentColor" stroke-width="2"/><path d="M7 3V8H15V3" stroke="currentColor" stroke-width="2"/><rect x="7" y="14" width="8" height="3" rx="1" fill="currentColor"/></svg></button>
                                    </div>
                                </div>
                            `;
                            const journalCanvasHTML = `
                                <div style="padding:24px;">
                                    <h2 style="margin-bottom:24px;">${item.name ? decrypt(item.name) : 'Journal'}</h2>
                                    <div id="journalPages" style="display:flex;flex-direction:row;gap:32px;"></div>
                                    <button id="addJournalPageBtn" class="btn" style="margin-top:32px;align-self:flex-start;display:flex;align-items:center;gap:8px;">
                                        <svg width="22" height="22" viewBox="0 0 22 22"><rect x="9" y="4" width="4" height="14" rx="1" fill="currentColor"/><rect x="4" y="9" width="14" height="4" rx="1" fill="currentColor"/></svg>
                                        Add Page
                                    </button>
                                </div>
                            `;
                            document.querySelector('.editor-content').innerHTML = journalToolbarHTML + journalCanvasHTML;
                            document.querySelector('.editor-content').style.display = 'block';

                            // Journal data
                            let journalData = [];
                            let journalId = item.id;
                            openDB().then(db => {
                                const tx = db.transaction(STORE_NAME, 'readonly');
                                const store = tx.objectStore(STORE_NAME);
                                store.get(journalId).onsuccess = function(ev) {
                                    const journalItem = ev.target.result;
                                    if (journalItem && journalItem.content) {
                                        try {
                                            journalData = JSON.parse(decrypt(journalItem.content));
                                            if (!Array.isArray(journalData)) journalData = [journalData];
                                        } catch {
                                            journalData = [decrypt(journalItem.content)];
                                        }
                                    } else {
                                        journalData = [""];
                                    }
                                    renderJournalPages();
                                };
                            });
                            document.getElementById('journalFontFamilyPicker').onchange = e => {
                                const fontMap = {
                                    "Lexend": "Lexend, Arial, sans-serif",
                                    "Arial": "Arial, sans-serif",
                                    "Calibri": "Calibri, Arial, sans-serif",
                                    "Comic Sans MS": "'Comic Sans MS', cursive",
                                    "Consolas": "Consolas, monospace",
                                    "Courier New": "'Courier New', monospace",
                                    "Georgia": "Georgia, serif",
                                    "Impact": "Impact, sans-serif",
                                    "Microsoft Sans Serif": "'Microsoft Sans Serif', sans-serif",
                                    "Noto Sans": "'Noto Sans', sans-serif",
                                    "Noto Serif": "'Noto Serif', serif",
                                    "Open Sans": "'Open Sans', sans-serif",
                                    "Poppins": "Poppins, sans-serif",
                                    "Roboto": "Roboto, sans-serif",
                                    "Segoe UI": "'Segoe UI', sans-serif",
                                    "Times New Roman": "'Times New Roman', serif"
                                };
                                let val = e.target.value;
                                let execVal = fontMap[val] || val;
                                document.execCommand('fontName', false, execVal);
                                // Apply to all journal pages
                                document.querySelectorAll('.journalPage').forEach(page => {
                                    page.style.fontFamily = execVal;
                                });
                            };
                            document.getElementById('editorView').onclick = function(e) {
                                e.stopPropagation();
                                const context = document.getElementById('contextwrapperRender');
                                context.innerHTML = `
                                    <div style="position:absolute;top:${e.target.getBoundingClientRect().bottom+8}px;left:${e.target.getBoundingClientRect().left}px;z-index:4000;min-width:220px;">
                                        <div style="padding:8px 0;">
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxFullscreen">Fullscreen</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxFind">Find</button>
                                            <button style="padding:8px 24px;border-radius:18px;background:none;border:1px solid #590691;color:#590691;font-size:15px;cursor:pointer;" id="ctxCloseView">Close</button>
                                        </div>
                                    </div>
                                `;
                                context.style.display = 'block';
                                context.onclick = ev => ev.stopPropagation();
                                function closeContext(ev) {
                                    if (!context.contains(ev.target)) {
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    }
                                }
                                document.addEventListener('mousedown', closeContext);
                                document.getElementById('ctxCloseView').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                };
                                document.getElementById('ctxFind').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                    let existingBar = document.getElementById('floatingJournalSearchBar');
                                    if (existingBar) {
                                        existingBar.style.display = 'block';
                                        document.getElementById('journalSearchInput').focus();
                                        return;
                                    }
                                    let searchBar = document.createElement('div');
                                    searchBar.id = 'floatingJournalSearchBar';
                                    searchBar.style.position = 'fixed';
                                    searchBar.style.top = '100px';
                                    searchBar.style.left = '50%';
                                    searchBar.style.transform = 'translateX(-50%)';
                                    searchBar.style.zIndex = '5000';
                                    searchBar.style.background = 'rgba(255,255,255,0.95)';
                                    searchBar.style.boxShadow = '0 8px 32px 0 rgba(31,38,135,0.18)';
                                    searchBar.style.borderRadius = '24px';
                                    searchBar.style.padding = '24px 24px 18px 24px';
                                    searchBar.style.maxWidth = '400px';
                                    searchBar.style.width = '100%';
                                    searchBar.innerHTML = `
                                        <div style="display:flex;align-items:center;justify-content:space-between;">
                                            <h3 style="margin:0;">Search Journal</h3>
                                            <button class="btn" id="closeJournalSearchBar" style="padding:4px 12px;font-size:18px;">&#10005;</button>
                                        </div>
                                        <input type="text" id="journalSearchInput" placeholder="Find text..." style="width:100%;padding:12px;border-radius:12px;margin:18px 0 0 0;">
                                        <div id="journalSearchResult" style="margin-top:12px;color:#590691;"></div>
                                    `;
                                    document.body.appendChild(searchBar);
                                    document.getElementById('journalSearchInput').focus();
                                    document.getElementById('closeJournalSearchBar').onclick = function () {
                                        searchBar.style.display = 'none';
                                        renderJournalPages();
                                    };
                                    document.getElementById('journalSearchInput').oninput = function () {
                                        const val = this.value;
                                        let found = false;
                                        let result = '';
                                        if (!val) {
                                            document.getElementById('journalSearchResult').textContent = '';
                                            renderJournalPages();
                                            return;
                                        }
                                        journalData.forEach((pageContent, idx) => {
                                            if (pageContent.includes(val)) {
                                                found = true;
                                                let pageDiv = document.querySelectorAll('.journalPage')[idx];
                                                let html = pageContent.replace(new RegExp(val, 'gi'), match =>
                                                    `<span style="background:#ffe066;color:#590691;">${match}</span>`
                                                );
                                                pageDiv.innerHTML = html;
                                                result += `Found in page ${idx + 1}. `;
                                            }
                                        });
                                        document.getElementById('journalSearchResult').textContent = found ? result : 'Not found';
                                        if (!found) renderJournalPages();
                                    };
                                };
                                document.getElementById('ctxFullscreen').onclick = function() {
                                    let wrapper = document.getElementById('journalPages');
                                    if (wrapper && wrapper.requestFullscreen) {
                                        wrapper.requestFullscreen();
                                    } else if (wrapper && wrapper.webkitRequestFullscreen) {
                                        wrapper.webkitRequestFullscreen();
                                    }
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                };
                            };

                            document.getElementById('editorInsert').onclick = function(e) {
                                e.stopPropagation();
                                const context = document.getElementById('contextwrapperRender');
                                context.innerHTML = `
                                    <div style="position:absolute;top:${e.target.getBoundingClientRect().bottom+8}px;left:${e.target.getBoundingClientRect().left}px;z-index:4000;min-width:220px;">
                                        <div style="padding:8px 0;">
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxInsertImage">Image</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxInsertVideo">Video</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxInsertCode">Code Block</button>
                                            <button style="padding:8px 24px;border-radius:18px;background:none;border:1px solid #590691;color:#590691;font-size:15px;cursor:pointer;" id="ctxCloseInsert">Close</button>
                                        </div>
                                    </div>
                                `;
                                context.style.display = 'block';
                                context.onclick = ev => ev.stopPropagation();
                                function closeContext(ev) {
                                    if (!context.contains(ev.target)) {
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    }
                                }
                                document.addEventListener('mousedown', closeContext);
                                document.getElementById('ctxCloseInsert').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                };
                                document.getElementById('ctxInsertImage').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                    document.getElementById('journalImageBtn').click();
                                };
                                document.getElementById('ctxInsertVideo').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                    document.getElementById('journalVideoBtn').click();
                                };
                                document.getElementById('ctxInsertCode').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                    const modal = document.getElementById('modalUIRender');
                                    modal.innerHTML = `
                                        <div class="modal-content">
                                            <h3>Insert Code Block</h3>
                                            <textarea id="journalCodeBlockText" rows="6" style="width:100%;padding:12px;border-radius:12px;margin-bottom:12px;font-family:Consolas,monospace;"></textarea>
                                            <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                                                <button class="btn" id="cancelJournalCode">Cancel</button>
                                                <button class="btn" id="applyJournalCode">Insert</button>
                                            </div>
                                        </div>
                                    `;
                                    modal.classList.add('active');
                                    document.getElementById('cancelJournalCode').onclick = () => modal.classList.remove('active');
                                    document.getElementById('applyJournalCode').onclick = () => {
                                        let code = document.getElementById('journalCodeBlockText').value;
                                        if (code) {
                                            let pre = document.createElement('pre');
                                            pre.style.background = '#12092b';
                                            pre.style.color = '#fff';
                                            pre.style.padding = '16px';
                                            pre.style.borderRadius = '12px';
                                            pre.style.fontFamily = 'Consolas, monospace';
                                            pre.style.overflowX = 'auto';
                                            pre.textContent = code;
                                            let sel = window.getSelection();
                                            let page = document.activeElement.classList.contains('journalPage') ? document.activeElement : document.querySelector('.journalPage');
                                            if (sel && sel.rangeCount > 0 && page.contains(sel.anchorNode)) {
                                                let range = sel.getRangeAt(0);
                                                range.insertNode(pre);
                                            } else {
                                                page.appendChild(pre);
                                            }
                                            // Update journalData for this page so code persists after reload
                                            let idx = page.getAttribute('data-page');
                                            if (typeof idx !== 'undefined' && idx !== null) {
                                                journalData[idx] = page.innerHTML;
                                            }
                                            modal.classList.remove('active');
                                            saveJournal(true);
                                        }
                                    };
                                };
                            };

                            document.getElementById('editorTools').onclick = function(e) {
                                e.stopPropagation();
                                const context = document.getElementById('contextwrapperRender');
                                context.innerHTML = `
                                    <div style="position:absolute;top:${e.target.getBoundingClientRect().bottom+8}px;left:${e.target.getBoundingClientRect().left}px;z-index:4000;min-width:260px;">
                                        <div style="padding:8px 0;">
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxWordCount">Word Count</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxAutoCorrect">AutoCorrecter</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxDirectany">Directany</button>
                                            <button style="padding:8px 24px;border-radius:18px;background:none;border:1px solid #590691;color:#590691;font-size:15px;cursor:pointer;" id="ctxCloseTools">Close</button>
                                        </div>
                                    </div>
                                `;
                                context.style.display = 'block';
                                context.onclick = ev => ev.stopPropagation();
                                function closeContext(ev) {
                                    if (!context.contains(ev.target)) {
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    }
                                }
                                document.addEventListener('mousedown', closeContext);
                                document.getElementById('ctxCloseTools').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                };
                                document.getElementById('ctxWordCount').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                    let text = journalData.map(page => page.replace(/<[^>]+>/g, '')).join(' ');
                                    let words = text.trim().split(/\s+/).filter(Boolean);
                                    let chars = text.replace(/\s/g, '').length;
                                    modal.innerHTML = `
                                        <div class="modal-content">
                                            <h3>Word Count</h3>
                                            <div><strong>Words:</strong> ${words.length}</div>
                                            <div><strong>Characters (no spaces):</strong> ${chars}</div>
                                            <button class="btn" style="margin-top:18px;" id="closeWordCount">Close</button>
                                        </div>
                                    `;
                                    modal.classList.add('active');
                                    document.getElementById('closeWordCount').onclick = () => modal.classList.remove('active');
                                };
                                let autocorrectEnabled = window._autocorrectEnabled || false;
                                document.getElementById('ctxAutoCorrect').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                    modal.innerHTML = `
                                        <div class="modal-content">
                                            <h3>AutoCorrecter</h3>
                                            <div style="margin-bottom:12px;">
                                                <label>
                                                    <input type="checkbox" id="toggleAutocorrect" ${autocorrectEnabled ? 'checked' : ''} />
                                                    Enable AutoCorrecter
                                                </label>
                                            </div>
                                            <div id="autocorrectStatus" style="margin-bottom:12px;color:#590691;">
                                                ${autocorrectEnabled ? 'AutoCorrecter is ON.' : 'AutoCorrecter is OFF.'}
                                            </div>
                                            <div style="font-size:13px;color:#888;">If enabled, misspelled words will be autocorrected and suggestions will appear.</div>
                                            <button class="btn" style="margin-top:18px;" id="closeAutocorrect">Close</button>
                                        </div>
                                    `;
                                    modal.classList.add('active');
                                    document.getElementById('closeAutocorrect').onclick = () => modal.classList.remove('active');
                                    document.getElementById('toggleAutocorrect').onchange = function() {
                                        autocorrectEnabled = this.checked;
                                        window._autocorrectEnabled = autocorrectEnabled;
                                        document.getElementById('autocorrectStatus').textContent = autocorrectEnabled ? 'AutoCorrecter is ON.' : 'AutoCorrecter is OFF.';
                                    };
                                };
                                let directany = window._directany || { 'munetios': 'Munetios' };
                                document.getElementById('ctxDirectany').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                    let directanyList = Object.entries(directany).map(([k,v]) => `<li><strong>${k}</strong> → ${v}</li>`).join('');
                                    modal.innerHTML = `
                                        <div class="modal-content">
                                            <h3>Directany</h3>
                                            <div style="margin-bottom:12px;">Add a word to Directany (auto-correct dictionary):</div>
                                            <input type="text" id="directanyKey" placeholder="Misspelled word" style="width:48%;padding:8px;border-radius:8px;">
                                            <input type="text" id="directanyVal" placeholder="Correct word" style="width:48%;padding:8px;border-radius:8px;margin-left:2%;">
                                            <button class="btn" id="addDirectany" style="margin-top:12px;">Add</button>
                                            <div style="margin-top:18px;"><strong>Current Directany:</strong></div>
                                            <ul id="directanyList" style="margin-top:8px;">${directanyList}</ul>
                                            <button class="btn" style="margin-top:18px;" id="closeDirectany">Close</button>
                                        </div>
                                    `;
                                    modal.classList.add('active');
                                    document.getElementById('closeDirectany').onclick = () => modal.classList.remove('active');
                                    document.getElementById('addDirectany').onclick = function() {
                                        let key = document.getElementById('directanyKey').value.trim().toLowerCase();
                                        let val = document.getElementById('directanyVal').value.trim();
                                        if (key && val) {
                                            directany[key] = val;
                                            window._directany = directany;
                                            let directanyList = Object.entries(directany).map(([k,v]) => `<li><strong>${k}</strong> → ${v}</li>`).join('');
                                            document.getElementById('directanyList').innerHTML = directanyList;
                                            document.getElementById('directanyKey').value = '';
                                            document.getElementById('directanyVal').value = '';
                                        }
                                    };
                                };
                            };
                            // AutoCorrecter logic for all editable journal pages
                            function autocorrectHandlerJournal(e) {
                                if (!window._autocorrectEnabled) return;
                                let directany = window._directany || { 'munetios': 'Munetios' };
                                let page = e.target;
                                if (!page.classList.contains('journalPage')) return;
                                let sel = window.getSelection();
                                let range = sel && sel.rangeCount ? sel.getRangeAt(0) : null;
                                let html = page.innerHTML;
                                let words = html.split(/\b/);
                                let changed = false;
                                for (let i = 0; i < words.length; i++) {
                                    let w = words[i];
                                    let lw = w.toLowerCase();
                                    if (directany[lw] && w !== directany[lw]) {
                                        words[i] = `<span style="background:#ffe066;color:#590691;" title="AutoCorrected">${directany[lw]}</span>`;
                                        changed = true;
                                    }
                                }
                                if (changed) {
                                    page.innerHTML = words.join('');
                                    if (range) {
                                        sel.removeAllRanges();
                                        sel.addRange(range);
                                    }
                                }
                            }
                            document.addEventListener('input', autocorrectHandlerJournal, true);

                            document.getElementById('editorHelp').onclick = function(e) {
                                e.stopPropagation();
                                const context = document.getElementById('contextwrapperRender');
                                context.innerHTML = `
                                    <div style="position:absolute;top:${e.target.getBoundingClientRect().bottom+8}px;left:${e.target.getBoundingClientRect().left}px;z-index:4000;min-width:260px;">
                                        <div style="padding:8px 0;">
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxContact">Contact</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxShortcuts">Keyboard Shortcuts</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxFeature">Request a Feature</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxBug">Report a Bug</button>
                                            <button style="padding:8px 24px;border-radius:18px;background:none;border:1px solid #590691;color:#590691;font-size:15px;cursor:pointer;" id="ctxCloseHelp">Close</button>
                                        </div>
                                    </div>
                                `;
                                context.style.display = 'block';
                                context.onclick = ev => ev.stopPropagation();
                                function closeContext(ev) {
                                    if (!context.contains(ev.target)) {
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    }
                                }
                                document.addEventListener('mousedown', closeContext);
                                document.getElementById('ctxCloseHelp').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                };
                                function openGmail(subject) {
                                    window.open(`https://mail.google.com/mail/?view=cm&fs=1&to=minecraftgamer97529@gmail.com&su=${encodeURIComponent(subject)}`, '_blank');
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                }
                                document.getElementById('ctxContact').onclick = function() {
                                    openGmail('Contact Munetios Docs Suite');
                                };
                                document.getElementById('ctxFeature').onclick = function() {
                                    openGmail('Request a Feature - Munetios Docs Suite');
                                };
                                document.getElementById('ctxBug').onclick = function() {
                                    openGmail('Report a Bug - Munetios Docs Suite');
                                };
                                document.getElementById('ctxShortcuts').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                    modal.innerHTML = `
                                        <div class="modal-content" style="max-width:600px;">
                                            <h3>Keyboard Shortcuts</h3>
                                            <div style="max-height:400px;overflow:auto;">
                                                <table style="width:100%;border-collapse:collapse;">
                                                    <thead>
                                                        <tr>
                                                            <th style="text-align:left;padding:8px;">Shortcut</th>
                                                            <th style="text-align:left;padding:8px;">Action</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${[
                                                            ['Ctrl + S', 'Save journal'],
                                                            ['Ctrl + Z', 'Undo'],
                                                            ['Ctrl + Y', 'Redo'],
                                                            ['Ctrl + B', 'Bold'],
                                                            ['Ctrl + I', 'Italic'],
                                                            ['Ctrl + U', 'Underline'],
                                                            ['Ctrl + Shift + S', 'Strikethrough'],
                                                            ['Ctrl + Shift + C', 'Copy'],
                                                            ['Ctrl + Shift + V', 'Paste'],
                                                            ['Ctrl + Shift + X', 'Cut'],
                                                            ['Ctrl + Shift + F', 'Find'],
                                                            ['Ctrl + Shift + H', 'Replace'],
                                                            ['Ctrl + Shift + M', 'Insert Image'],
                                                            ['Ctrl + Shift + V', 'Insert Video'],
                                                            ['Ctrl + Shift + Q', 'Insert Code Block'],
                                                            ['Ctrl + Shift + A', 'Select All'],
                                                            ['Ctrl + Shift + W', 'Word Count'],
                                                            ['Ctrl + Shift + K', 'Keyboard Shortcuts'],
                                                            ['Ctrl + Shift + C', 'Contact'],
                                                            ['Ctrl + Shift + B', 'Report Bug'],
                                                            ['Ctrl + Shift + F', 'Request Feature'],
                                                            ['Ctrl + Shift + H', 'Help'],
                                                            ['Ctrl + Shift + D', 'Journal Details'],
                                                            ['Ctrl + Shift + R', 'Rename Journal'],
                                                            ['Ctrl + Shift + Del', 'Delete Journal'],
                                                            ['Ctrl + Shift + Plus', 'Add Page'],
                                                            ['Ctrl + Shift + Minus', 'Remove Page']
                                                        ].map(([k, v]) => `<tr><td style="padding:6px 8px;">${k}</td><td style="padding:6px 8px;">${v}</td></tr>`).join('')}
                                                    </tbody>
                                                </table>
                                            </div>
                                            <button class="btn" style="margin-top:18px;" id="closeShortcuts">Close</button>
                                        </div>
                                    `;
                                    modal.classList.add('active');
                                    document.getElementById('closeShortcuts').onclick = () => modal.classList.remove('active');
                                };
                            };
                            document.getElementById('editorEdit').onclick = function(e) {
                                e.stopPropagation();
                                const context = document.getElementById('contextwrapperRender');
                                context.innerHTML = `
                                    <div style="position:absolute;top:${e.target.getBoundingClientRect().bottom+8}px;left:${e.target.getBoundingClientRect().left}px;z-index:4000;min-width:220px;">
                                        <div style="padding:8px 0;">
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxCut">Cut</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxCopy">Copy</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxPaste">Paste</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxPastePlain">Paste without Formatting</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxSelectAll">Select All</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxDelete">Delete</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxFindReplace">Find and Replace</button>
                                            <button style="padding:8px 24px;border-radius:18px;background:none;border:1px solid #590691;color:#590691;font-size:15px;cursor:pointer;" id="ctxCloseEdit">Close</button>
                                        </div>
                                    </div>
                                `;
                                context.style.display = 'block';
                                context.onclick = ev => ev.stopPropagation();

                                function closeContext(ev) {
                                    if (!context.contains(ev.target)) {
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    }
                                }
                                document.addEventListener('mousedown', closeContext);

                                document.getElementById('ctxCloseEdit').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                };

                                document.getElementById('ctxCut').onclick = function() {
                                    document.execCommand('cut');
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                };
                                document.getElementById('ctxCopy').onclick = function() {
                                    document.execCommand('copy');
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                };
                                document.getElementById('ctxPaste').onclick = function() {
                                    document.execCommand('paste');
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                };
                                document.getElementById('ctxPastePlain').onclick = function() {
                                    navigator.clipboard.readText().then(text => {
                                        document.execCommand('insertText', false, text);
                                    });
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                };
                                document.getElementById('ctxSelectAll').onclick = function() {
                                    document.execCommand('selectAll');
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                };
                                document.getElementById('ctxDelete').onclick = function() {
                                    document.execCommand('delete');
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                };
                                document.getElementById('ctxFindReplace').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                    modal.innerHTML = `
                                        <div class="modal-content">
                                            <h3>Find and Replace</h3>
                                            <input type="text" id="findText" placeholder="Find..." style="width:100%;padding:12px;border-radius:12px;margin-bottom:12px;">
                                            <input type="text" id="replaceText" placeholder="Replace with..." style="width:100%;padding:12px;border-radius:12px;margin-bottom:12px;">
                                            <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                                                <button class="btn" id="cancelFindReplace">Cancel</button>
                                                <button class="btn" id="findBtn">Find</button>
                                                <button class="btn" id="replaceBtn">Replace</button>
                                                <button class="btn" id="replaceAllBtn">Replace All</button>
                                            </div>
                                            <div id="findResult" style="margin-top:12px;color:#590691;"></div>
                                        </div>
                                    `;
                                    modal.classList.add('active');
                                    let lastFound = null;
                                    let lastPageIdx = 0;
                                    document.getElementById('cancelFindReplace').onclick = () => modal.classList.remove('active');
                                    document.getElementById('findBtn').onclick = () => {
                                        const findVal = document.getElementById('findText').value;
                                        if (!findVal) return;
                                        let found = false;
                                        let pageIdx = lastPageIdx;
                                        let startIdx = 0;
                                        if (lastFound && lastFound.page === pageIdx) {
                                            startIdx = lastFound.index + 1;
                                        }
                                        for (; pageIdx < journalData.length; pageIdx++) {
                                            let pageContent = journalData[pageIdx];
                                            let idx = pageContent.indexOf(findVal, startIdx);
                                            if (idx !== -1) {
                                                found = true;
                                                lastFound = { page: pageIdx, index: idx };
                                                lastPageIdx = pageIdx;
                                                let pageDiv = document.querySelectorAll('.journalPage')[pageIdx];
                                                let html = pageContent.replace(new RegExp(findVal, 'g'), match =>
                                                    `<span style="background:#ffe066;color:#590691;">${match}</span>`
                                                );
                                                pageDiv.innerHTML = html;
                                                document.getElementById('findResult').textContent = `Found in page ${pageIdx + 1}`;
                                                break;
                                            }
                                            startIdx = 0;
                                        }
                                        if (!found) {
                                            document.getElementById('findResult').textContent = 'Not found';
                                            lastFound = null;
                                            lastPageIdx = 0;
                                        }
                                    };
                                    document.getElementById('replaceBtn').onclick = () => {
                                        const findVal = document.getElementById('findText').value;
                                        const replaceVal = document.getElementById('replaceText').value;
                                        if (!findVal || lastFound === null) return;
                                        let pageIdx = lastFound.page;
                                        let pageContent = journalData[pageIdx];
                                        let idx = pageContent.indexOf(findVal, lastFound.index);
                                        if (idx !== -1) {
                                            journalData[pageIdx] = pageContent.substring(0, idx) + replaceVal + pageContent.substring(idx + findVal.length);
                                            renderJournalPages();
                                            saveJournal(true);
                                            document.getElementById('findResult').textContent = `Replaced in page ${pageIdx + 1}`;
                                            lastFound = null;
                                        }
                                    };
                                    document.getElementById('replaceAllBtn').onclick = () => {
                                        const findVal = document.getElementById('findText').value;
                                        const replaceVal = document.getElementById('replaceText').value;
                                        if (!findVal) return;
                                        let replaced = 0;
                                        journalData = journalData.map(page => {
                                            let count = (page.match(new RegExp(findVal, 'g')) || []).length;
                                            replaced += count;
                                            return page.replace(new RegExp(findVal, 'g'), replaceVal);
                                        });
                                        renderJournalPages();
                                        saveJournal(true);
                                        document.getElementById('findResult').textContent = `Replaced ${replaced} occurrence(s)`;
                                    };
                                };
                            };
                            document.getElementById('editorMoreBtn').onclick = function(e) {
                                e.stopPropagation();
                                const context = document.getElementById('contextwrapperRender');
                                context.innerHTML = `
                                    <div style="position:absolute;top:${e.target.getBoundingClientRect().bottom+8}px;left:${e.target.getBoundingClientRect().left}px;z-index:4000;min-width:220px;">
                                        <div style="padding:8px 0;">
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxRename">Rename</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxPrint">Print</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxDownloadMd">Download as Markdown</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxDownloadTxt">Download as TXT</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxDetails">Details</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxMakeCopy">Make a Copy</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxInsertCode">Insert Code Block</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxDelete">Delete</button>
                                            <button style="padding:8px 24px;border-radius:18px;background:none;border:1px solid #590691;color:#590691;font-size:15px;cursor:pointer;" id="ctxCloseMore">Close</button>
                                        </div>
                                    </div>
                                `;
                                context.style.display = 'block';
                                context.onclick = ev => ev.stopPropagation();

                                function closeContext(ev) {
                                    if (!context.contains(ev.target)) {
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    }
                                }
                                document.addEventListener('mousedown', closeContext);

                                document.getElementById('ctxCloseMore').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                };

                                document.getElementById('ctxRename').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                    document.getElementById('ctxRename').blur();
                                    document.getElementById('editorFile').click();
                                    setTimeout(() => {
                                        document.getElementById('ctxRename')?.click();
                                    }, 100);
                                };

                                document.getElementById('ctxPrint').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                    document.getElementById('editorFile').click();
                                    setTimeout(() => {
                                        document.getElementById('ctxPrint')?.click();
                                    }, 100);
                                };

                                document.getElementById('ctxDownloadMd').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                    document.getElementById('editorFile').click();
                                    setTimeout(() => {
                                        document.getElementById('ctxDownloadMd')?.click();
                                    }, 100);
                                };

                                document.getElementById('ctxDownloadTxt').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                    document.getElementById('editorFile').click();
                                    setTimeout(() => {
                                        document.getElementById('ctxDownloadTxt')?.click();
                                    }, 100);
                                };

                                document.getElementById('ctxDetails').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                    document.getElementById('editorFile').click();
                                    setTimeout(() => {
                                        document.getElementById('ctxDetails')?.click();
                                    }, 100);
                                };

                                document.getElementById('ctxMakeCopy').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                    document.getElementById('editorFile').click();
                                    setTimeout(() => {
                                        document.getElementById('ctxMakeCopy')?.click();
                                    }, 100);
                                };

                                document.getElementById('ctxInsertCode').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                    document.getElementById('editorInsert').click();
                                    setTimeout(() => {
                                        document.getElementById('ctxInsertCode')?.click();
                                    }, 100);
                                };

                                document.getElementById('ctxDelete').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                    document.getElementById('editorFile').click();
                                    setTimeout(() => {
                                        document.getElementById('ctxDelete')?.click();
                                    }, 100);
                                };
                            };
                            document.getElementById('editorUndoBtn').onclick = () => document.execCommand('undo');
                            document.getElementById('editorRedoBtn').onclick = () => document.execCommand('redo');
                            document.getElementById('editorHistoryBtn').onclick = function() {
                                document.getElementById('editorFile').click();
                                setTimeout(() => {
                                    const btn = document.getElementById('ctxVersion');
                                    if (btn) btn.click();
                                }, 100);
                            };
                            document.getElementById('editorShareBtn').onclick = function() {
                                const shareUrl = location.origin + location.pathname + '#/editor/' + journalId;
                                const shareTitle = item.name ? decrypt(item.name) : 'Journal';
                                if (navigator.share) {
                                    navigator.share({
                                        title: shareTitle,
                                        text: 'Munetios Docs Suite Journal',
                                        url: shareUrl
                                    }).then(() => {
                                        showToast('Shared!', 'success');
                                    }).catch(() => {
                                        showToast('Share canceled', 'info');
                                    });
                                } else {
                                    modal.innerHTML = `
                                        <div class="modal-content">
                                            <h3>Share Journal</h3>
                                            <div style="margin-bottom:12px;">Share this journal with others by sending this link:</div>
                                            <input type="text" value="${shareUrl}" readonly style="width:100%;padding:12px;border-radius:12px;margin-bottom:12px;">
                                            <button class="btn" id="copyShareLink">Copy Link</button>
                                        </div>
                                    `;
                                    modal.classList.add('active');
                                    document.getElementById('copyShareLink').onclick = function() {
                                        navigator.clipboard.writeText(shareUrl);
                                        showToast('Link copied!', 'success');
                                    };
                                }
                            };
                            document.getElementById('editorFile').onclick = function(e) {
                                e.stopPropagation();
                                const context = document.getElementById('contextwrapperRender');
                                context.innerHTML = `
                                    <div style="position:absolute;top:${e.target.getBoundingClientRect().bottom+8}px;left:${e.target.getBoundingClientRect().left}px;z-index:4000;min-width:220px;">
                                        <div style="padding:8px 0;">
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxMakeCopy">Make a Copy</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxShare">Share</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxDownloadMd">Download as Markdown</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxDownloadTxt">Download as TXT</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxPrint">Print</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxRename">Rename</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxVersion">Version History</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxDetails">Details</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxDelete">Delete</button>
                                            <button style="padding:8px 24px;border-radius:18px;background:none;border:1px solid #590691;color:#590691;font-size:15px;cursor:pointer;" id="ctxCloseBtn">Close</button>
                                        </div>
                                    </div>
                                `;
                                context.style.display = 'block';
                                context.onclick = ev => ev.stopPropagation();

                                function closeContext(ev) {
                                    if (!context.contains(ev.target)) {
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    }
                                }
                                document.addEventListener('mousedown', closeContext);

                                document.getElementById('ctxCloseBtn').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                };

                                document.getElementById('ctxMakeCopy').onclick = function() {
                                    openDB().then(db => {
                                        const tx = db.transaction(STORE_NAME, 'readwrite');
                                        const store = tx.objectStore(STORE_NAME);
                                        store.get(journalId).onsuccess = function(ev) {
                                            const item = ev.target.result;
                                            let copy = Object.assign({}, item);
                                            delete copy.id;
                                            copy.name = encrypt(decrypt(item.name) + ' (Copy)');
                                            copy.created = encrypt(new Date().toISOString());
                                            store.add(copy).onsuccess = function() {
                                                if (typeof showToast === 'function') {
                                                    showToast('Journal copied!', 'success');
                                                }
                                                renderProjects();
                                            };
                                        };
                                    });
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                };

                                document.getElementById('ctxShare').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                    const shareUrl = location.origin + location.pathname + '#/editor/' + journalId;
                                    const shareTitle = item.name ? decrypt(item.name) : 'Journal';
                                    if (navigator.share) {
                                        navigator.share({
                                            title: shareTitle,
                                            text: 'Munetios Docs Suite Journal',
                                            url: shareUrl
                                        }).then(() => {
                                            showToast('Shared!', 'success');
                                        }).catch(() => {
                                            showToast('Share canceled', 'info');
                                        });
                                    } else {
                                        modal.innerHTML = `
                                            <div class="modal-content">
                                                <h3>Share Journal</h3>
                                                <div style="margin-bottom:12px;">Share this journal with others by sending this link:</div>
                                                <input type="text" value="${shareUrl}" readonly style="width:100%;padding:12px;border-radius:12px;margin-bottom:12px;">
                                                <button class="btn" id="copyShareLink">Copy Link</button>
                                            </div>
                                        `;
                                        modal.classList.add('active');
                                        document.getElementById('copyShareLink').onclick = function() {
                                            navigator.clipboard.writeText(shareUrl);
                                            showToast('Link copied!', 'success');
                                        };
                                    }
                                };

                                document.getElementById('ctxDownloadMd').onclick = function() {
                                    let md = journalData.map(page => page.replace(/<[^>]+>/g, '')).join('\n\n---\n\n');
                                    let blob = new Blob([md], { type: 'text/markdown' });
                                    let a = document.createElement('a');
                                    a.href = URL.createObjectURL(blob);
                                    a.download = (item.name ? decrypt(item.name) : 'Journal') + '.md';
                                    document.body.appendChild(a);
                                    a.click();
                                    a.remove();
                                    showToast('Downloaded as Markdown', 'success');
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                };

                                document.getElementById('ctxDownloadTxt').onclick = function() {
                                    let txt = journalData.map(page => page.replace(/<[^>]+>/g, '')).join('\n---\n');
                                    let blob = new Blob([txt], { type: 'text/plain' });
                                    let a = document.createElement('a');
                                    a.href = URL.createObjectURL(blob);
                                    a.download = (item.name ? decrypt(item.name) : 'Journal') + '.txt';
                                    document.body.appendChild(a);
                                    a.click();
                                    a.remove();
                                    showToast('Downloaded as TXT', 'success');
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                };

                                document.getElementById('ctxPrint').onclick = function() {
                                    let printWindow = window.open('', '', 'width=900,height=1200');
                                    let html = journalData.map(page => `<div style="page-break-after:always;padding:48px;background:#fff;font-family:Lexend,sans-serif;font-size:16px;">${page}</div>`).join('');
                                    printWindow.document.write(`
                                        <html><head><title>Print Journal</title></head>
                                        <body>${html}</body></html>
                                    `);
                                    printWindow.document.close();
                                    printWindow.focus();
                                    setTimeout(() => printWindow.print(), 400);
                                    showToast('Print dialog opened', 'info');
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                };

                                document.getElementById('ctxRename').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                    // Ensure modal and journalId are accessible
                                    const modal = document.getElementById('modalUIRender');
                                    // If journalId is not defined, fallback to item.id
                                    const currentJournalId = typeof journalId !== 'undefined' ? journalId : (item && item.id ? item.id : null);
                                    modal.innerHTML = `
                                        <div class="modal-content">
                                            <h3>Rename Journal</h3>
                                            <input type="text" id="renameInput" value="${item.name ? decrypt(item.name) : ''}" style="width:100%;padding:12px;border-radius:12px;margin-bottom:12px;">
                                            <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                                                <button class="btn" id="cancelRename">Cancel</button>
                                                <button class="btn" id="applyRename">Rename</button>
                                            </div>
                                        </div>
                                    `;
                                    modal.classList.add('active');
                                    document.getElementById('cancelRename').onclick = () => modal.classList.remove('active');
                                    document.getElementById('applyRename').onclick = function() {
                                        let newName = document.getElementById('renameInput').value.trim();
                                        if (newName && currentJournalId !== null) {
                                            openDB().then(db => {
                                                const tx = db.transaction(STORE_NAME, 'readwrite');
                                                const store = tx.objectStore(STORE_NAME);
                                                store.get(currentJournalId).onsuccess = function(ev) {
                                                    const journalItem = ev.target.result;
                                                    journalItem.name = encrypt(newName);
                                                    store.put(journalItem).onsuccess = function() {
                                                        if (typeof showToast === 'function') {
                                                            showToast('Renamed!', 'success');
                                                        }
                                                        modal.classList.remove('active');
                                                        renderProjects();
                                                    };
                                                };
                                            });
                                        }
                                    };
                                };

                                document.getElementById('ctxVersion').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                    openDB().then(db => {
                                        const tx = db.transaction(STORE_NAME, 'readonly');
                                        const store = tx.objectStore(STORE_NAME);
                                        store.get(journalId).onsuccess = function(ev) {
                                            const journalItem = ev.target.result;
                                            let history = [];
                                            try {
                                                history = journalItem.history ? JSON.parse(decrypt(journalItem.history)) : [];
                                            } catch { history = []; }
                                            modal.innerHTML = `
                                                <div class="modal-content" style="max-width:900px;">
                                                    <h3>Version History</h3>
                                                    <div style="max-height:480px;overflow:auto;">
                                                        ${history.length ? history.map((h, i) => `
                                                            <div style="padding:12px;border-bottom:1px solid #eee;">
                                                                <div><strong>${new Date(h.time).toLocaleString()}</strong></div>
                                                                <button class="btn" style="margin-top:8px;" data-preview="${i}">Preview</button>
                                                                <div class="version-preview" id="versionPreview${i}" style="display:none;background:#fff;padding:24px;border-radius:12px;max-height:320px;overflow:auto;">
                                                                    ${h.data.map(page => `<div style="margin-bottom:24px;border-radius:16px;box-shadow:0 2px 12px rgba(31,38,135,0.10);padding:24px;background:#fafafa;">${page}</div>`).join('')}
                                                                </div>
                                                                <button class="btn" style="margin-top:12px;" data-restore="${i}">Restore</button>
                                                            </div>
                                                        `).join('') : '<div>No history yet.</div>'}
                                                    </div>
                                                    <button class="btn" style="margin-top:18px;" id="closeHistory">Close</button>
                                                </div>
                                            `;
                                            modal.classList.add('active');
                                            document.getElementById('closeHistory').onclick = () => modal.classList.remove('active');
                                            Array.from(modal.querySelectorAll('[data-restore]')).forEach(btn => {
                                                btn.onclick = function() {
                                                    let idx = btn.getAttribute('data-restore');
                                                    let h = history[idx];
                                                    journalData = h.data;
                                                    renderJournalPages();
                                                    saveJournal(true);
                                                    showToast('Version restored!', 'success');
                                                    modal.classList.remove('active');
                                                };
                                            });
                                            Array.from(modal.querySelectorAll('[data-preview]')).forEach(btn => {
                                                btn.onclick = function() {
                                                    let idx = btn.getAttribute('data-preview');
                                                    let previewDiv = document.getElementById('versionPreview' + idx);
                                                    if (previewDiv.style.display === 'none') {
                                                        previewDiv.style.display = 'block';
                                                        btn.textContent = 'Hide Preview';
                                                    } else {
                                                        previewDiv.style.display = 'none';
                                                        btn.textContent = 'Preview';
                                                    }
                                                };
                                            });
                                        };
                                    });
                                };

                                document.getElementById('ctxDetails').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                    openDB().then(db => {
                                        const tx = db.transaction(STORE_NAME, 'readonly');
                                        const store = tx.objectStore(STORE_NAME);
                                        store.get(journalId).onsuccess = function(ev) {
                                            const journalItem = ev.target.result;
                                            let chars = journalData.reduce((a, b) => a + b.replace(/<[^>]+>/g, '').length, 0);
                                            let size = new Blob([JSON.stringify(journalData)]).size;
                                            modal.innerHTML = `
                                                <div class="modal-content">
                                                    <h3>Journal Details</h3>
                                                    <div><strong>Name:</strong> ${journalItem.name ? decrypt(journalItem.name) : ''}</div>
                                                    <div><strong>Type:</strong> ${journalItem.type ? decrypt(journalItem.type) : ''}</div>
                                                    <div><strong>Created:</strong> ${journalItem.created ? new Date(decrypt(journalItem.created)).toLocaleString() : ''}</div>
                                                    <div><strong>Last Modified:</strong> ${new Date().toLocaleString()}</div>
                                                    <div><strong>Size:</strong> ${size} bytes</div>
                                                    <div><strong>Characters:</strong> ${chars}</div>
                                                    <button class="btn" style="margin-top:18px;" id="closeDetails">Close</button>
                                                </div>
                                            `;
                                            modal.classList.add('active');
                                            document.getElementById('closeDetails').onclick = () => modal.classList.remove('active');
                                        };
                                    });
                                };

                                document.getElementById('ctxDelete').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                    modal.innerHTML = `
                                        <div class="modal-content">
                                            <h3>Delete Journal</h3>
                                            <div>Are you sure you want to delete this journal?</div>
                                            <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                                                <button class="btn" id="cancelDelete">Cancel</button>
                                                <button class="btn" id="confirmDelete">Delete</button>
                                            </div>
                                        </div>
                                    `;
                                    modal.classList.add('active');
                                    document.getElementById('cancelDelete').onclick = () => modal.classList.remove('active');
                                    document.getElementById('confirmDelete').onclick = function() {
                                        modal.innerHTML = `
                                            <div class="modal-content">
                                                <h3>Confirm Permanent Delete</h3>
                                                <div>This action cannot be undone. Delete permanently?</div>
                                                <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                                                    <button class="btn" id="cancelPermDelete">Cancel</button>
                                                    <button class="btn" id="confirmPermDelete">Delete Permanently</button>
                                                </div>
                                            </div>
                                        `;
                                        document.getElementById('cancelPermDelete').onclick = () => modal.classList.remove('active');
                                        document.getElementById('confirmPermDelete').onclick = function() {
                                            openDB().then(db => {
                                                const tx = db.transaction(STORE_NAME, 'readwrite');
                                                const store = tx.objectStore(STORE_NAME);
                                                store.delete(journalId).onsuccess = function() {
                                                    showToast('Deleted!', 'success');
                                                    modal.classList.remove('active');
                                                    location.hash = '';
                                                    renderProjects();
                                                };
                                            });
                                        };
                                    };
                                };
                            };
                            function renderJournalPages() {
                                const journalPages = document.getElementById('journalPages');
                                journalPages.innerHTML = '';
                                journalData.forEach((content, idx) => {
                                    const page = document.createElement('div');
                                    page.className = 'journalPage';
                                    page.contentEditable = true;
                                    page.spellcheck = true;
                                    page.style.background = '#fff';
                                    page.style.width = '600px';
                                    page.style.height = '800px';
                                    page.style.boxShadow = '0 8px 32px 0 rgba(31,38,135,0.18)';
                                    page.style.borderRadius = '24px';
                                    page.style.padding = '32px';
                                    page.style.overflow = 'auto';
                                    page.style.outline = 'none';
                                    page.style.fontFamily = 'Lexend,sans-serif';
                                    page.style.fontSize = '16px';
                                    page.style.marginBottom = '32px';
                                    page.setAttribute('data-page', idx);
                                    page.innerHTML = content;
                                    page.addEventListener('input', () => {
                                        journalData[idx] = page.innerHTML;
                                        makeJournalImagesResponsive();
                                        saveJournal(true);
                                    });
                                    journalPages.appendChild(page);
                                });
                                makeJournalImagesResponsive();
                            }

                            function saveJournal(auto = false) {
                                makeJournalImagesResponsive();
                                openDB().then(db => {
                                    const tx = db.transaction(STORE_NAME, 'readwrite');
                                    const store = tx.objectStore(STORE_NAME);
                                    store.get(journalId).onsuccess = function(ev) {
                                        const journalItem = ev.target.result;
                                        journalItem.content = encrypt(JSON.stringify(journalData));
                                        // Update history
                                        let history = [];
                                        try {
                                            history = journalItem.history ? JSON.parse(decrypt(journalItem.history)) : [];
                                        } catch { history = []; }
                                        history.push({
                                            time: new Date().toISOString(),
                                            data: [...journalData]
                                        });
                                        journalItem.history = encrypt(JSON.stringify(history));
                                        store.put(journalItem);
                                    };
                                });
                                if (!auto) {
                                    document.getElementById('journalSaveBtn').style.background = '#b6f7c1';
                                    setTimeout(() => document.getElementById('journalSaveBtn').style.background = '', 600);
                                }
                            }

                            function makeJournalImagesResponsive() {
                                const imgs = document.getElementById('journalPages').querySelectorAll('img');
                                imgs.forEach(img => {
                                    img.style.maxWidth = '100%';
                                    img.style.height = 'auto';
                                    img.style.display = 'block';
                                    img.style.margin = '12px auto';
                                });
                            }

                            // Toolbar actions
                            document.getElementById('journalBoldBtn').onclick = () => document.execCommand('bold');
                            document.getElementById('journalItalicBtn').onclick = () => document.execCommand('italic');
                            document.getElementById('journalUnderlineBtn').onclick = () => document.execCommand('underline');
                            document.getElementById('journalStrikeBtn').onclick = () => document.execCommand('strikeThrough');
                            document.getElementById('journalTextColorPicker').oninput = e => document.execCommand('foreColor', false, e.target.value);

                            document.getElementById('journalFontFamilyPicker').onchange = e => {
                                const fontMap = {
                                    "Lexend": "Lexend, Arial, sans-serif",
                                    "Arial": "Arial, sans-serif",
                                    "Calibri": "Calibri, Arial, sans-serif",
                                    "Comic Sans MS": "'Comic Sans MS', cursive",
                                    "Consolas": "Consolas, monospace",
                                    "Courier New": "'Courier New', monospace",
                                    "Georgia": "Georgia, serif",
                                    "Impact": "Impact, sans-serif",
                                    "Microsoft Sans Serif": "'Microsoft Sans Serif', sans-serif",
                                    "Noto Sans": "'Noto Sans', sans-serif",
                                    "Noto Serif": "'Noto Serif', serif",
                                    "Open Sans": "'Open Sans', sans-serif",
                                    "Poppins": "Poppins, sans-serif",
                                    "Roboto": "Roboto, sans-serif",
                                    "Segoe UI": "'Segoe UI', sans-serif",
                                    "Times New Roman": "'Times New Roman', serif"
                                };
                                let val = e.target.value;
                                let execVal = fontMap[val] || val;
                                document.execCommand('fontName', false, execVal);
                            };

                            document.getElementById('journalImageBtn').onclick = () => {
                                const modal = document.getElementById('modalUIRender');
                                modal.innerHTML = `
                                    <div class="modal-content">
                                        <h3>Insert Image</h3>
                                        <input type="url" id="journalImgUrl" placeholder="Image URL" style="width:100%;padding:12px;border-radius:12px;margin-bottom:12px;">
                                        <div style="margin-bottom:12px;text-align:center;">or</div>
                                        <input type="file" id="journalImgFile" accept="image/*" style="width:100%;padding:12px;border-radius:12px;">
                                        <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                                            <button class="btn" id="cancelJournalImg">Cancel</button>
                                            <button class="btn" id="applyJournalImg">Insert</button>
                                        </div>
                                    </div>
                                `;
                                modal.classList.add('active');
                                document.getElementById('cancelJournalImg').onclick = () => modal.classList.remove('active');
                                document.getElementById('applyJournalImg').onclick = () => {
                                    let url = document.getElementById('journalImgUrl').value;
                                    let fileInput = document.getElementById('journalImgFile');
                                    if (url) {
                                        document.execCommand('insertImage', false, url);
                                        makeJournalImagesResponsive();
                                        modal.classList.remove('active');
                                    } else if (fileInput.files.length) {
                                        const file = fileInput.files[0];
                                        const reader = new FileReader();
                                        reader.onload = function(ev) {
                                            document.execCommand('insertImage', false, ev.target.result);
                                            makeJournalImagesResponsive();
                                            modal.classList.remove('active');
                                        };
                                        reader.readAsDataURL(file);
                                    }
                                };
                            };

                            // Video: file only, not URL
                            document.getElementById('journalVideoBtn').onclick = () => {
                                const modal = document.getElementById('modalUIRender');
                                modal.innerHTML = `
                                    <div class="modal-content">
                                        <h3>Insert Video</h3>
                                        <input type="file" id="journalVideoFile" accept="video/*" style="width:100%;padding:12px;border-radius:12px;">
                                        <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                                            <button class="btn" id="cancelJournalVideo">Cancel</button>
                                            <button class="btn" id="applyJournalVideo">Insert</button>
                                        </div>
                                    </div>
                                `;
                                modal.classList.add('active');
                                document.getElementById('cancelJournalVideo').onclick = () => modal.classList.remove('active');
                                document.getElementById('applyJournalVideo').onclick = () => {
                                    let fileInput = document.getElementById('journalVideoFile');
                                    if (fileInput.files.length) {
                                        const file = fileInput.files[0];
                                        const reader = new FileReader();
                                        reader.onload = function(ev) {
                                            let videoHtml = `<video controls style="max-width:100%;height:auto;"><source src="${ev.target.result}"></video>`;
                                            let sel = window.getSelection();
                                            let page = document.activeElement.classList.contains('journalPage') ? document.activeElement : document.querySelector('.journalPage');
                                            if (sel && sel.rangeCount > 0 && page.contains(sel.anchorNode)) {
                                                let range = sel.getRangeAt(0);
                                                range.insertNode(document.createRange().createContextualFragment(videoHtml));
                                            } else {
                                                page.insertAdjacentHTML('beforeend', videoHtml);
                                            }
                                            // Update journalData for this page so video persists after reload
                                            let idx = page.getAttribute('data-page');
                                            if (typeof idx !== 'undefined' && idx !== null) {
                                                journalData[idx] = page.innerHTML;
                                            }
                                            modal.classList.remove('active');
                                            saveJournal(true);
                                        };
                                        reader.readAsDataURL(file);
                                    }
                                };
                            };

                            document.getElementById('journalSaveBtn').onclick = () => saveJournal();

                            document.getElementById('addJournalPageBtn').onclick = () => {
                                journalData.push("");
                                renderJournalPages();
                                saveJournal(true);
                            };

                            // Auto save every 5 seconds
                            setInterval(() => saveJournal(true), 5000);
                        } else if (item && decrypt(item.type) === 'Spreadsheet') {
                            // Spreadsheet editor UI
                            const sheetRows = 100; // Initial visible rows, can scroll to more
                            const sheetCols = 26; // A-Z columns
                            let maxRows = 36767;
                            let spreadsheetData = [];
                            let sheetId = item.id;

                            // Load spreadsheet data
                            openDB().then(db => {
                                const tx = db.transaction(STORE_NAME, 'readonly');
                                const store = tx.objectStore(STORE_NAME);
                                store.get(sheetId).onsuccess = function(ev) {
                                    const sheetItem = ev.target.result;
                                    if (sheetItem && sheetItem.content) {
                                        try {
                                            spreadsheetData = JSON.parse(decrypt(sheetItem.content));
                                            if (!Array.isArray(spreadsheetData)) spreadsheetData = [];
                                        } catch {
                                            spreadsheetData = [];
                                        }
                                    } else {
                                        spreadsheetData = [];
                                    }
                                    renderSheet();
                                };
                            });
                            document.getElementById('editorSearchBtn').onclick = function () {
                                let existingBar = document.getElementById('floatingSheetSearchBar');
                                if (existingBar) {
                                    existingBar.style.display = 'block';
                                    document.getElementById('sheetSearchInput').focus();
                                    return;
                                }
                                let searchBar = document.createElement('div');
                                searchBar.id = 'floatingSheetSearchBar';
                                searchBar.style.position = 'fixed';
                                searchBar.style.top = '100px';
                                searchBar.style.left = '50%';
                                searchBar.style.transform = 'translateX(-50%)';
                                searchBar.style.zIndex = '5000';
                                searchBar.style.background = 'rgba(255,255,255,0.95)';
                                searchBar.style.boxShadow = '0 8px 32px 0 rgba(31,38,135,0.18)';
                                searchBar.style.borderRadius = '24px';
                                searchBar.style.padding = '24px 24px 18px 24px';
                                searchBar.style.maxWidth = '400px';
                                searchBar.style.width = '100%';
                                searchBar.innerHTML = `
                                    <div style="display:flex;align-items:center;justify-content:space-between;">
                                        <h3 style="margin:0;">Search Spreadsheet</h3>
                                        <button class="btn" id="closeSheetSearchBar" style="padding:4px 12px;font-size:18px;">&#10005;</button>
                                    </div>
                                    <input type="text" id="sheetSearchInput" placeholder="Find text..." style="width:100%;padding:12px;border-radius:12px;margin:18px 0 0 0;">
                                    <div id="sheetSearchResult" style="margin-top:12px;color:#590691;"></div>
                                `;
                                document.body.appendChild(searchBar);
                                document.getElementById('sheetSearchInput').focus();
                                document.getElementById('closeSheetSearchBar').onclick = function () {
                                    searchBar.style.display = 'none';
                                };
                                document.getElementById('sheetSearchInput').oninput = function () {
                                    const val = this.value;
                                    let found = false;
                                    let result = '';
                                    if (!val) {
                                        document.getElementById('sheetSearchResult').textContent = '';
                                        return;
                                    }
                                    spreadsheetData.forEach((row, r) => {
                                        if (row) row.forEach((cell, c) => {
                                            if (cell && cell.value && cell.value.includes(val)) {
                                                found = true;
                                                result += `Found in row ${r + 1}, col ${String.fromCharCode(65 + c)}. `;
                                            }
                                        });
                                    });
                                    document.getElementById('sheetSearchResult').textContent = found ? result : 'Not found';
                                };
                            };

                            document.getElementById('editorUndoBtn').onclick = () => document.execCommand('undo');
                            document.getElementById('editorRedoBtn').onclick = () => document.execCommand('redo');

                            document.getElementById('editorHistoryBtn').onclick = function() {
                                document.getElementById('editorFile').click();
                                setTimeout(() => {
                                    const btn = document.getElementById('ctxVersion');
                                    if (btn) btn.click();
                                }, 100);
                            };

                            document.getElementById('editorShareBtn').onclick = function() {
                                const shareUrl = location.origin + location.pathname + '#/editor/' + sheetId;
                                const shareTitle = item.name ? decrypt(item.name) : 'Spreadsheet';
                                if (navigator.share) {
                                    navigator.share({
                                        title: shareTitle,
                                        text: 'Munetios Docs Suite Spreadsheet',
                                        url: shareUrl
                                    }).then(() => {
                                        showToast('Shared!', 'success');
                                    }).catch(() => {
                                        showToast('Share canceled', 'info');
                                    });
                                } else {
                                    modal.innerHTML = `
                                        <div class="modal-content">
                                            <h3>Share Spreadsheet</h3>
                                            <div style="margin-bottom:12px;">Share this spreadsheet with others by sending this link:</div>
                                            <input type="text" value="${shareUrl}" readonly style="width:100%;padding:12px;border-radius:12px;margin-bottom:12px;">
                                            <button class="btn" id="copyShareLink">Copy Link</button>
                                        </div>
                                    `;
                                    modal.classList.add('active');
                                    document.getElementById('copyShareLink').onclick = function() {
                                        navigator.clipboard.writeText(shareUrl);
                                        showToast('Link copied!', 'success');
                                    };
                                }
                            };

                            document.getElementById('editorMoreBtn').onclick = function(e) {
                                e.stopPropagation();
                                const context = document.getElementById('contextwrapperRender');
                                context.innerHTML = `
                                    <div style="position:absolute;top:${e.target.getBoundingClientRect().bottom+8}px;left:${e.target.getBoundingClientRect().left}px;z-index:4000;min-width:220px;">
                                        <div style="padding:8px 0;">
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxMakeCopy">Make a Copy</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxPrint">Print</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxDownload">Download (.xlsx)</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxDownloadCsv">Download as CSV</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxRename">Rename</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxVersion">Version History</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxDetails">Details</button>
                                            <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxDelete">Delete</button>
                                            <button style="padding:8px 24px;border-radius:18px;background:none;border:1px solid #590691;color:#590691;font-size:15px;cursor:pointer;" id="ctxCloseMore">Close</button>
                                        </div>
                                    </div>
                                `;
                                context.style.display = 'block';
                                context.onclick = ev => ev.stopPropagation();
                                function closeContext(ev) {
                                    if (!context.contains(ev.target)) {
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    }
                                }
                                document.addEventListener('mousedown', closeContext);
                                document.getElementById('ctxCloseMore').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                };
                                document.getElementById('ctxMakeCopy').onclick = function() {
                                    openDB().then(db => {
                                        const tx = db.transaction(STORE_NAME, 'readwrite');
                                        const store = tx.objectStore(STORE_NAME);
                                        store.get(sheetId).onsuccess = function(ev) {
                                            const item = ev.target.result;
                                            let copy = Object.assign({}, item);
                                            delete copy.id;
                                            copy.name = encrypt(decrypt(item.name) + ' (Copy)');
                                            copy.created = encrypt(new Date().toISOString());
                                            store.add(copy).onsuccess = function() {
                                                showToast('Spreadsheet copied!', 'success');
                                                renderProjects();
                                            };
                                        };
                                    });
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                };
                                document.getElementById('ctxPrint').onclick = function() {
                                    let printWindow = window.open('', '', 'width=900,height=1200');
                                    let html = '<table border="1" style="border-collapse:collapse;width:100%;">' +
                                        spreadsheetData.map(row => '<tr>' + (row ? row.map(cell => `<td>${cell && cell.value ? cell.value : ''}</td>`).join('') : '') + '</tr>').join('') +
                                        '</table>';
                                    printWindow.document.write(`
                                        <html><head><title>Print Spreadsheet</title></head>
                                        <body>${html}</body></html>
                                    `);
                                    printWindow.document.close();
                                    printWindow.focus();
                                    setTimeout(() => printWindow.print(), 400);
                                    showToast('Print dialog opened', 'info');
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                };
                                document.getElementById('ctxDownload').onclick = function() {
                                    let csv = spreadsheetData.map(row => row ? row.map(cell => cell && cell.value ? `"${cell.value.replace(/"/g, '""')}"` : '').join(',') : '').join('\n');
                                    let blob = new Blob([csv], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                                    let a = document.createElement('a');
                                    a.href = URL.createObjectURL(blob);
                                    a.download = (item.name ? decrypt(item.name) : 'Spreadsheet') + '.xlsx';
                                    document.body.appendChild(a);
                                    a.click();
                                    a.remove();
                                    showToast('Downloaded as .xlsx', 'success');
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                };
                                document.getElementById('ctxDownloadCsv').onclick = function() {
                                    let csv = spreadsheetData.map(row => row ? row.map(cell => cell && cell.value ? `"${cell.value.replace(/"/g, '""')}"` : '').join(',') : '').join('\n');
                                    let blob = new Blob([csv], { type: 'text/csv' });
                                    let a = document.createElement('a');
                                    a.href = URL.createObjectURL(blob);
                                    a.download = (item.name ? decrypt(item.name) : 'Spreadsheet') + '.csv';
                                    document.body.appendChild(a);
                                    a.click();
                                    a.remove();
                                    showToast('Downloaded as CSV', 'success');
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                };
                                document.getElementById('ctxRename').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                    modal.innerHTML = `
                                        <div class="modal-content">
                                            <h3>Rename Spreadsheet</h3>
                                            <input type="text" id="renameInput" value="${item.name ? decrypt(item.name) : ''}" style="width:100%;padding:12px;border-radius:12px;margin-bottom:12px;">
                                            <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                                                <button class="btn" id="cancelRename">Cancel</button>
                                                <button class="btn" id="applyRename">Rename</button>
                                            </div>
                                        </div>
                                    `;
                                    modal.classList.add('active');
                                    document.getElementById('cancelRename').onclick = () => modal.classList.remove('active');
                                    document.getElementById('applyRename').onclick = function() {
                                        let newName = document.getElementById('renameInput').value.trim();
                                        if (newName) {
                                            openDB().then(db => {
                                                const tx = db.transaction(STORE_NAME, 'readwrite');
                                                const store = tx.objectStore(STORE_NAME);
                                                store.get(sheetId).onsuccess = function(ev) {
                                                    const sheetItem = ev.target.result;
                                                    sheetItem.name = encrypt(newName);
                                                    store.put(sheetItem).onsuccess = function() {
                                                        showToast('Renamed!', 'success');
                                                        modal.classList.remove('active');
                                                        renderProjects();
                                                    };
                                                };
                                            });
                                        }
                                    };
                                };
                                document.getElementById('ctxVersion').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                    openDB().then(db => {
                                        const tx = db.transaction(STORE_NAME, 'readonly');
                                        const store = tx.objectStore(STORE_NAME);
                                        store.get(sheetId).onsuccess = function(ev) {
                                            const sheetItem = ev.target.result;
                                            let history = [];
                                            try {
                                                history = sheetItem.history ? JSON.parse(decrypt(sheetItem.history)) : [];
                                            } catch { history = []; }
                                            modal.innerHTML = `
                                                <div class="modal-content" style="max-width:900px;">
                                                    <h3>Version History</h3>
                                                    <div style="max-height:480px;overflow:auto;">
                                                        ${history.length ? history.map((h, i) => `
                                                            <div style="padding:12px;border-bottom:1px solid #eee;">
                                                                <div><strong>${new Date(h.time).toLocaleString()}</strong></div>
                                                                <button class="btn" style="margin-top:8px;" data-preview="${i}">Preview</button>
                                                                <div class="version-preview" id="versionPreview${i}" style="display:none;background:#fff;padding:24px;border-radius:12px;max-height:320px;overflow:auto;">
                                                                    <table border="1" style="border-collapse:collapse;width:100%;">
                                                                        ${h.data.map(row => `<tr>${row ? row.map(cell => `<td>${cell && cell.value ? cell.value : ''}</td>`).join('') : ''}</tr>`).join('')}
                                                                    </table>
                                                                </div>
                                                                <button class="btn" style="margin-top:12px;" data-restore="${i}">Restore</button>
                                                            </div>
                                                        `).join('') : '<div>No history yet.</div>'}
                                                    </div>
                                                    <button class="btn" style="margin-top:18px;" id="closeHistory">Close</button>
                                                </div>
                                            `;
                                            modal.classList.add('active');
                                            document.getElementById('closeHistory').onclick = () => modal.classList.remove('active');
                                            Array.from(modal.querySelectorAll('[data-restore]')).forEach(btn => {
                                                btn.onclick = function() {
                                                    let idx = btn.getAttribute('data-restore');
                                                    let h = history[idx];
                                                    spreadsheetData = h.data;
                                                    renderSheet();
                                                    saveSheet(true);
                                                    showToast('Version restored!', 'success');
                                                    modal.classList.remove('active');
                                                };
                                            });
                                            Array.from(modal.querySelectorAll('[data-preview]')).forEach(btn => {
                                                btn.onclick = function() {
                                                    let idx = btn.getAttribute('data-preview');
                                                    let previewDiv = document.getElementById('versionPreview' + idx);
                                                    if (previewDiv.style.display === 'none') {
                                                        previewDiv.style.display = 'block';
                                                        btn.textContent = 'Hide Preview';
                                                    } else {
                                                        previewDiv.style.display = 'none';
                                                        btn.textContent = 'Preview';
                                                    }
                                                };
                                            });
                                        };
                                    });
                                };
                                document.getElementById('ctxDetails').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                    openDB().then(db => {
                                        const tx = db.transaction(STORE_NAME, 'readonly');
                                        const store = tx.objectStore(STORE_NAME);
                                        store.get(sheetId).onsuccess = function(ev) {
                                            const sheetItem = ev.target.result;
                                            let cells = 0;
                                            spreadsheetData.forEach(row => {
                                                if (row) row.forEach(cell => {
                                                    if (cell && cell.value && cell.value.trim()) cells++;
                                                });
                                            });
                                            let size = new Blob([JSON.stringify(spreadsheetData)]).size;
                                            modal.innerHTML = `
                                                <div class="modal-content">
                                                    <h3>Spreadsheet Details</h3>
                                                    <div><strong>Name:</strong> ${sheetItem.name ? decrypt(sheetItem.name) : ''}</div>
                                                    <div><strong>Type:</strong> ${sheetItem.type ? decrypt(sheetItem.type) : ''}</div>
                                                    <div><strong>Created:</strong> ${sheetItem.created ? new Date(decrypt(sheetItem.created)).toLocaleString() : ''}</div>
                                                    <div><strong>Last Modified:</strong> ${new Date().toLocaleString()}</div>
                                                    <div><strong>Size:</strong> ${size} bytes</div>
                                                    <div><strong>Non-empty cells:</strong> ${cells}</div>
                                                    <button class="btn" style="margin-top:18px;" id="closeDetails">Close</button>
                                                </div>
                                            `;
                                            modal.classList.add('active');
                                            document.getElementById('closeDetails').onclick = () => modal.classList.remove('active');
                                        };
                                    });
                                };
                                document.getElementById('ctxDelete').onclick = function() {
                                    context.style.display = 'none';
                                    document.removeEventListener('mousedown', closeContext);
                                    modal.innerHTML = `
                                        <div class="modal-content">
                                            <h3>Delete Spreadsheet</h3>
                                            <div>Are you sure you want to delete this spreadsheet?</div>
                                            <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                                                <button class="btn" id="cancelDelete">Cancel</button>
                                                <button class="btn" id="confirmDelete">Delete</button>
                                            </div>
                                        </div>
                                    `;
                                    modal.classList.add('active');
                                    document.getElementById('cancelDelete').onclick = () => modal.classList.remove('active');
                                    document.getElementById('confirmDelete').onclick = function() {
                                        modal.innerHTML = `
                                            <div class="modal-content">
                                                <h3>Confirm Permanent Delete</h3>
                                                <div>This action cannot be undone. Delete permanently?</div>
                                                <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                                                    <button class="btn" id="cancelPermDelete">Cancel</button>
                                                    <button class="btn" id="confirmPermDelete">Delete Permanently</button>
                                                </div>
                                            </div>
                                        `;
                                        document.getElementById('cancelPermDelete').onclick = () => modal.classList.remove('active');
                                        document.getElementById('confirmPermDelete').onclick = function() {
                                            openDB().then(db => {
                                                const tx = db.transaction(STORE_NAME, 'readwrite');
                                                const store = tx.objectStore(STORE_NAME);
                                                store.delete(sheetId).onsuccess = function() {
                                                    showToast('Deleted!', 'success');
                                                    modal.classList.remove('active');
                                                    location.hash = '';
                                                    renderProjects();
                                                };
                                            });
                                        };
                                    };
                                };
                            };
                            // Toolbar HTML (SVG icons, more fonts)
                            const spreadsheetToolbarHTML = `
                                <div class="toolbar" id="spreadsheetToolbar" style="overflow-x:auto; gap:8px; white-space:nowrap; scrollbar-width:thin;">
                                    <div class="toolbar-group" style="display:inline-flex;">
                                        <button title="Format as Currency" id="formatCurrencyBtn">
                                            <svg width="22" height="22" viewBox="0 0 22 22" fill="none"><text x="4" y="17" font-family="Arial" font-size="16" font-weight="bold" fill="currentColor">$</text></svg>
                                        </button>
                                        <button title="Format as Percent" id="formatPercentBtn">
                                            <svg width="22" height="22" viewBox="0 0 22 22" fill="none"><text x="4" y="17" font-family="Arial" font-size="16" font-weight="bold" fill="currentColor">%</text></svg>
                                        </button>
                                        <select id="spreadsheetFontFamilyPicker" title="Font Family" style="margin-left:8px;padding:6px 12px;border-radius:12px;border:1px solid #ccc;background:#fff;">
                                            <option value="Lexend" style="font-family:Lexend,sans-serif;">Lexend</option>
                                            <option value="Arial" style="font-family:Arial,sans-serif;">Arial</option>
                                            <option value="Calibri" style="font-family:Calibri,sans-serif;">Calibri</option>
                                            <option value="Consolas" style="font-family:Consolas,monospace;">Consolas</option>
                                            <option value="Roboto" style="font-family:Roboto,sans-serif;">Roboto</option>
                                            <option value="Open Sans" style="font-family:'Open Sans',sans-serif;">Open Sans</option>
                                            <option value="Montserrat" style="font-family:Montserrat,sans-serif;">Montserrat</option>
                                            <option value="Lato" style="font-family:Lato,sans-serif;">Lato</option>
                                            <option value="Georgia" style="font-family:Georgia,serif;">Georgia</option>
                                            <option value="Noto Sans" style="font-family:'Noto Sans',sans-serif;">Noto Sans</option>
                                            <option value="Noto Serif" style="font-family:'Noto Serif',serif;">Noto Serif</option>
                                            <option value="Poppins" style="font-family:Poppins,sans-serif;">Poppins</option>
                                            <option value="Segoe UI" style="font-family:'Segoe UI',sans-serif;">Segoe UI</option>
                                            <option value="Times New Roman" style="font-family:'Times New Roman',serif;">Times New Roman</option>
                                            <option value="Fira Sans" style="font-family:'Fira Sans',sans-serif;">Fira Sans</option>
                                            <option value="Manrope" style="font-family:Manrope,sans-serif;">Manrope</option>
                                            <option value="Mulish" style="font-family:Mulish,sans-serif;">Mulish</option>
                                            <option value="Overpass" style="font-family:Overpass,sans-serif;">Overpass</option>
                                            <option value="Rubik" style="font-family:Rubik,sans-serif;">Rubik</option>
                                            <option value="Sarabun" style="font-family:Sarabun,sans-serif;">Sarabun</option>
                                            <option value="Space Mono" style="font-family:'Space Mono',monospace;">Space Mono</option>
                                            <option value="Syne" style="font-family:Syne,sans-serif;">Syne</option>
                                            <option value="Zilla Slab" style="font-family:'Zilla Slab',serif;">Zilla Slab</option>
                                            <option value="Quicksand" style="font-family:Quicksand,sans-serif;">Quicksand</option>
                                            <option value="PT Sans" style="font-family:'PT Sans',sans-serif;">PT Sans</option>
                                            <option value="PT Serif" style="font-family:'PT Serif',serif;">PT Serif</option>
                                        </select>
                                        <input id="spreadsheetFontSizeInput" type="number" min="8" max="72" value="16" title="Font Size" style="margin-left:8px;width:56px;padding:6px 12px;border-radius:12px;border:1px solid #ccc;background:#fff;">
                                    </div>
                                    <div class="toolbar-group" style="display:inline-flex;">
                                        <button title="Bold" id="spreadsheetBoldBtn">
                                            <svg width="22" height="22" viewBox="0 0 22 22"><text x="4" y="17" font-family="Arial" font-size="16" font-weight="bold" fill="currentColor">B</text></svg>
                                        </button>
                                        <button title="Italic" id="spreadsheetItalicBtn">
                                            <svg width="22" height="22" viewBox="0 0 22 22"><text x="4" y="17" font-family="Arial" font-size="16" font-style="italic" fill="currentColor">I</text></svg>
                                        </button>
                                        <button title="Underline" id="spreadsheetUnderlineBtn">
                                            <svg width="22" height="22" viewBox="0 0 22 22"><text x="4" y="17" font-family="Arial" font-size="16" fill="currentColor">U</text><line x1="4" y1="19" x2="18" y2="19" stroke="currentColor" stroke-width="2"/></svg>
                                        </button>
                                        <button title="Strikethrough" id="spreadsheetStrikeBtn">
                                            <svg width="22" height="22" viewBox="0 0 22 22"><text x="4" y="17" font-family="Arial" font-size="16" fill="currentColor">S</text><line x1="4" y1="12" x2="18" y2="12" stroke="currentColor" stroke-width="2"/></svg>
                                        </button>
                                    </div>
                                    <div class="toolbar-group" style="display:inline-flex;">
                                        <button title="Align Left" id="spreadsheetAlignLeftBtn">
                                            <svg width="22" height="22" viewBox="0 0 22 22"><rect x="4" y="6" width="14" height="2" fill="currentColor"/><rect x="4" y="10" width="10" height="2" fill="currentColor"/><rect x="4" y="14" width="14" height="2" fill="currentColor"/></svg>
                                        </button>
                                        <button title="Align Center" id="spreadsheetAlignCenterBtn">
                                            <svg width="22" height="22" viewBox="0 0 22 22"><rect x="4" y="6" width="14" height="2" fill="currentColor"/><rect x="7" y="10" width="8" height="2" fill="currentColor"/><rect x="4" y="14" width="14" height="2" fill="currentColor"/></svg>
                                        </button>
                                        <button title="Align Right" id="spreadsheetAlignRightBtn">
                                            <svg width="22" height="22" viewBox="0 0 22 22"><rect x="4" y="6" width="14" height="2" fill="currentColor"/><rect x="8" y="10" width="10" height="2" fill="currentColor"/><rect x="4" y="14" width="14" height="2" fill="currentColor"/></svg>
                                        </button>
                                    </div>
                                    <div class="toolbar-group" style="display:inline-flex;">
                                        <button title="Align Top" id="spreadsheetAlignTopBtn">
                                            <svg width="22" height="22" viewBox="0 0 22 22"><rect x="10" y="4" width="2" height="14" fill="currentColor"/><rect x="4" y="4" width="14" height="2" fill="currentColor"/></svg>
                                        </button>
                                        <button title="Align Middle" id="spreadsheetAlignMiddleBtn">
                                            <svg width="22" height="22" viewBox="0 0 22 22"><rect x="10" y="4" width="2" height="14" fill="currentColor"/><rect x="4" y="10" width="14" height="2" fill="currentColor"/></svg>
                                        </button>
                                        <button title="Align Bottom" id="spreadsheetAlignBottomBtn">
                                            <svg width="22" height="22" viewBox="0 0 22 22"><rect x="10" y="4" width="2" height="14" fill="currentColor"/><rect x="4" y="16" width="14" height="2" fill="currentColor"/></svg>
                                        </button>
                                    </div>
                                    <div class="toolbar-group" style="display:inline-flex;">
                                        <button title="Insert Table" id="spreadsheetInsertTableBtn">
                                            <svg width="22" height="22" viewBox="0 0 22 22"><rect x="3" y="3" width="16" height="16" rx="2" stroke="currentColor" stroke-width="2"/><line x1="3" y1="9" x2="19" y2="9" stroke="currentColor" stroke-width="2"/><line x1="3" y1="15" x2="19" y2="15" stroke="currentColor" stroke-width="2"/><line x1="9" y1="3" x2="9" y2="19" stroke="currentColor" stroke-width="2"/><line x1="15" y1="3" x2="15" y2="19" stroke="currentColor" stroke-width="2"/></svg>
                                        </button>
                                        <button title="Insert Chart" id="spreadsheetInsertChartBtn">
                                            <svg width="22" height="22" viewBox="0 0 22 22"><rect x="4" y="14" width="2" height="4" fill="currentColor"/><rect x="8" y="10" width="2" height="8" fill="currentColor"/><rect x="12" y="6" width="2" height="12" fill="currentColor"/><rect x="16" y="2" width="2" height="16" fill="currentColor"/></svg>
                                        </button>
                                        <button title="Insert Dropdown" id="spreadsheetInsertDropdownBtn">
                                            <svg width="22" height="22" viewBox="0 0 22 22"><polygon points="6,8 16,8 11,16" fill="currentColor"/></svg>
                                        </button>
                                    </div>
                                    <div class="toolbar-group" style="display:inline-flex;">
                                        <button title="Text Wrap" id="spreadsheetWrapBtn">
                                            <svg width="22" height="22" viewBox="0 0 22 22"><rect x="4" y="6" width="14" height="2" fill="currentColor"/><rect x="4" y="10" width="8" height="2" fill="currentColor"/><rect x="4" y="14" width="14" height="2" fill="currentColor"/><rect x="4" y="18" width="14" height="2" fill="currentColor"/></svg>
                                        </button>
                                        <button title="Text Overflow" id="spreadsheetOverflowBtn">
                                            <svg width="22" height="22" viewBox="0 0 22 22"><rect x="4" y="6" width="14" height="2" fill="currentColor"/><rect x="4" y="10" width="14" height="2" fill="currentColor"/><rect x="4" y="14" width="14" height="2" fill="currentColor"/></svg>
                                        </button>
                                        <button title="Text Clip" id="spreadsheetClipBtn">
                                            <svg width="22" height="22" viewBox="0 0 22 22"><rect x="4" y="6" width="14" height="2" fill="currentColor"/><rect x="4" y="10" width="8" height="2" fill="currentColor"/><rect x="4" y="14" width="8" height="2" fill="currentColor"/></svg>
                                        </button>
                                    </div>
                                    <div class="toolbar-group" style="display:inline-flex;">
                                        <button title="Save" id="spreadsheetSaveBtn">
                                            <svg width="22" height="22" viewBox="0 0 22 22"><rect x="3" y="3" width="16" height="16" rx="2" stroke="currentColor" stroke-width="2"/><path d="M7 3V8H15V3" stroke="currentColor" stroke-width="2"/><rect x="7" y="14" width="8" height="3" rx="1" fill="currentColor"/></svg>
                                        </button>
                                    </div>
                                </div>
                            `;

                            // Sheet HTML (ABC, 123 bars black)
                            const spreadsheetSheetHTML = `
                                <div id="spreadsheetSheetWrapper" style="overflow:auto;max-height:calc(100vh - 160px);padding:24px;">
                                    <table id="spreadsheetTable" style="border-collapse:collapse;min-width:900px;">
                                        <thead>
                                            <tr>
                                                <th style="position:sticky;left:0;background:#111;color:#fff;z-index:2;"></th>
                                                ${Array.from({length:sheetCols},(_,i)=>`<th style="background:#111;color:#fff;position:sticky;top:0;z-index:2;">${String.fromCharCode(65+i)}</th>`).join('')}
                                            </tr>
                                        </thead>
                                        <tbody id="spreadsheetTableBody"></tbody>
                                    </table>
                                </div>
                            `;

                            document.querySelector('.editor-content').innerHTML = spreadsheetToolbarHTML + spreadsheetSheetHTML;
                            document.querySelector('.editor-content').style.display = 'block';
                                // File button for Spreadsheet type
                                document.getElementById('editorFile').onclick = function(e) {
                                    e.stopPropagation();
                                    const context = document.getElementById('contextwrapperRender');
                                    context.innerHTML = `
                                        <div style="position:absolute;top:${e.target.getBoundingClientRect().bottom+8}px;left:${e.target.getBoundingClientRect().left}px;z-index:4000;min-width:220px;">
                                            <div style="padding:8px 0;">
                                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxMakeCopy">Make a Copy</button>
                                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxShare">Share</button>
                                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxDownload">Download (.xlsx)</button>
                                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxDownloadCsv">Download as CSV</button>
                                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxPrint">Print</button>
                                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxRename">Rename</button>
                                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxVersion">Version History</button>
                                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxDetails">Details</button>
                                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxDelete">Delete</button>
                                                <button style="padding:8px 24px;border-radius:18px;background:none;border:1px solid #590691;color:#590691;font-size:15px;cursor:pointer;" id="ctxCloseBtn">Close</button>
                                            </div>
                                        </div>
                                    `;
                                    context.style.display = 'block';
                                    context.onclick = ev => ev.stopPropagation();
                                    function closeContext(ev) {
                                        if (!context.contains(ev.target)) {
                                            context.style.display = 'none';
                                            document.removeEventListener('mousedown', closeContext);
                                        }
                                    }
                                    document.addEventListener('mousedown', closeContext);
                                    document.getElementById('ctxCloseBtn').onclick = function() {
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    };
                                    // Make a Copy
                                    document.getElementById('ctxMakeCopy').onclick = function() {
                                        openDB().then(db => {
                                            const tx = db.transaction(STORE_NAME, 'readwrite');
                                            const store = tx.objectStore(STORE_NAME);
                                            store.get(sheetId).onsuccess = function(ev) {
                                                const item = ev.target.result;
                                                let copy = Object.assign({}, item);
                                                delete copy.id;
                                                copy.name = encrypt(decrypt(item.name) + ' (Copy)');
                                                copy.created = encrypt(new Date().toISOString());
                                                store.add(copy).onsuccess = function() {
                                                    showToast('Spreadsheet copied!', 'success');
                                                    renderProjects();
                                                };
                                            };
                                        });
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    };
                                    // Share
                                    document.getElementById('ctxShare').onclick = function() {
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                        const shareUrl = location.origin + location.pathname + '#/editor/' + sheetId;
                                        const shareTitle = item.name ? decrypt(item.name) : 'Spreadsheet';
                                        if (navigator.share) {
                                            navigator.share({
                                                title: shareTitle,
                                                text: 'Munetios Docs Suite Spreadsheet',
                                                url: shareUrl
                                            }).then(() => {
                                                showToast('Shared!', 'success');
                                            }).catch(() => {
                                                showToast('Share canceled', 'info');
                                            });
                                        } else {
                                            modal.innerHTML = `
                                                <div class="modal-content">
                                                    <h3>Share Spreadsheet</h3>
                                                    <div style="margin-bottom:12px;">Share this spreadsheet with others by sending this link:</div>
                                                    <input type="text" value="${shareUrl}" readonly style="width:100%;padding:12px;border-radius:12px;margin-bottom:12px;">
                                                    <button class="btn" id="copyShareLink">Copy Link</button>
                                                </div>
                                            `;
                                            modal.classList.add('active');
                                            document.getElementById('copyShareLink').onclick = function() {
                                                navigator.clipboard.writeText(shareUrl);
                                                showToast('Link copied!', 'success');
                                            };
                                        }
                                    };
                                    // Download (.xlsx)
                                    document.getElementById('ctxDownload').onclick = function() {
                                        let csv = spreadsheetData.map(row => row ? row.map(cell => cell && cell.value ? `"${cell.value.replace(/"/g, '""')}"` : '').join(',') : '').join('\n');
                                        let blob = new Blob([csv], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                                        let a = document.createElement('a');
                                        a.href = URL.createObjectURL(blob);
                                        a.download = (item.name ? decrypt(item.name) : 'Spreadsheet') + '.xlsx';
                                        document.body.appendChild(a);
                                        a.click();
                                        a.remove();
                                        showToast('Downloaded as .xlsx', 'success');
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    };
                                    // Download as CSV
                                    document.getElementById('ctxDownloadCsv').onclick = function() {
                                        let csv = spreadsheetData.map(row => row ? row.map(cell => cell && cell.value ? `"${cell.value.replace(/"/g, '""')}"` : '').join(',') : '').join('\n');
                                        let blob = new Blob([csv], { type: 'text/csv' });
                                        let a = document.createElement('a');
                                        a.href = URL.createObjectURL(blob);
                                        a.download = (item.name ? decrypt(item.name) : 'Spreadsheet') + '.csv';
                                        document.body.appendChild(a);
                                        a.click();
                                        a.remove();
                                        showToast('Downloaded as CSV', 'success');
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    };
                                    // Print
                                    document.getElementById('ctxPrint').onclick = function() {
                                        let printWindow = window.open('', '', 'width=900,height=1200');
                                        let html = '<table border="1" style="border-collapse:collapse;width:100%;">' +
                                            spreadsheetData.map(row => '<tr>' + (row ? row.map(cell => `<td>${cell && cell.value ? cell.value : ''}</td>`).join('') : '') + '</tr>').join('') +
                                            '</table>';
                                        printWindow.document.write(`
                                            <html><head><title>Print Spreadsheet</title></head>
                                            <body>${html}</body></html>
                                        `);
                                        printWindow.document.close();
                                        printWindow.focus();
                                        setTimeout(() => printWindow.print(), 400);
                                        showToast('Print dialog opened', 'info');
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    };
                                    // Rename
                                    document.getElementById('ctxRename').onclick = function() {
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                        modal.innerHTML = `
                                            <div class="modal-content">
                                                <h3>Rename Spreadsheet</h3>
                                                <input type="text" id="renameInput" value="${item.name ? decrypt(item.name) : ''}" style="width:100%;padding:12px;border-radius:12px;margin-bottom:12px;">
                                                <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                                                    <button class="btn" id="cancelRename">Cancel</button>
                                                    <button class="btn" id="applyRename">Rename</button>
                                                </div>
                                            </div>
                                        `;
                                        modal.classList.add('active');
                                        document.getElementById('cancelRename').onclick = () => modal.classList.remove('active');
                                        document.getElementById('applyRename').onclick = function() {
                                            let newName = document.getElementById('renameInput').value.trim();
                                            if (newName) {
                                                openDB().then(db => {
                                                    const tx = db.transaction(STORE_NAME, 'readwrite');
                                                    const store = tx.objectStore(STORE_NAME);
                                                    store.get(sheetId).onsuccess = function(ev) {
                                                        const sheetItem = ev.target.result;
                                                        sheetItem.name = encrypt(newName);
                                                        store.put(sheetItem).onsuccess = function() {
                                                            showToast('Renamed!', 'success');
                                                            modal.classList.remove('active');
                                                            renderProjects();
                                                        };
                                                    };
                                                });
                                            }
                                        };
                                    };
                                    // Version History
                                    document.getElementById('ctxVersion').onclick = function() {
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                        openDB().then(db => {
                                            const tx = db.transaction(STORE_NAME, 'readonly');
                                            const store = tx.objectStore(STORE_NAME);
                                            store.get(sheetId).onsuccess = function(ev) {
                                                const sheetItem = ev.target.result;
                                                let history = [];
                                                try {
                                                    history = sheetItem.history ? JSON.parse(decrypt(sheetItem.history)) : [];
                                                } catch { history = []; }
                                                modal.innerHTML = `
                                                    <div class="modal-content" style="max-width:900px;">
                                                        <h3>Version History</h3>
                                                        <div style="max-height:480px;overflow:auto;">
                                                            ${history.length ? history.map((h, i) => `
                                                                <div style="padding:12px;border-bottom:1px solid #eee;">
                                                                    <div><strong>${new Date(h.time).toLocaleString()}</strong></div>
                                                                    <button class="btn" style="margin-top:8px;" data-preview="${i}">Preview</button>
                                                                    <div class="version-preview" id="versionPreview${i}" style="display:none;background:#fff;padding:24px;border-radius:12px;max-height:320px;overflow:auto;">
                                                                        <table border="1" style="border-collapse:collapse;width:100%;">
                                                                            ${h.data.map(row => `<tr>${row ? row.map(cell => `<td>${cell && cell.value ? cell.value : ''}</td>`).join('') : ''}</tr>`).join('')}
                                                                        </table>
                                                                    </div>
                                                                    <button class="btn" style="margin-top:12px;" data-restore="${i}">Restore</button>
                                                                </div>
                                                            `).join('') : '<div>No history yet.</div>'}
                                                        </div>
                                                        <button class="btn" style="margin-top:18px;" id="closeHistory">Close</button>
                                                    </div>
                                                `;
                                                modal.classList.add('active');
                                                document.getElementById('closeHistory').onclick = () => modal.classList.remove('active');
                                                Array.from(modal.querySelectorAll('[data-restore]')).forEach(btn => {
                                                    btn.onclick = function() {
                                                        let idx = btn.getAttribute('data-restore');
                                                        let h = history[idx];
                                                        spreadsheetData = h.data;
                                                        renderSheet();
                                                        saveSheet(true);
                                                        showToast('Version restored!', 'success');
                                                        modal.classList.remove('active');
                                                    };
                                                });
                                                Array.from(modal.querySelectorAll('[data-preview]')).forEach(btn => {
                                                    btn.onclick = function() {
                                                        let idx = btn.getAttribute('data-preview');
                                                        let previewDiv = document.getElementById('versionPreview' + idx);
                                                        if (previewDiv.style.display === 'none') {
                                                            previewDiv.style.display = 'block';
                                                            btn.textContent = 'Hide Preview';
                                                        } else {
                                                            previewDiv.style.display = 'none';
                                                            btn.textContent = 'Preview';
                                                        }
                                                    };
                                                });
                                            };
                                        });
                                    };
                                    // Details
                                    document.getElementById('ctxDetails').onclick = function() {
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                        openDB().then(db => {
                                            const tx = db.transaction(STORE_NAME, 'readonly');
                                            const store = tx.objectStore(STORE_NAME);
                                            store.get(sheetId).onsuccess = function(ev) {
                                                const sheetItem = ev.target.result;
                                                let cells = 0;
                                                spreadsheetData.forEach(row => {
                                                    if (row) row.forEach(cell => {
                                                        if (cell && cell.value && cell.value.trim()) cells++;
                                                    });
                                                });
                                                let size = new Blob([JSON.stringify(spreadsheetData)]).size;
                                                modal.innerHTML = `
                                                    <div class="modal-content">
                                                        <h3>Spreadsheet Details</h3>
                                                        <div><strong>Name:</strong> ${sheetItem.name ? decrypt(sheetItem.name) : ''}</div>
                                                        <div><strong>Type:</strong> ${sheetItem.type ? decrypt(sheetItem.type) : ''}</div>
                                                        <div><strong>Created:</strong> ${sheetItem.created ? new Date(decrypt(sheetItem.created)).toLocaleString() : ''}</div>
                                                        <div><strong>Last Modified:</strong> ${new Date().toLocaleString()}</div>
                                                        <div><strong>Size:</strong> ${size} bytes</div>
                                                        <div><strong>Non-empty cells:</strong> ${cells}</div>
                                                        <button class="btn" style="margin-top:18px;" id="closeDetails">Close</button>
                                                    </div>
                                                `;
                                                modal.classList.add('active');
                                                document.getElementById('closeDetails').onclick = () => modal.classList.remove('active');
                                            };
                                        });
                                    };
                                    // Toast notification function (add this before any calls to showToast)
                                    function showToast(message, type = 'info') {
                                        let toast = document.createElement('div');
                                        toast.className = 'toast ' + type;
                                        toast.textContent = message;
                                        toast.style.position = 'fixed';
                                        toast.style.bottom = '32px';
                                        toast.style.left = '50%';
                                        toast.style.transform = 'translateX(-50%)';
                                        toast.style.background = type === 'success' ? '#b6f7c1' : (type === 'error' ? '#f7b6b6' : '#e0e0e0');
                                        toast.style.color = '#222';
                                        toast.style.padding = '12px 32px';
                                        toast.style.borderRadius = '18px';
                                        toast.style.boxShadow = '0 4px 16px rgba(0,0,0,0.12)';
                                        toast.style.zIndex = '9999';
                                        document.body.appendChild(toast);
                                        setTimeout(() => {
                                            toast.style.opacity = '0';
                                            setTimeout(() => toast.remove(), 400);
                                        }, 1800);
                                    }

                                    // Delete
                                    document.getElementById('ctxDelete').onclick = function() {
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                        modal.innerHTML = `
                                            <div class="modal-content">
                                                <h3>Delete Spreadsheet</h3>
                                                <div>Are you sure you want to delete this spreadsheet?</div>
                                                <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                                                    <button class="btn" id="cancelDelete">Cancel</button>
                                                    <button class="btn" id="confirmDelete">Delete</button>
                                                </div>
                                            </div>
                                        `;
                                        modal.classList.add('active');
                                        document.getElementById('cancelDelete').onclick = () => modal.classList.remove('active');
                                        document.getElementById('confirmDelete').onclick = function() {
                                            modal.innerHTML = `
                                                <div class="modal-content">
                                                    <h3>Confirm Permanent Delete</h3>
                                                    <div>This action cannot be undone. Delete permanently?</div>
                                                    <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                                                        <button class="btn" id="cancelPermDelete">Cancel</button>
                                                        <button class="btn" id="confirmPermDelete">Delete Permanently</button>
                                                    </div>
                                                </div>
                                            `;
                                            document.getElementById('cancelPermDelete').onclick = () => modal.classList.remove('active');
                                            document.getElementById('confirmPermDelete').onclick = function() {
                                                openDB().then(db => {
                                                    const tx = db.transaction(STORE_NAME, 'readwrite');
                                                    const store = tx.objectStore(STORE_NAME);
                                                    store.delete(sheetId).onsuccess = function() {
                                                        showToast('Deleted!', 'success');
                                                        modal.classList.remove('active');
                                                        location.hash = '';
                                                        renderProjects();
                                                    };
                                                });
                                            };
                                        };
                                    };
                                };

                                document.getElementById('editorEdit').onclick = function(e) {
                                    e.stopPropagation();
                                    const context = document.getElementById('contextwrapperRender');
                                    context.innerHTML = `
                                        <div style="position:absolute;top:${e.target.getBoundingClientRect().bottom+8}px;left:${e.target.getBoundingClientRect().left}px;z-index:4000;min-width:220px;">
                                            <div style="padding:8px 0;">
                                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxCut">Cut</button>
                                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxCopy">Copy</button>
                                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxPaste">Paste</button>
                                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxPastePlain">Paste without Formatting</button>
                                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxSelectAll">Select All</button>
                                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxDelete">Delete</button>
                                                <button style="padding:8px 24px;border-radius:18px;background:none;border:1px solid #590691;color:#590691;font-size:15px;cursor:pointer;" id="ctxCloseEdit">Close</button>
                                            </div>
                                        </div>
                                    `;
                                    context.style.display = 'block';
                                    context.onclick = ev => ev.stopPropagation();
                                    function closeContext(ev) {
                                        if (!context.contains(ev.target)) {
                                            context.style.display = 'none';
                                            document.removeEventListener('mousedown', closeContext);
                                        }
                                    }
                                    document.addEventListener('mousedown', closeContext);
                                    document.getElementById('ctxCloseEdit').onclick = function() {
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    };
                                    document.getElementById('ctxCut').onclick = function() {
                                        document.execCommand('cut');
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    };
                                    document.getElementById('ctxCopy').onclick = function() {
                                        document.execCommand('copy');
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    };
                                    document.getElementById('ctxPaste').onclick = function() {
                                        document.execCommand('paste');
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    };
                                    document.getElementById('ctxPastePlain').onclick = function() {
                                        navigator.clipboard.readText().then(text => {
                                            document.execCommand('insertText', false, text);
                                        });
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    };
                                    document.getElementById('ctxSelectAll').onclick = function() {
                                        document.execCommand('selectAll');
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    };
                                    document.getElementById('ctxDelete').onclick = function() {
                                        document.execCommand('delete');
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    };
                                };

                                document.getElementById('editorView').onclick = function(e) {
                                    e.stopPropagation();
                                    const context = document.getElementById('contextwrapperRender');
                                    context.innerHTML = `
                                        <div style="position:absolute;top:${e.target.getBoundingClientRect().bottom+8}px;left:${e.target.getBoundingClientRect().left}px;z-index:4000;min-width:220px;">
                                            <div style="padding:8px 0;">
                                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxFullscreen">Fullscreen</button>
                                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxFind">Find</button>
                                                <button style="padding:8px 24px;border-radius:18px;background:none;border:1px solid #590691;color:#590691;font-size:15px;cursor:pointer;" id="ctxCloseView">Close</button>
                                            </div>
                                        </div>
                                    `;
                                    context.style.display = 'block';
                                    context.onclick = ev => ev.stopPropagation();
                                    function closeContext(ev) {
                                        if (!context.contains(ev.target)) {
                                            context.style.display = 'none';
                                            document.removeEventListener('mousedown', closeContext);
                                        }
                                    }
                                    document.addEventListener('mousedown', closeContext);
                                    document.getElementById('ctxCloseView').onclick = function() {
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    };
                                    document.getElementById('ctxFullscreen').onclick = function() {
                                        let wrapper = document.getElementById('spreadsheetSheetWrapper');
                                        if (wrapper && wrapper.requestFullscreen) {
                                            wrapper.requestFullscreen();
                                        } else if (wrapper && wrapper.webkitRequestFullscreen) {
                                            wrapper.webkitRequestFullscreen();
                                        }
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    };
                                    document.getElementById('ctxFind').onclick = function() {
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                        let existingBar = document.getElementById('floatingSheetSearchBar');
                                        if (existingBar) {
                                            existingBar.style.display = 'block';
                                            document.getElementById('sheetSearchInput').focus();
                                            return;
                                        }
                                        let searchBar = document.createElement('div');
                                        searchBar.id = 'floatingSheetSearchBar';
                                        searchBar.style.position = 'fixed';
                                        searchBar.style.top = '100px';
                                        searchBar.style.left = '50%';
                                        searchBar.style.transform = 'translateX(-50%)';
                                        searchBar.style.zIndex = '5000';
                                        searchBar.style.background = 'rgba(255,255,255,0.95)';
                                        searchBar.style.boxShadow = '0 8px 32px 0 rgba(31,38,135,0.18)';
                                        searchBar.style.borderRadius = '24px';
                                        searchBar.style.padding = '24px 24px 18px 24px';
                                        searchBar.style.maxWidth = '400px';
                                        searchBar.style.width = '100%';
                                        searchBar.innerHTML = `
                                            <div style="display:flex;align-items:center;justify-content:space-between;">
                                                <h3 style="margin:0;">Search Spreadsheet</h3>
                                                <button class="btn" id="closeSheetSearchBar" style="padding:4px 12px;font-size:18px;">&#10005;</button>
                                            </div>
                                            <input type="text" id="sheetSearchInput" placeholder="Find text..." style="width:100%;padding:12px;border-radius:12px;margin:18px 0 0 0;">
                                            <div id="sheetSearchResult" style="margin-top:12px;color:#590691;"></div>
                                        `;
                                        document.body.appendChild(searchBar);
                                        document.getElementById('sheetSearchInput').focus();
                                        document.getElementById('closeSheetSearchBar').onclick = function () {
                                            searchBar.style.display = 'none';
                                        };
                                        document.getElementById('sheetSearchInput').oninput = function () {
                                            const val = this.value;
                                            let found = false;
                                            let result = '';
                                            if (!val) {
                                                document.getElementById('sheetSearchResult').textContent = '';
                                                return;
                                            }
                                            spreadsheetData.forEach((row, r) => {
                                                if (row) row.forEach((cell, c) => {
                                                    if (cell && cell.value && cell.value.includes(val)) {
                                                        found = true;
                                                        result += `Found in row ${r + 1}, col ${String.fromCharCode(65 + c)}. `;
                                                    }
                                                });
                                            });
                                            document.getElementById('sheetSearchResult').textContent = found ? result : 'Not found';
                                        };
                                    };
                                };

                                document.getElementById('editorInsert').onclick = function(e) {
                                    e.stopPropagation();
                                    const context = document.getElementById('contextwrapperRender');
                                    context.innerHTML = `
                                        <div style="position:absolute;top:${e.target.getBoundingClientRect().bottom+8}px;left:${e.target.getBoundingClientRect().left}px;z-index:4000;min-width:220px;">
                                            <div style="padding:8px 0;">
                                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxInsertTable">Insert Table</button>
                                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxInsertChart">Insert Chart</button>
                                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxInsertDropdown">Insert Dropdown</button>
                                                <button style="padding:8px 24px;border-radius:18px;background:none;border:1px solid #590691;color:#590691;font-size:15px;cursor:pointer;" id="ctxCloseInsert">Close</button>
                                            </div>
                                        </div>
                                    `;
                                    context.style.display = 'block';
                                    context.onclick = ev => ev.stopPropagation();
                                    function closeContext(ev) {
                                        if (!context.contains(ev.target)) {
                                            context.style.display = 'none';
                                            document.removeEventListener('mousedown', closeContext);
                                        }
                                    }
                                    document.addEventListener('mousedown', closeContext);
                                    document.getElementById('ctxCloseInsert').onclick = function() {
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    };
                                    document.getElementById('ctxInsertTable').onclick = function() {
                                        document.getElementById('spreadsheetInsertTableBtn').click();
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    };
                                    document.getElementById('ctxInsertChart').onclick = function() {
                                        document.getElementById('spreadsheetInsertChartBtn').click();
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    };
                                    document.getElementById('ctxInsertDropdown').onclick = function() {
                                        document.getElementById('spreadsheetInsertDropdownBtn').click();
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    };
                                };
                                if (decrypt(item.type) === 'Spreadsheet') {
                                    document.getElementById('editorTools').style.display = 'none';
                                } else {
                                    document.getElementById('editorTools').style.display = '';
                                }

                                document.getElementById('editorHelp').onclick = function(e) {
                                    e.stopPropagation();
                                    const context = document.getElementById('contextwrapperRender');
                                    context.innerHTML = `
                                        <div style="position:absolute;top:${e.target.getBoundingClientRect().bottom+8}px;left:${e.target.getBoundingClientRect().left}px;z-index:4000;min-width:260px;">
                                            <div style="padding:8px 0;">
                                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxContact">Contact</button>
                                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxShortcuts">Keyboard Shortcuts</button>
                                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxFeature">Request a Feature</button>
                                                <button style="width:100%;text-align:left;padding:10px 24px;" id="ctxBug">Report a Bug</button>
                                                <button style="padding:8px 24px;border-radius:18px;background:none;border:1px solid #590691;color:#590691;font-size:15px;cursor:pointer;" id="ctxCloseHelp">Close</button>
                                            </div>
                                        </div>
                                    `;
                                    context.style.display = 'block';
                                    context.onclick = ev => ev.stopPropagation();
                                    function closeContext(ev) {
                                        if (!context.contains(ev.target)) {
                                            context.style.display = 'none';
                                            document.removeEventListener('mousedown', closeContext);
                                        }
                                    }
                                    document.addEventListener('mousedown', closeContext);
                                    document.getElementById('ctxCloseHelp').onclick = function() {
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    };
                                    function openGmail(subject) {
                                        window.open(`https://mail.google.com/mail/?view=cm&fs=1&to=minecraftgamer97529@gmail.com&su=${encodeURIComponent(subject)}`, '_blank');
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                    }
                                    document.getElementById('ctxContact').onclick = function() {
                                        openGmail('Contact Munetios Docs Suite');
                                    };
                                    document.getElementById('ctxFeature').onclick = function() {
                                        openGmail('Request a Feature - Munetios Docs Suite');
                                    };
                                    document.getElementById('ctxBug').onclick = function() {
                                        openGmail('Report a Bug - Munetios Docs Suite');
                                    };
                                    document.getElementById('ctxShortcuts').onclick = function() {
                                        context.style.display = 'none';
                                        document.removeEventListener('mousedown', closeContext);
                                        modal.innerHTML = `
                                            <div class="modal-content" style="max-width:600px;">
                                                <h3>Keyboard Shortcuts</h3>
                                                <div style="max-height:400px;overflow:auto;">
                                                    <table style="width:100%;border-collapse:collapse;">
                                                        <thead>
                                                            <tr>
                                                                <th style="text-align:left;padding:8px;">Shortcut</th>
                                                                <th style="text-align:left;padding:8px;">Action</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            ${[
                                                                ['Ctrl + S', 'Save spreadsheet'],
                                                                ['Ctrl + Z', 'Undo'],
                                                                ['Ctrl + Y', 'Redo'],
                                                                ['Ctrl + B', 'Bold'],
                                                                ['Ctrl + I', 'Italic'],
                                                                ['Ctrl + U', 'Underline'],
                                                                ['Ctrl + Shift + S', 'Strikethrough'],
                                                                ['Ctrl + Shift + C', 'Copy'],
                                                                ['Ctrl + Shift + V', 'Paste'],
                                                                ['Ctrl + Shift + X', 'Cut'],
                                                                ['Ctrl + Shift + F', 'Find'],
                                                                ['Ctrl + Shift + T', 'Insert Table'],
                                                                ['Ctrl + Shift + D', 'Insert Dropdown'],
                                                                ['Ctrl + Shift + M', 'Insert Chart'],
                                                                ['Ctrl + Shift + A', 'Select All'],
                                                                ['Ctrl + Shift + K', 'Keyboard Shortcuts'],
                                                                ['Ctrl + Shift + C', 'Contact'],
                                                                ['Ctrl + Shift + B', 'Report Bug'],
                                                                ['Ctrl + Shift + F', 'Request Feature'],
                                                                ['Ctrl + Shift + H', 'Help'],
                                                                ['Ctrl + Shift + D', 'Spreadsheet Details'],
                                                                ['Ctrl + Shift + R', 'Rename Spreadsheet'],
                                                                ['Ctrl + Shift + Del', 'Delete Spreadsheet'],
                                                            ].map(([k, v]) => `<tr><td style="padding:6px 8px;">${k}</td><td style="padding:6px 8px;">${v}</td></tr>`).join('')}
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <button class="btn" style="margin-top:18px;" id="closeShortcuts">Close</button>
                                            </div>
                                        `;
                                        modal.classList.add('active');
                                        document.getElementById('closeShortcuts').onclick = () => modal.classList.remove('active');
                                    };
                                };
                            // Render sheet rows
                            function renderSheet() {
                                const tbody = document.getElementById('spreadsheetTableBody');
                                tbody.innerHTML = '';
                                for (let r = 0; r < Math.min(spreadsheetData.length || sheetRows, maxRows); r++) {
                                    const row = document.createElement('tr');
                                    // Row header (black)
                                    row.innerHTML = `<th style="background:#111;color:#fff;position:sticky;left:0;z-index:1;">${r+1}</th>`;
                                    for (let c = 0; c < sheetCols; c++) {
                                        let cellData = (spreadsheetData[r] && spreadsheetData[r][c]) || { value: '', style: {} };
                                        let td = document.createElement('td');
                                        td.contentEditable = true;
                                        td.spellcheck = false;
                                        td.style.minWidth = '120px';
                                        td.style.maxWidth = '220px';
                                        td.style.height = '32px';
                                        td.style.border = '1px solid #590691';
                                        td.style.padding = '4px 8px';
                                        td.style.overflow = cellData.style.overflow || 'hidden';
                                        td.style.whiteSpace = cellData.style.wrap || 'nowrap';
                                        td.style.fontFamily = cellData.style.fontFamily || 'Lexend,sans-serif';
                                        td.style.fontSize = cellData.style.fontSize || '16px';
                                        td.style.fontWeight = cellData.style.bold ? 'bold' : '';
                                        td.style.fontStyle = cellData.style.italic ? 'italic' : '';
                                        td.style.textDecoration = [
                                            cellData.style.underline ? 'underline' : '',
                                            cellData.style.strike ? 'line-through' : ''
                                        ].filter(Boolean).join(' ');
                                        td.style.textAlign = cellData.style.align || 'left';
                                        td.style.verticalAlign = cellData.style.valign || 'middle';
                                        td.setAttribute('data-row', r);
                                        td.setAttribute('data-col', c);
                                        td.innerText = cellData.value;
                                        td.oninput = function() {
                                            if (!spreadsheetData[r]) spreadsheetData[r] = [];
                                            spreadsheetData[r][c] = spreadsheetData[r][c] || { value: '', style: {} };
                                            spreadsheetData[r][c].value = td.innerText;
                                            saveSheet(true);
                                        };
                                        td.onclick = function() {
                                            selectedCell = td;
                                        };
                                        row.appendChild(td);
                                    }
                                    tbody.appendChild(row);
                                }
                                // Add more rows if needed
                                if ((spreadsheetData.length || sheetRows) < sheetRows) {
                                    for (let r = spreadsheetData.length || 0; r < sheetRows; r++) {
                                        const row = document.createElement('tr');
                                        row.innerHTML = `<th style="background:#111;color:#fff;position:sticky;left:0;z-index:1;">${r+1}</th>`;
                                        for (let c = 0; c < sheetCols; c++) {
                                            let td = document.createElement('td');
                                            td.contentEditable = true;
                                            td.spellcheck = false;
                                            td.style.minWidth = '120px';
                                            td.style.maxWidth = '220px';
                                            td.style.height = '32px';
                                            td.style.border = '1px solid #590691';
                                            td.style.padding = '4px 8px';
                                            td.setAttribute('data-row', r);
                                            td.setAttribute('data-col', c);
                                            td.innerText = '';
                                            td.oninput = function() {
                                                if (!spreadsheetData[r]) spreadsheetData[r] = [];
                                                spreadsheetData[r][c] = spreadsheetData[r][c] || { value: '', style: {} };
                                                spreadsheetData[r][c].value = td.innerText;
                                                saveSheet(true);
                                            };
                                            td.onclick = function() {
                                                selectedCell = td;
                                            };
                                            row.appendChild(td);
                                        }
                                        tbody.appendChild(row);
                                    }
                                }
                            }

                            // Save function
                            function saveSheet(auto = false) {
                                openDB().then(db => {
                                    const tx = db.transaction(STORE_NAME, 'readwrite');
                                    const store = tx.objectStore(STORE_NAME);
                                    store.get(sheetId).onsuccess = function(ev) {
                                        const sheetItem = ev.target.result;
                                        sheetItem.content = encrypt(JSON.stringify(spreadsheetData));
                                        // Update history
                                        let history = [];
                                        try {
                                            history = sheetItem.history ? JSON.parse(decrypt(sheetItem.history)) : [];
                                        } catch { history = []; }
                                        history.push({
                                            time: new Date().toISOString(),
                                            data: JSON.parse(JSON.stringify(spreadsheetData))
                                        });
                                        sheetItem.history = encrypt(JSON.stringify(history));
                                        store.put(sheetItem);
                                    };
                                });
                                if (!auto) {
                                    document.getElementById('spreadsheetSaveBtn').style.background = '#b6f7c1';
                                    setTimeout(() => document.getElementById('spreadsheetSaveBtn').style.background = '', 600);
                                }
                            }

                            // Toolbar actions
                            let selectedCell = null;

                            function applyCellStyle(styleProp, value) {
                                if (selectedCell) {
                                    let r = Number(selectedCell.getAttribute('data-row'));
                                    let c = Number(selectedCell.getAttribute('data-col'));
                                    spreadsheetData[r] = spreadsheetData[r] || [];
                                    spreadsheetData[r][c] = spreadsheetData[r][c] || { value: selectedCell.innerText, style: {} };
                                    spreadsheetData[r][c].style[styleProp] = value;
                                    renderSheet();
                                    saveSheet(true);
                                }
                            }

                            document.getElementById('spreadsheetBoldBtn').onclick = () => applyCellStyle('bold', true);
                            document.getElementById('spreadsheetItalicBtn').onclick = () => applyCellStyle('italic', true);
                            document.getElementById('spreadsheetUnderlineBtn').onclick = () => applyCellStyle('underline', true);
                            document.getElementById('spreadsheetStrikeBtn').onclick = () => applyCellStyle('strike', true);

                            document.getElementById('spreadsheetAlignLeftBtn').onclick = () => applyCellStyle('align', 'left');
                            document.getElementById('spreadsheetAlignCenterBtn').onclick = () => applyCellStyle('align', 'center');
                            document.getElementById('spreadsheetAlignRightBtn').onclick = () => applyCellStyle('align', 'right');

                            document.getElementById('spreadsheetAlignTopBtn').onclick = () => applyCellStyle('valign', 'top');
                            document.getElementById('spreadsheetAlignMiddleBtn').onclick = () => applyCellStyle('valign', 'middle');
                            document.getElementById('spreadsheetAlignBottomBtn').onclick = () => applyCellStyle('valign', 'bottom');

                            document.getElementById('spreadsheetFontFamilyPicker').onchange = e => {
                                if (selectedCell) {
                                    applyCellStyle('fontFamily', e.target.value);
                                }
                            };
                            document.getElementById('spreadsheetFontSizeInput').onchange = e => {
                                if (selectedCell) {
                                    applyCellStyle('fontSize', e.target.value + 'px');
                                }
                            };

                            document.getElementById('spreadsheetWrapBtn').onclick = () => {
                                if (selectedCell) {
                                    applyCellStyle('wrap', 'normal');
                                }
                            };
                            document.getElementById('spreadsheetOverflowBtn').onclick = () => {
                                if (selectedCell) {
                                    applyCellStyle('overflow', 'visible');
                                }
                            };
                            document.getElementById('spreadsheetClipBtn').onclick = () => {
                                if (selectedCell) {
                                    applyCellStyle('overflow', 'hidden');
                                }
                            };

                            document.getElementById('formatCurrencyBtn').onclick = () => {
                                if (selectedCell) {
                                    let r = Number(selectedCell.getAttribute('data-row'));
                                    let c = Number(selectedCell.getAttribute('data-col'));
                                    let val = selectedCell.innerText.replace(/[^\d.-]/g, '');
                                    if (!isNaN(val) && val !== '') {
                                        let formatted = '$' + Number(val).toLocaleString(undefined, {minimumFractionDigits:2});
                                        selectedCell.innerText = formatted;
                                        spreadsheetData[r] = spreadsheetData[r] || [];
                                        spreadsheetData[r][c] = spreadsheetData[r][c] || { value: '', style: {} };
                                        spreadsheetData[r][c].value = formatted;
                                        spreadsheetData[r][c].style.format = 'currency';
                                        renderSheet();
                                        saveSheet(true);
                                    }
                                }
                            };
                            document.getElementById('formatPercentBtn').onclick = () => {
                                if (selectedCell) {
                                    let r = Number(selectedCell.getAttribute('data-row'));
                                    let c = Number(selectedCell.getAttribute('data-col'));
                                    let val = selectedCell.innerText.replace(/[^\d.-]/g, '');
                                    if (!isNaN(val) && val !== '') {
                                        let formatted = (Number(val) * 100).toFixed(2) + '%';
                                        selectedCell.innerText = formatted;
                                        spreadsheetData[r] = spreadsheetData[r] || [];
                                        spreadsheetData[r][c] = spreadsheetData[r][c] || { value: '', style: {} };
                                        spreadsheetData[r][c].value = formatted;
                                        spreadsheetData[r][c].style.format = 'percent';
                                        renderSheet();
                                        saveSheet(true);
                                    }
                                }
                            };

                            // Insert Table (adds a table inside selected cell)
                            document.getElementById('spreadsheetInsertTableBtn').onclick = () => {
                                if (selectedCell) {
                                    let table = `<table style="width:100%;border-collapse:collapse;"><tr><td>Cell 1</td><td>Cell 2</td></tr><tr><td>Cell 3</td><td>Cell 4</td></tr></table>`;
                                    selectedCell.innerHTML = table;
                                    applyCellStyle('format', 'table');
                                    saveSheet(true);
                                }
                            };

                            // Insert Chart (opens modal to insert chart)
                            document.getElementById('spreadsheetInsertChartBtn').onclick = () => {
                                modal.innerHTML = `
                                    <div class="modal-content">
                                        <h3>Insert Chart</h3>
                                        <label>Type: <select id="chartType"><option value="bar">Bar</option><option value="line">Line</option><option value="pie">Pie</option></select></label>
                                        <label>Data (comma separated): <input type="text" id="chartData" style="width:100%;padding:8px;border-radius:8px;"></label>
                                        <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                                            <button class="btn" id="cancelChart">Cancel</button>
                                            <button class="btn" id="applyChart">Insert</button>
                                        </div>
                                    </div>
                                `;
                                modal.classList.add('active');
                                document.getElementById('cancelChart').onclick = () => modal.classList.remove('active');
                                document.getElementById('applyChart').onclick = () => {
                                    let type = document.getElementById('chartType').value;
                                    let data = document.getElementById('chartData').value.split(',').map(Number);
                                    if (selectedCell && data.length) {
                                        let canvasId = 'chartCanvas' + Date.now();
                                        selectedCell.innerHTML = `<canvas id="${canvasId}" width="220" height="120"></canvas>`;
                                        setTimeout(() => {
                                            let ctx = document.getElementById(canvasId).getContext('2d');
                                            new Chart(ctx, {
                                                type: type,
                                                data: {
                                                    labels: data.map((_,i)=>'Item '+(i+1)),
                                                    datasets: [{
                                                        label: 'Data',
                                                        data: data,
                                                        backgroundColor: '#590691'
                                                    }]
                                                }
                                            });
                                        }, 100);
                                        modal.classList.remove('active');
                                        saveSheet(true);
                                    }
                                };
                            };

                            // Insert Dropdown (adds a select dropdown in cell)
                            document.getElementById('spreadsheetInsertDropdownBtn').onclick = () => {
                                modal.innerHTML = `
                                    <div class="modal-content">
                                        <h3>Insert Dropdown</h3>
                                        <input type="text" id="dropdownOptions" placeholder="Comma separated options" style="width:100%;padding:12px;border-radius:12px;margin-bottom:12px;">
                                        <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                                            <button class="btn" id="cancelDropdown">Cancel</button>
                                            <button class="btn" id="applyDropdown">Insert</button>
                                        </div>
                                    </div>
                                `;
                                modal.classList.add('active');
                                document.getElementById('cancelDropdown').onclick = () => modal.classList.remove('active');
                                document.getElementById('applyDropdown').onclick = () => {
                                    let options = document.getElementById('dropdownOptions').value.split(',').map(o => o.trim()).filter(o => o);
                                    if (selectedCell && options.length) {
                                        let select = document.createElement('select');
                                        select.style.padding = '8px 16px';
                                        select.style.borderRadius = '8px';
                                        select.style.border = '1px solid #590691';
                                        options.forEach(opt => {
                                            let option = document.createElement('option');
                                            option.value = opt;
                                            option.textContent = opt;
                                            select.appendChild(option);
                                        });
                                        selectedCell.innerHTML = '';
                                        selectedCell.appendChild(select);
                                        modal.classList.remove('active');
                                        saveSheet(true);
                                    }
                                };
                            };

                            document.getElementById('spreadsheetSaveBtn').onclick = () => saveSheet();

                            // Auto save every 5 seconds
                            setInterval(() => saveSheet(true), 5000);

                            // Allow scrolling to add more rows
                            document.getElementById('spreadsheetSheetWrapper').onscroll = function(e) {
                                let tbody = document.getElementById('spreadsheetTableBody');
                                if (tbody && tbody.children.length < maxRows && this.scrollTop + this.clientHeight >= this.scrollHeight - 10) {
                                    let currentRows = tbody.children.length;
                                    for (let r = currentRows; r < Math.min(currentRows+50, maxRows); r++) {
                                        const row = document.createElement('tr');
                                        row.innerHTML = `<th style="background:#111;color:#fff;position:sticky;left:0;z-index:1;">${r+1}</th>`;
                                        for (let c = 0; c < sheetCols; c++) {
                                            let td = document.createElement('td');
                                            td.contentEditable = true;
                                            td.spellcheck = false;
                                            td.style.minWidth = '120px';
                                            td.style.maxWidth = '220px';
                                            td.style.height = '32px';
                                            td.style.border = '1px solid #590691';
                                            td.style.padding = '4px 8px';
                                            td.setAttribute('data-row', r);
                                            td.setAttribute('data-col', c);
                                            td.innerText = '';
                                            td.oninput = function() {
                                                if (!spreadsheetData[r]) spreadsheetData[r] = [];
                                                spreadsheetData[r][c] = spreadsheetData[r][c] || { value: '', style: {} };
                                                spreadsheetData[r][c].value = td.innerText;
                                                saveSheet(true);
                                            };
                                            td.onclick = function() {
                                                selectedCell = td;
                                            };
                                            row.appendChild(td);
                                        }
                                        tbody.appendChild(row);
                                    }
                                }
                            };
                        } else {
                            document.querySelector('.editor-content').innerHTML = `<div style="padding:48px;">Editor for ${item ? decrypt(item.type) : 'Unknown'} coming soon.</div>`;
                        }
                    };
                });
            }
            const modal = document.getElementById('modalUIRender');
            const addBtn = document.getElementById('addBtn');
            const filesList = document.getElementById('filesList');
            const editorContent = document.querySelector('.editor-content');
            const editorScreen = document.querySelector('.editor-screen');

            const DB_NAME = 'munetios_docs_suite';
            const STORE_NAME = 'projects';
            const DB_VERSION = 1;
            const ENCRYPTION_KEY = 'munetios_secret_key_2025';

            function encrypt(text) {
                return btoa(unescape(encodeURIComponent(text + ENCRYPTION_KEY)));
            }
            function decrypt(text) {
                try {
                    let dec = decodeURIComponent(escape(atob(text)));
                    return dec.replace(ENCRYPTION_KEY, '');
                } catch {
                    return '';
                }
            }

            let db;
            function openDB() {
                return new Promise((resolve, reject) => {
                    if (db) return resolve(db);
                    const req = indexedDB.open(DB_NAME, DB_VERSION);
                    req.onupgradeneeded = function(e) {
                        const d = e.target.result;
                        if (!d.objectStoreNames.contains(STORE_NAME)) {
                            d.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        }
                    };
                    req.onsuccess = function(e) {
                        db = e.target.result;
                        resolve(db);
                    };
                    req.onerror = function(e) {
                        reject(e);
                    };
                });
            }

            function addProject(type, name) {
                openDB().then(db => {
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    const now = new Date();
                    store.add({
                        type: encrypt(type),
                        name: encrypt(name),
                        created: encrypt(now.toISOString())
                    });
                    tx.oncomplete = renderProjects;
                });
            }

            function renderProjects() {
                openDB().then(db => {
                    const tx = db.transaction(STORE_NAME, 'readonly');
                    const store = tx.objectStore(STORE_NAME);
                    const req = store.getAll();
                    req.onsuccess = function() {
                        const items = req.result;
                        if (!items.length) {
                            filesList.innerHTML = `<p>Welcome to Munetios Docs Suite so you can manage your projects and files. to create one, click the "Create" button.</p>`;
                            return;
                        }
                        filesList.innerHTML = items.map(item => `
                            <div class="liquid-glass" style="padding:16px;margin-bottom:12px;border-radius:24px;">
                                <strong>${decrypt(item.name)}</strong>
                                <span style="margin-left:8px;">(${decrypt(item.type)})</span>
                                <span style="float:right;color:#888;font-size:12px;">${new Date(decrypt(item.created)).toLocaleString()}</span>
                            </div>
                        `).join('');
                    };
                });
            }

            function showModal() {
                modal.innerHTML = `
                    <div class="modal-content">
                        <h3>Create New</h3>
                        <div style="margin-top:18px;">
                            <input type="text" id="projectName" placeholder="Enter name" style="width:100%;padding:12px;border-radius:12px;margin-bottom:12px;" />
                            <select id="projectType" style="width:100%;padding:12px;border-radius:12px;">
                                <option value="Document">Document</option>
                                <option value="Presentation">Presentation</option>
                                <option value="Spreadsheet">Spreadsheet</option>
                                <option value="Journal">Journal</option>
                            </select>
                        </div>
                        <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                            <button class="btn" id="cancelModal">Cancel</button>
                            <button class="btn" id="createModal">Create</button>
                        </div>
                    </div>
                `;
                modal.classList.add('active');
                document.getElementById('cancelModal').onclick = () => modal.classList.remove('active');
                document.getElementById('createModal').onclick = () => {
                    const type = document.getElementById('projectType').value;
                    const nameInput = document.getElementById('projectName');
                    const name = nameInput.value.trim();
                    if (!name) {
                        nameInput.style.borderColor = 'red';
                        nameInput.focus();
                        return;
                    }
                    addProject(type, name);
                    modal.classList.remove('active');
                };
            }

            // REMOVE this duplicate goToEditor, use the one above that calls renderDocumentEditor

            function handleHashChange() {
                const hash = location.hash;
                if (hash.startsWith('#/editor/')) {
                    document.querySelector('.home-screen').style.display = 'none';
                    editorScreen.style.display = 'block';
                    editorContent.style.display = 'block';
                    // Extract id and render editor
                    const id = hash.split('/')[2];
                    if (id) {
                        goToEditor(id);
                    }
                } else {
                    document.querySelector('.home-screen').style.display = 'block';
                    editorScreen.style.display = 'none';
                    editorContent.style.display = 'none';
                }
            }
            function handleCreateHash() {
                const hash = location.hash;
                if (hash.startsWith('#/create?=')) {
                    const params = hash.replace('#/create?=', '').split(',');
                    let type = 'Document', name = '';
                    params.forEach(p => {
                        const [key, val] = p.split('=');
                        if (key === 'type') type = decodeURIComponent(val || 'Document');
                        if (key === 'name') name = decodeURIComponent(val || '');
                    });
                    modal.innerHTML = `
                        <div class="modal-content">
                            <h3>Create New</h3>
                            <div style="margin-top:18px;">
                                <input type="text" id="projectName" placeholder="Enter name" style="width:100%;padding:12px;border-radius:12px;margin-bottom:12px;" value="${name}" />
                                <select id="projectType" style="width:100%;padding:12px;border-radius:12px;">
                                    <option value="Document"${type === 'Document' ? ' selected' : ''}>Document</option>
                                    <option value="Presentation"${type === 'Presentation' ? ' selected' : ''}>Presentation</option>
                                    <option value="Spreadsheet"${type === 'Spreadsheet' ? ' selected' : ''}>Spreadsheet</option>
                                    <option value="Journal"${type === 'Journal' ? ' selected' : ''}>Journal</option>
                                </select>
                            </div>
                            <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                                <button class="btn" id="cancelModal">Cancel</button>
                                <button class="btn" id="createModal">Create</button>
                            </div>
                        </div>
                    `;
                    modal.classList.add('active');
                    document.getElementById('cancelModal').onclick = () => {
                        modal.classList.remove('active');
                        location.hash = '';
                    };
                    document.getElementById('createModal').onclick = () => {
                        const typeVal = document.getElementById('projectType').value;
                        const nameInput = document.getElementById('projectName');
                        const nameVal = nameInput.value.trim();
                        if (!nameVal) {
                            nameInput.style.borderColor = 'red';
                            nameInput.focus();
                            return;
                        }
                        addProject(typeVal, nameVal);
                        modal.classList.remove('active');
                        location.hash = '';
                    };
                }
            }
            document.getElementById('menuBtn').onclick = function () {
                modal.innerHTML = `
                    <div class="modal-content">
                        <h3>Sort by &amp; Filter</h3>
                        <div style="margin-top:18px;">
                            <label for="sortBy" style="display:block;margin-bottom:8px;">Sort by:</label>
                            <select id="sortBy" style="width:100%;padding:12px;border-radius:12px;margin-bottom:12px;">
                                <option value="created_desc">Newest First</option>
                                <option value="created_asc">Oldest First</option>
                                <option value="name_asc">Name (A-Z)</option>
                                <option value="name_desc">Name (Z-A)</option>
                                <option value="type_asc">Type (A-Z)</option>
                                <option value="type_desc">Type (Z-A)</option>
                            </select>
                            <label for="filterType" style="display:block;margin-bottom:8px;">Filter by Type:</label>
                            <select id="filterType" style="width:100%;padding:12px;border-radius:12px;">
                                <option value="">All Types</option>
                                <option value="Document">Document</option>
                                <option value="Presentation">Presentation (Coming Soon)</option>
                                <option value="Spreadsheet">Spreadsheet</option>
                                <option value="Journal">Journal</option>
                            </select>
                        </div>
                        <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end;">
                            <button class="btn" id="cancelSortFilter">Cancel</button>
                            <button class="btn" id="applySortFilter">Apply</button>
                        </div>
                    </div>
                `;
                modal.classList.add('active');
                document.getElementById('cancelSortFilter').onclick = () => modal.classList.remove('active');
                document.getElementById('applySortFilter').onclick = function () {
                    const sortBy = document.getElementById('sortBy').value;
                    const filterType = document.getElementById('filterType').value;
                    openDB().then(db => {
                        const tx = db.transaction(STORE_NAME, 'readonly');
                        const store = tx.objectStore(STORE_NAME);
                        store.getAll().onsuccess = function (ev) {
                            let items = ev.target.result || [];
                            items = items.filter(item => !filterType || decrypt(item.type) === filterType);
                            if (sortBy === 'created_desc') {
                                items.sort((a, b) => new Date(decrypt(b.created)) - new Date(decrypt(a.created)));
                            } else if (sortBy === 'created_asc') {
                                items.sort((a, b) => new Date(decrypt(a.created)) - new Date(decrypt(b.created)));
                            } else if (sortBy === 'name_asc') {
                                items.sort((a, b) => decrypt(a.name).localeCompare(decrypt(b.name)));
                            } else if (sortBy === 'name_desc') {
                                items.sort((a, b) => decrypt(b.name).localeCompare(decrypt(a.name)));
                            } else if (sortBy === 'type_asc') {
                                items.sort((a, b) => decrypt(a.type).localeCompare(decrypt(b.type)));
                            } else if (sortBy === 'type_desc') {
                                items.sort((a, b) => decrypt(b.type).localeCompare(decrypt(a.type)));
                            }
                            if (!items.length) {
                                filesList.innerHTML = `<p>No files found.</p>`;
                            } else {
                                filesList.innerHTML = items.map(item => `
                                    <div class="liquid-glass" style="padding:16px;margin-bottom:12px;border-radius:24px;">
                                        <strong>${decrypt(item.name)}</strong>
                                        <span style="margin-left:8px;">(${decrypt(item.type)})</span>
                                        <span style="float:right;color:#888;font-size:12px;">${new Date(decrypt(item.created)).toLocaleString()}</span>
                                    </div>
                                `).join('');
                            }
                            modal.classList.remove('active');
                        };
                    });
                };
            };
            document.getElementById('searchInput').addEventListener('input', function () {
                const query = this.value.trim().toLowerCase();
                openDB().then(db => {
                    const tx = db.transaction(STORE_NAME, 'readonly');
                    const store = tx.objectStore(STORE_NAME);
                    const req = store.getAll();
                    req.onsuccess = function () {
                        const items = req.result;
                        let filtered = items;
                        if (query) {
                            filtered = items.filter(item =>
                                decrypt(item.name).toLowerCase().includes(query) ||
                                decrypt(item.type).toLowerCase().includes(query)
                            );
                        }
                        if (!filtered.length) {
                            filesList.innerHTML = `<p>No files found.</p>`;
                            return;
                        }
                        filesList.innerHTML = filtered.map(item => `
                            <div class="liquid-glass" style="padding:16px;margin-bottom:12px;border-radius:24px;">
                                <strong>${decrypt(item.name)}</strong>
                                <span style="margin-left:8px;">(${decrypt(item.type)})</span>
                                <span style="float:right;color:#888;font-size:12px;">${new Date(decrypt(item.created)).toLocaleString()}</span>
                            </div>
                        `).join('');
                    };
                });
            });

            window.addEventListener('hashchange', () => {
                handleHashChange();
                handleCreateHash();
            });
            handleCreateHash();
            window.addEventListener('hashchange', handleHashChange);

            filesList.onclick = function(e) {
                const target = e.target.closest('.liquid-glass');
                if (target) {
                    // Find the project id by matching name and type
                    openDB().then(db => {
                        const tx = db.transaction(STORE_NAME, 'readonly');
                        const store = tx.objectStore(STORE_NAME);
                        store.getAll().onsuccess = function(ev) {
                            const items = ev.target.result;
                            const name = target.querySelector('strong').textContent;
                            const type = target.querySelector('span').textContent.replace(/[()]/g, '').trim();
                            const found = items.find(item =>
                                decrypt(item.name) === name && decrypt(item.type) === type
                            );
                            if (found) {
                                goToEditor(found.id);
                            }
                        };
                    });
                }
            };
            document.getElementById('GoBackMenuBtn').onclick = function() {
                location.hash = '';
                document.querySelector('.home-screen').style.display = 'block';
                editorScreen.style.display = 'none';
            };

            // On page load, show correct view
            window.onload = function() {
                renderProjects();
                handleHashChange();
            };
            addBtn.onclick = showModal;
            console.log('Hello World')
        </script>
</body>
</html>
